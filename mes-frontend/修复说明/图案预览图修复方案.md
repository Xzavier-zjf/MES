# 印刷图案预览图不显示问题修复方案

## 🔍 问题分析

### 当前问题
1. **图片URL配置错误**：前端使用 `http://localhost:7000` 但实际应该是 `http://localhost:8080`
2. **静态资源服务器未配置**：后端没有配置静态资源访问路径
3. **上传功能不完整**：缺少文件上传的后端实现

### 数据库现状
- 表名：`print_pattern`
- 图片字段：`image_url` (varchar(255))
- 现有数据示例：`/uploads/patterns/xxx.jpg`

## 🛠️ 解决方案

### 方案1：修复前端图片URL配置（推荐）

#### 1.1 修改前端图片显示逻辑
```javascript
// 修改 PatternManager.vue 中的图片显示
<el-image 
  :src="getImageUrl(row.imageUrl)" 
  fit="cover" 
  style="width: 60px; height: 60px"
  :preview-src-list="row.imageUrl ? [getImageUrl(row.imageUrl)] : []"
/>

// 添加图片URL处理方法
const getImageUrl = (imageUrl) => {
  if (!imageUrl) return ''
  
  // 如果是完整URL，直接返回
  if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
    return imageUrl
  }
  
  // 如果是相对路径，拼接正确的基础URL
  return `http://localhost:8080${imageUrl}`
}
```

#### 1.2 修改上传API配置
```javascript
// 修改 upload.js 中的getImageUrl方法
export const getImageUrl = (path) => {
  if (!path) return ''
  
  if (path.startsWith('http://') || path.startsWith('https://')) {
    return path
  }
  
  // 使用正确的端口
  const baseUrl = 'http://localhost:8080'
  return `${baseUrl}${path}`
}
```

### 方案2：配置后端静态资源服务

#### 2.1 创建上传控制器
```java
@RestController
@RequestMapping("/api/upload")
@CrossOrigin(origins = {"http://localhost:5173"})
public class UploadController {
    
    private static final String UPLOAD_DIR = "uploads/patterns/";
    
    @PostMapping("/image")
    public ResponseEntity<?> uploadImage(@RequestParam("file") MultipartFile file) {
        try {
            // 创建上传目录
            Path uploadPath = Paths.get(UPLOAD_DIR);
            if (!Files.exists(uploadPath)) {
                Files.createDirectories(uploadPath);
            }
            
            // 生成唯一文件名
            String originalFilename = file.getOriginalFilename();
            String extension = originalFilename.substring(originalFilename.lastIndexOf("."));
            String filename = UUID.randomUUID().toString() + "_" + originalFilename;
            
            // 保存文件
            Path filePath = uploadPath.resolve(filename);
            Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);
            
            // 返回文件路径
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("url", "/" + UPLOAD_DIR + filename);
            result.put("path", "/" + UPLOAD_DIR + filename);
            
            return ResponseEntity.ok(result);
        } catch (Exception e) {
            Map<String, Object> error = new HashMap<>();
            error.put("success", false);
            error.put("message", "文件上传失败: " + e.getMessage());
            return ResponseEntity.status(500).body(error);
        }
    }
}
```

#### 2.2 配置静态资源访问
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // 配置静态资源访问路径
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations("file:uploads/");
    }
}
```

### 方案3：数据库修复脚本

#### 3.1 检查现有图片数据
```sql
-- 检查现有图案数据
SELECT id, pattern_code, pattern_name, image_url 
FROM print_pattern 
WHERE image_url IS NOT NULL;

-- 检查图片文件是否存在（需要在服务器上执行）
```

#### 3.2 修复图片路径（如果需要）
```sql
-- 如果需要修复图片路径格式
UPDATE print_pattern 
SET image_url = CONCAT('/uploads/patterns/', SUBSTRING_INDEX(image_url, '/', -1))
WHERE image_url IS NOT NULL 
AND image_url NOT LIKE '/uploads/patterns/%';
```

## 🚀 实施步骤

### 步骤1：立即修复前端显示
1. 修改 `PatternManager.vue` 中的图片URL
2. 修改 `upload.js` 中的基础URL
3. 重启前端服务测试

### 步骤2：配置后端静态资源
1. 在网关或工艺服务中添加上传控制器
2. 配置静态资源访问路径
3. 重启后端服务

### 步骤3：测试完整功能
1. 测试现有图片显示
2. 测试新图片上传
3. 测试图片预览功能

## 📋 测试清单

- [ ] 现有图案的预览图正常显示
- [ ] 新上传图片功能正常
- [ ] 图片预览弹窗正常
- [ ] 编辑时图片正常加载
- [ ] 不同格式图片都能正常显示

## 🔧 故障排除

### 问题1：图片仍然不显示
- 检查网络请求是否返回404
- 确认后端静态资源配置
- 检查文件权限

### 问题2：上传失败
- 检查上传目录权限
- 确认文件大小限制
- 查看后端日志

### 问题3：跨域问题
- 确认CORS配置
- 检查请求头设置