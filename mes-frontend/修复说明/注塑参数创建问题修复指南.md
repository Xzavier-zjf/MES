# 注塑参数创建问题修复指南

## 问题描述
创建注塑工艺参数时出现 400 错误：
```
操作失败: 创建注塑参数失败
创建注塑工艺参数: Object:8080/api/v1/process/injection-params:1   
Failed to load resource: the server responded with a status of 400 ()
```

## 问题分析

### 1. 后端数据类型不匹配
**问题**：实体类 `InjectionParam` 的 `id` 字段类型与 DTO 不匹配
- 实体类：`String id` 
- DTO：`Integer id`

**修复**：已将实体类 ID 改为 `Integer` 类型

### 2. 前端数据格式问题
**问题**：前端发送的数据类型可能不符合后端期望
- 后端期望：`Float` 类型的工艺参数
- 前端可能发送：`Number` 或其他类型

**修复**：使用 `parseFloat()` 确保数据类型正确

### 3. 任务验证失败
**问题**：后端会验证 `taskId` 是否存在，如果任务不存在会抛出 400 错误

**修复**：确保选择的任务在系统中存在

## 修复步骤

### 步骤 1：后端修复
已修复实体类 ID 类型：
```java
@TableId(type = IdType.AUTO)
private Integer id;  // 改为 Integer 类型
```

### 步骤 2：前端数据格式修复
已优化数据发送格式：
```javascript
const paramData = {
  planId: form.value.planId ? String(form.value.planId) : null,
  taskId: form.value.taskId ? String(form.value.taskId) : null,
  deviceId: form.value.deviceId ? String(form.value.deviceId) : null,
  quantity: parseInt(form.value.quantity) || 0,
  pressure: parseFloat(form.value.pressure) || null,
  injectionSpeed: parseFloat(form.value.injectionSpeed) || null,
  // ... 其他字段使用 parseFloat
}
```

### 步骤 3：错误处理优化
已优化错误信息显示：
- 重复创建：提示选择其他任务
- 任务不存在：提示重新选择任务
- 参数错误：提示检查数据格式

## 测试方法

### 方法 1：使用调试工具
打开 `debug-injection-api.html` 进行测试：
1. 测试 API 连接
2. 填写测试数据
3. 点击"测试创建"

### 方法 2：使用简化测试
打开 `test-injection-simple.html` 进行测试：
1. 填写基本参数
2. 点击"测试创建"
3. 查看详细错误信息

### 方法 3：检查后端日志
查看后端控制台输出，寻找具体错误信息：
- 任务验证失败
- 数据类型转换错误
- 数据库约束错误

## 常见问题排查

### 1. 任务不存在
**症状**：错误信息包含"关联的任务不存在"
**解决**：
- 确保任务 ID 正确
- 检查任务是否已创建
- 验证任务类型是否为"注塑"

### 2. 重复创建
**症状**：错误信息包含"该任务已存在工艺参数"
**解决**：
- 选择其他任务
- 或编辑现有参数

### 3. 数据格式错误
**症状**：400 错误但无具体信息
**解决**：
- 检查所有数值字段是否为有效数字
- 确保必填字段不为空
- 验证数值范围是否合理

## 更新失败问题修复

### 问题描述
更新注塑参数时出现错误：
```
提交失败: Error: 更新注塑参数失败
```

### 问题原因
1. **API 调用方式不一致**：更新方法使用原生 `fetch` 而非配置好的 `request` 实例
2. **缺少认证头**：原生 `fetch` 没有包含 JWT token
3. **数据格式问题**：传递了不必要的 `id` 字段

### 修复方案
1. **统一使用 request 实例**：
```javascript
// 修复前（有问题）
const res = await fetch(`${BASE_URL}/${id}`, {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(paramData),
})

// 修复后（正确）
const response = await request.put(`${BASE_URL}/${id}`, cleanedData)
```

2. **移除不必要的 id 字段**：
```javascript
// 修复前
const updateDTO = { id: form.value.id, ...paramData }
await updateInjectionParamLocal(form.value.id, updateDTO)

// 修复后
await updateInjectionParamLocal(form.value.id, paramData)
```

## 验证修复结果

### 测试工具
1. **`test-injection-update.html`** - 专门测试更新功能
2. **`debug-injection-api.html`** - 完整的 API 调试工具
3. **`test-injection-simple.html`** - 简化的测试工具

### 测试步骤
1. **重启后端服务**（如果修改了实体类）
2. **清除浏览器缓存**
3. **使用更新测试工具验证**：
   - 获取现有参数列表
   - 选择要更新的参数
   - 修改参数值并测试更新
4. **在实际页面中测试**

## 预防措施

1. **API 调用统一**：所有 API 调用都使用配置好的 `request` 实例
2. **数据验证**：前端添加更严格的数据验证
3. **错误处理**：提供更详细的错误信息
4. **类型检查**：确保前后端数据类型一致
5. **测试覆盖**：为关键功能添加测试用例