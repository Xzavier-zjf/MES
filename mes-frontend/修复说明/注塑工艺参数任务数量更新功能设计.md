# 注塑工艺参数任务数量更新功能设计

## 需求分析

### 业务场景
在注塑工艺参数管理过程中，可能遇到以下情况需要更新任务数量：
1. **生产计划调整**：客户需求变更导致任务数量调整
2. **资源优化**：根据设备能力和时间安排调整任务数量
3. **质量要求**：根据工艺参数调整合理的生产数量
4. **紧急调整**：生产过程中的临时数量调整

### 功能价值
1. **提高效率**：在工艺参数页面直接调整数量，无需跳转到任务管理
2. **数据一致性**：确保工艺参数数量与任务数量保持同步
3. **操作便利**：工艺工程师可以根据工艺要求直接调整数量
4. **流程优化**：减少跨页面操作，提升用户体验

## 设计方案

### 方案一：编辑模式添加数量更新（推荐）

**实现思路**：
- 在编辑工艺参数时，显示当前任务数量
- 允许用户修改任务数量
- 同时更新工艺参数数量和任务数量

**优点**：
- 操作集中，用户体验好
- 数据一致性强
- 权限控制相对简单

**缺点**：
- 需要额外的权限验证
- 可能影响其他关联数据

### 方案二：独立的数量调整功能

**实现思路**：
- 在表格操作列添加"调整数量"按钮
- 弹出专门的数量调整对话框
- 同时更新任务和工艺参数数量

**优点**：
- 功能独立，不影响现有流程
- 可以添加更详细的验证和确认
- 便于权限控制

**缺点**：
- 增加了操作步骤
- 界面元素较多

### 方案三：批量数量调整

**实现思路**：
- 支持选择多个工艺参数
- 批量调整关联任务的数量
- 提供数量分配策略

**优点**：
- 支持批量操作
- 效率更高
- 适合大规模调整

**缺点**：
- 实现复杂度高
- 用户理解成本高

## 推荐实现方案

### 选择方案一：编辑模式添加数量更新

基于以下考虑：
1. **用户体验**：操作最为直观和便利
2. **实现成本**：相对较低，基于现有编辑功能扩展
3. **业务逻辑**：符合工艺参数与任务数量联动的业务需求

## 详细设计

### 1. UI 设计

#### 编辑对话框增强
```vue
<!-- 编辑模式下显示任务数量调整 -->
<div v-if="!isCreateMode" class="form-section">
  <h4 class="section-title">任务信息</h4>
  
  <!-- 只读信息 -->
  <el-form-item label="关联任务">
    <el-input :value="getTaskDisplayName()" readonly />
  </el-form-item>
  
  <!-- 数量调整 -->
  <el-form-item label="任务数量" prop="taskQuantity">
    <el-input-number 
      v-model="form.taskQuantity" 
      :min="1" 
      :max="50000"
      :disabled="!hasTaskUpdatePermission"
    />
    <div class="quantity-info">
      <span class="info-text">
        当前工艺参数数量: {{ form.quantity }}
        <el-button 
          type="text" 
          size="small" 
          @click="syncQuantityFromTask"
          v-if="form.taskQuantity !== form.quantity"
        >
          同步任务数量
        </el-button>
      </span>
    </div>
  </el-form-item>
  
  <!-- 数量更新选项 -->
  <el-form-item label="数量更新">
    <el-checkbox v-model="updateTaskQuantity">同时更新任务数量</el-checkbox>
    <div class="update-hint" v-if="updateTaskQuantity">
      <el-alert
        title="注意：更新任务数量可能影响其他关联的工艺参数"
        type="warning"
        :closable="false"
        show-icon
      />
    </div>
  </el-form-item>
</div>
```

### 2. 数据结构设计

#### 表单数据扩展
```javascript
const form = ref({
  // 现有字段
  id: null,
  planId: '',
  taskId: '',
  deviceId: '',
  quantity: 1,
  pressure: null,
  // ... 其他工艺参数
  
  // 新增字段
  taskQuantity: 1,        // 任务数量
  originalTaskQuantity: 1, // 原始任务数量
  updateTaskQuantity: false // 是否同时更新任务数量
})
```

### 3. API 设计

#### 任务数量更新 API
```javascript
// 更新任务数量
export const updateTaskQuantity = async (taskId, quantity) => {
  try {
    const response = await request.put(`/api/v1/production/tasks/${taskId}/quantity`, {
      quantity: quantity
    })
    return response
  } catch (error) {
    throw new Error('更新任务数量失败: ' + error.message)
  }
}

// 同时更新工艺参数和任务数量
export const updateInjectionParamWithTask = async (paramId, paramData, updateTask = false) => {
  try {
    const response = await request.put(`/api/v1/process/injection-params/${paramId}`, {
      ...paramData,
      updateTaskQuantity: updateTask
    })
    return response
  } catch (error) {
    throw new Error('更新工艺参数失败: ' + error.message)
  }
}
```

### 4. 业务逻辑实现

#### 编辑对话框打开逻辑
```javascript
const openDialog = async (task) => {
  isCreateMode.value = false
  form.value = { 
    ...task,
    taskQuantity: 0,
    originalTaskQuantity: 0,
    updateTaskQuantity: false
  }
  
  // 获取任务详细信息
  try {
    const taskDetails = taskDetailsMap.value[task.taskId]
    if (taskDetails) {
      form.value.taskQuantity = taskDetails.quantity
      form.value.originalTaskQuantity = taskDetails.quantity
    }
  } catch (error) {
    console.error('获取任务详情失败:', error)
  }
  
  dialogVisible.value = true
}
```

#### 提交逻辑增强
```javascript
const submitParams = async () => {
  // ... 现有验证逻辑
  
  try {
    if (isCreateMode.value) {
      // 新增逻辑保持不变
      const newParam = await createInjectionParam(paramData)
      // ...
    } else {
      // 编辑模式增强
      const needUpdateTask = form.value.updateTaskQuantity && 
                            form.value.taskQuantity !== form.value.originalTaskQuantity
      
      if (needUpdateTask) {
        // 确认更新任务数量
        const confirmResult = await ElMessageBox.confirm(
          `确定要将任务数量从 ${form.value.originalTaskQuantity} 更新为 ${form.value.taskQuantity} 吗？\n这可能影响其他关联的工艺参数。`,
          '确认更新任务数量',
          {
            confirmButtonText: '确认更新',
            cancelButtonText: '取消',
            type: 'warning'
          }
        )
        
        if (!confirmResult) return
        
        // 先更新任务数量
        await updateTaskQuantity(form.value.taskId, form.value.taskQuantity)
        
        // 更新本地任务数据
        if (taskDetailsMap.value[form.value.taskId]) {
          taskDetailsMap.value[form.value.taskId].quantity = form.value.taskQuantity
        }
      }
      
      // 更新工艺参数
      const updatedData = await updateInjectionParamLocal(form.value.id, paramData)
      
      // 更新本地数据
      const index = injectionParams.value.findIndex(t => t.id === form.value.id)
      if (index !== -1) {
        injectionParams.value[index] = { ...injectionParams.value[index], ...updatedData }
      }
      
      ElMessage.success(needUpdateTask ? '工艺参数和任务数量更新成功' : '工艺参数更新成功')
    }
    
    closeDialog()
    
  } catch (error) {
    console.error('提交失败:', error)
    ElMessage.error('操作失败: ' + (error.message || '未知错误'))
  } finally {
    submitLoading.value = false
  }
}
```

### 5. 权限控制

#### 权限验证
```javascript
// 检查任务更新权限
const hasTaskUpdatePermission = computed(() => {
  // 这里可以根据用户角色或权限进行判断
  return authStore.hasPermission('task:update') || authStore.hasRole('admin')
})

// 辅助方法
const getTaskDisplayName = () => {
  const taskDetails = taskDetailsMap.value[form.value.taskId]
  return taskDetails ? `${taskDetails.taskCode} - ${taskDetails.productName || ''}` : form.value.taskId
}

const syncQuantityFromTask = () => {
  form.value.quantity = form.value.taskQuantity
}
```

## 实现步骤

### 阶段一：基础功能实现 ✅
1. [x] 修改编辑对话框，添加任务数量字段
2. [x] 实现任务数量更新 API
3. [x] 添加数量同步逻辑
4. [x] 基础权限控制

### 阶段二：用户体验优化 ✅
1. [x] 添加数量变更确认机制
2. [x] 优化错误处理和提示
3. [ ] 添加操作日志记录
4. [x] 完善权限控制

### 阶段三：高级功能 📋
1. [ ] 批量数量调整
2. [ ] 数量变更历史追踪
3. [ ] 关联数据影响分析
4. [ ] 数量分配策略

## 已实现功能

### ✅ 核心功能
- **编辑对话框增强**：在编辑模式下显示任务信息和数量调整选项
- **任务数量更新**：支持在工艺参数页面直接更新关联任务的数量
- **数量同步**：提供一键同步任务数量到工艺参数数量的功能
- **确认机制**：更新任务数量前显示确认对话框，提醒用户影响范围

### ✅ 用户体验
- **权限控制**：根据用户权限控制是否可以修改任务数量
- **视觉反馈**：通过警告提示告知用户操作的影响
- **错误处理**：完善的错误处理和用户友好的错误提示
- **操作引导**：清晰的界面布局和操作提示

### 🧪 测试工具
- **功能测试页面**：`test-task-quantity-update.html`
- **工作流程模拟**：完整的功能演示和测试场景

## 风险评估

### 技术风险
1. **数据一致性**：需要确保任务数量和工艺参数数量的一致性
2. **并发控制**：多用户同时修改可能导致数据冲突
3. **事务处理**：需要保证任务和工艺参数更新的原子性

### 业务风险
1. **权限管理**：需要严格控制谁可以修改任务数量
2. **影响范围**：任务数量变更可能影响其他工艺参数
3. **审计追踪**：需要记录数量变更的历史

### 缓解措施
1. **数据库事务**：使用事务确保数据一致性
2. **乐观锁**：防止并发修改冲突
3. **权限验证**：多层权限验证
4. **操作日志**：详细记录所有变更操作

## 总结

添加任务数量更新功能可以显著提升用户体验和操作效率，但需要谨慎处理数据一致性和权限控制问题。建议采用渐进式实现，先完成基础功能，再逐步添加高级特性。