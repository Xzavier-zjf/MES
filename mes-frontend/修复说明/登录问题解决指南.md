# MES系统登录问题解决指南

## 🔍 问题诊断

### 当前状态
- ✅ 网关服务正常运行 (8080)
- ✅ 认证服务正常运行 (8101)
- ✅ 前端服务正常运行 (5173)
- ✅ 网关路由配置已修复
- ❌ 登录返回HTTP 423错误（账户被锁定）

### 错误分析
HTTP 423错误表示账户被锁定，可能的原因：
1. **数据库中没有默认用户**
2. **admin用户被锁定**（多次登录失败）
3. **密码验证逻辑问题**

## 🛠️ 解决方案

### 方案1：数据库用户初始化（推荐）

1. **打开Navicat**，连接到MES数据库

2. **执行用户创建脚本**：
   ```sql
   -- 运行 "创建默认用户.sql" 文件
   ```

3. **验证用户创建**：
   ```sql
   SELECT id, username, status, account_locked, login_attempts 
   FROM user 
   WHERE username IN ('admin', 'testuser');
   ```

### 方案2：手动解锁用户

如果用户存在但被锁定：

```sql
-- 解锁admin用户
UPDATE user 
SET account_locked = FALSE, 
    login_attempts = 0 
WHERE username = 'admin';

-- 验证解锁结果
SELECT username, account_locked, login_attempts 
FROM user 
WHERE username = 'admin';
```

### 方案3：通过前端创建用户

1. **访问用户测试页面**：
   ```
   http://localhost:5173/test-user-status.html
   ```

2. **创建新用户**：
   - 用户名：testuser
   - 密码：Test123456（至少8位，包含字母和数字）
   - 邮箱：test@example.com

3. **测试登录**：
   - 使用新创建的用户登录

## 📋 测试步骤

### 1. 数据库检查
```sql
-- 检查用户表结构
DESCRIBE user;

-- 检查现有用户
SELECT * FROM user;

-- 检查存储过程
SHOW PROCEDURE STATUS WHERE Db = 'MES' AND Name = 'ValidateUserPassword';
```

### 2. 用户创建测试
```sql
-- 测试用户创建存储过程
CALL CreateUser('testuser2', 'Test123456', 'test2@example.com', '13800138002', 'user', @result, @message);
SELECT @result, @message;
```

### 3. 登录测试
```sql
-- 测试密码验证
CALL ValidateUserPassword('admin', '123456', @result, @user_id, @message);
SELECT @result, @user_id, @message;
```

## 🚀 快速修复

### 一键修复脚本
```bash
# 1. 启动系统
双击运行: mes-frontend/start-mes-system.bat

# 2. 数据库修复
在Navicat中执行: 创建默认用户.sql

# 3. 测试登录
访问: http://localhost:5173/test-user-status.html
```

### 默认账户信息
修复后可用的账户：

| 用户名 | 密码 | 角色 | 状态 |
|--------|------|------|------|
| admin | 123456 | admin | 活跃 |
| testuser | Test123456 | user | 活跃 |

## 🔧 常见问题

### Q1: 仍然返回423错误
**解决方案**：
1. 检查数据库连接是否正常
2. 确认存储过程是否存在
3. 查看认证服务日志

### Q2: 密码强度不足错误
**解决方案**：
- 密码必须至少8位
- 必须包含字母和数字
- 推荐格式：Test123456

### Q3: 用户创建失败
**解决方案**：
1. 检查数据库表结构
2. 确认CreateUser存储过程存在
3. 检查用户名是否已存在

## 📝 验证清单

- [ ] 数据库连接正常
- [ ] user表存在且结构正确
- [ ] ValidateUserPassword存储过程存在
- [ ] CreateUser存储过程存在
- [ ] admin用户存在且未被锁定
- [ ] 测试用户可以正常创建
- [ ] 登录功能正常工作

## 🎯 预期结果

修复完成后：
- ✅ 可以使用admin/123456登录
- ✅ 可以创建新用户
- ✅ 登录不再返回423错误
- ✅ 系统功能正常使用

---

**注意**：如果问题仍然存在，请检查数据库连接配置和认证服务日志。