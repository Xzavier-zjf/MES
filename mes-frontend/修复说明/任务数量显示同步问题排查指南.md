# 任务数量显示同步问题排查指南

## 问题描述
在录入工艺中更新任务数量后，注塑工艺参数页面的任务数量显示仍然是原来的数量。

## 问题分析

### 可能的原因
1. **前端缓存问题**：Vue 响应式系统没有检测到数据变化
2. **数据更新时机**：`taskDetailsMap` 更新了但页面没有重新渲染
3. **API 调用问题**：后端数据更新失败或延迟
4. **数据结构问题**：数据引用没有正确更新

### 数据流程分析
```
用户更新任务数量 
    ↓
调用 updateTaskQuantity API
    ↓
更新 taskDetailsMap.value[taskId].quantity
    ↓
重新加载 loadTaskDetailsMap()
    ↓
触发 nextTick() 强制更新
    ↓
表格调用 getTaskQuantityDisplay() 显示新数量
```

## 已实施的修复方案

### 1. 响应式数据更新
```javascript
// 修复前：直接修改属性
taskDetailsMap.value[form.value.taskId].quantity = form.value.taskQuantity

// 修复后：创建新对象触发响应式更新
taskDetailsMap.value = {
  ...taskDetailsMap.value,
  [form.value.taskId]: {
    ...taskDetailsMap.value[form.value.taskId],
    quantity: form.value.taskQuantity
  }
}
```

### 2. 强制数据刷新
```javascript
// 重新加载任务详细信息
await loadTaskDetailsMap()

// 强制触发响应式更新
await nextTick()

// 验证数据同步
const isSynced = verifyDataSync(taskId, expectedQuantity)
```

### 3. 数据同步验证
```javascript
const verifyDataSync = (taskId, expectedQuantity) => {
  const taskDetails = taskDetailsMap.value[taskId]
  const actualQuantity = taskDetails?.quantity
  return actualQuantity === expectedQuantity
}
```

### 4. 自动刷新机制
```javascript
// 如果更新了任务数量，刷新注塑参数列表
if (needUpdateTask) {
  await fetchInjectionParams()
}
```

## 调试工具

### 1. 浏览器控制台调试
打开浏览器开发者工具，查看控制台输出：
- 任务数量更新日志
- 数据同步验证结果
- `getTaskQuantityDisplay` 调用信息

### 2. 数据同步检查工具
使用 `debug-data-sync.html` 工具：
- 获取任务数据和注塑参数数据
- 对比数据一致性
- 测试更新和同步流程

### 3. 手动刷新功能
页面添加了"刷新数据"按钮，可以手动触发数据刷新。

## 排查步骤

### 步骤 1：检查后端数据
1. 打开 `debug-data-sync.html`
2. 点击"获取任务列表"
3. 确认任务数量是否已在后端更新

### 步骤 2：检查前端缓存
1. 在浏览器控制台查看 `taskDetailsMap` 的值
2. 确认对应任务的数量是否已更新
3. 检查是否有 Vue 响应式更新日志

### 步骤 3：验证数据同步
1. 使用数据同步检查工具对比数据
2. 查看是否有数量不匹配的问题
3. 检查数据更新的时间戳

### 步骤 4：强制刷新测试
1. 点击页面上的"刷新数据"按钮
2. 观察数量显示是否更新
3. 如果刷新后正常，说明是缓存问题

## 常见问题和解决方案

### 问题 1：数据更新但页面不刷新
**原因**：Vue 响应式系统没有检测到深层对象的变化
**解决**：使用对象展开语法创建新对象

### 问题 2：API 调用成功但数据不同步
**原因**：前端缓存没有及时更新
**解决**：调用 `loadTaskDetailsMap()` 重新获取数据

### 问题 3：页面显示延迟更新
**原因**：Vue 的异步更新机制
**解决**：使用 `nextTick()` 等待 DOM 更新

### 问题 4：多个工艺参数关联同一任务
**原因**：任务数量更新影响多个工艺参数
**解决**：更新后刷新整个注塑参数列表

## 预防措施

### 1. 数据一致性检查
定期验证任务数量与工艺参数数量的一致性

### 2. 自动刷新机制
在关键操作后自动刷新相关数据

### 3. 用户反馈
提供明确的操作成功/失败反馈

### 4. 错误处理
完善的错误处理和重试机制

## 测试验证

### 测试场景 1：单个任务数量更新
1. 选择一个工艺参数进行编辑
2. 修改任务数量并勾选"同时更新任务数量"
3. 提交更新
4. 验证表格中的数量显示是否正确

### 测试场景 2：多个工艺参数关联同一任务
1. 创建多个工艺参数关联同一任务
2. 更新其中一个的任务数量
3. 验证其他工艺参数的数量显示是否同步更新

### 测试场景 3：网络异常情况
1. 模拟网络延迟或失败
2. 验证错误处理是否正确
3. 验证数据一致性是否保持

## 监控和日志

### 控制台日志
- 任务数量更新操作日志
- 数据同步验证结果
- API 调用成功/失败日志

### 用户反馈
- 操作成功/失败消息
- 数据刷新状态提示
- 错误信息和建议操作

通过以上排查步骤和修复方案，应该能够解决任务数量显示同步的问题。如果问题仍然存在，建议使用调试工具进行详细分析。