<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æ ¼é¢„è§ˆå›¾ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .title {
            color: #409eff;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .comparison-before {
            border-color: #f56c6c;
            background: #fef0f0;
        }
        .comparison-after {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        .mock-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .mock-table th,
        .mock-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .mock-table th {
            background: #f5f7fa;
            font-weight: bold;
        }
        .preview-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-slot {
            width: 60px;
            height: 60px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            font-size: 10px;
            color: #999;
        }
        .stats-display {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #409eff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #337ecc;
        }
        button.success {
            background: #67c23a;
        }
        .log {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #67c23a; }
        .error { color: #f56c6c; }
        .info { color: #409eff; }
        .warning { color: #e6a23c; }
    </style>
</head>
<body>
    <h1>ğŸ”§ è¡¨æ ¼é¢„è§ˆå›¾ä¿®å¤æµ‹è¯•</h1>
    
    <div class="container">
        <h2 class="title">é—®é¢˜è¯´æ˜</h2>
        <p><strong>é—®é¢˜ï¼š</strong>ä¿å­˜åé¡µé¢è¡¨æ ¼ä¸­çš„é¢„è§ˆå›¾æ²¡æœ‰æ˜¾ç¤ºï¼Œå› ä¸ºè¡¨æ ¼ä½¿ç”¨çš„æ˜¯ getImageUrl() è€Œä¸æ˜¯ getSmartImageUrl()ã€‚</p>
        <p><strong>ä¿®å¤ï¼š</strong>å°†è¡¨æ ¼é¢„è§ˆå›¾çš„URLç”Ÿæˆæ”¹ä¸ºä½¿ç”¨æ™ºèƒ½åˆ‡æ¢é€»è¾‘ã€‚</p>
    </div>

    <div class="container">
        <h2 class="title">ä¿®å¤å‰åå¯¹æ¯”</h2>
        
        <div class="comparison-section">
            <div class="comparison-item comparison-before">
                <h4>ä¿®å¤å‰</h4>
                <p>ä½¿ç”¨ getImageUrl(row.imageUrl)</p>
                <table class="mock-table">
                    <thead>
                        <tr>
                            <th>å›¾æ¡ˆåç§°</th>
                            <th>é¢„è§ˆå›¾</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æµ‹è¯•å›¾æ¡ˆ1</td>
                            <td>
                                <div class="image-slot">
                                    <div>ğŸ“·</div>
                                    <div>æš‚æ— å›¾ç‰‡</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="comparison-item comparison-after">
                <h4>ä¿®å¤å</h4>
                <p>ä½¿ç”¨ getSmartImageUrl(row.imageUrl)</p>
                <table class="mock-table">
                    <thead>
                        <tr>
                            <th>å›¾æ¡ˆåç§°</th>
                            <th>é¢„è§ˆå›¾</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æµ‹è¯•å›¾æ¡ˆ1</td>
                            <td>
                                <img id="smartPreview" class="preview-image" alt="æ™ºèƒ½åˆ‡æ¢é¢„è§ˆ">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="title">ç»Ÿè®¡é€»è¾‘æµ‹è¯•</h2>
        <p>æµ‹è¯•å·²é…ç½®å›¾æ¡ˆã€å¾…é…ç½®å›¾æ¡ˆã€å¼‚å¸¸å›¾æ¡ˆçš„ç»Ÿè®¡é€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚</p>
        
        <button onclick="testStatistics()" class="success">æµ‹è¯•ç»Ÿè®¡é€»è¾‘</button>
        <button onclick="testTablePreview()">æµ‹è¯•è¡¨æ ¼é¢„è§ˆ</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        
        <div class="stats-display">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">å›¾æ¡ˆæ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="configuredCount">0</div>
                <div class="stat-label">å·²é…ç½®å›¾æ¡ˆ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">å¾…é…ç½®å›¾æ¡ˆ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">å¼‚å¸¸å›¾æ¡ˆ</div>
            </div>
        </div>
        
        <div id="testLog" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¨¡æ‹ŸgetImageUrlå‡½æ•°
        function getImageUrl(path) {
            if (!path) return '';
            const baseUrl = 'http://localhost:8080';
            const pathParts = path.split('/');
            const encodedParts = pathParts.map((part, index) => {
                if (index === pathParts.length - 1 && part) {
                    return encodeURIComponent(part);
                }
                return part;
            });
            const encodedPath = encodedParts.join('/');
            return `${baseUrl}/api${encodedPath}`;
        }

        // æ™ºèƒ½åˆ‡æ¢å‡½æ•°
        function getSmartImageUrl(path) {
            if (!path) return '';
            
            if (path.endsWith('.jpg') || path.endsWith('.png')) {
                const svgPath = path.replace(/\.(jpg|png)$/i, '.svg');
                return getImageUrl(svgPath);
            }
            
            return getImageUrl(path);
        }

        // éªŒè¯å›¾ç‰‡URLæ ¼å¼
        function isValidImageUrl(url) {
            if (!url) return false;
            
            const isValidFormat = url.startsWith('http') || url.startsWith('/') || url.startsWith('data:image');
            if (!isValidFormat) return false;
            
            if (url.endsWith('.jpg') || url.endsWith('.png')) {
                return true; // å‡è®¾å¯¹åº”çš„SVGç‰ˆæœ¬å­˜åœ¨
            }
            
            return true;
        }

        // æ¨¡æ‹Ÿå›¾æ¡ˆæ•°æ®
        const mockPatterns = [
            {
                id: 1,
                patternCode: 'PATTERN-001',
                patternName: 'æµ‹è¯•å›¾æ¡ˆ1',
                machineModel: 'A',
                defaultPrintSpeed: 100,
                defaultPressure: 50,
                imageUrl: '/uploads/patterns/test-pattern-1.jpg'
            },
            {
                id: 2,
                patternCode: 'PATTERN-002',
                patternName: 'æµ‹è¯•å›¾æ¡ˆ2',
                machineModel: 'B',
                defaultPrintSpeed: 120,
                defaultPressure: 60,
                imageUrl: '/uploads/patterns/test-pattern-2.png'
            },
            {
                id: 3,
                patternCode: '',
                patternName: 'æœªå®Œæˆå›¾æ¡ˆ',
                machineModel: '',
                defaultPrintSpeed: 0,
                defaultPressure: 0,
                imageUrl: ''
            },
            {
                id: 4,
                patternCode: 'PATTERN-004',
                patternName: 'å¼‚å¸¸å›¾æ¡ˆ',
                machineModel: 'A',
                defaultPrintSpeed: -10, // å¼‚å¸¸å€¼
                defaultPressure: 40,
                imageUrl: '/uploads/patterns/error-pattern.jpg'
            }
        ];

        function testStatistics() {
            log('å¼€å§‹æµ‹è¯•ç»Ÿè®¡é€»è¾‘...', 'info');
            
            const totalPatterns = mockPatterns.length;
            
            const configuredPatterns = mockPatterns.filter(p => 
                p.patternCode && p.patternName && p.machineModel && 
                p.defaultPrintSpeed && p.defaultPressure && p.imageUrl
            ).length;
            
            const pendingPatterns = mockPatterns.filter(p => 
                !p.patternCode || !p.patternName || !p.machineModel || 
                !p.defaultPrintSpeed || !p.defaultPressure || !p.imageUrl
            ).length;
            
            const errorPatterns = mockPatterns.filter(p => 
                (p.defaultPrintSpeed && p.defaultPrintSpeed < 0) || 
                (p.defaultPressure && p.defaultPressure < 0) ||
                (p.imageUrl && !isValidImageUrl(p.imageUrl))
            ).length;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalCount').textContent = totalPatterns;
            document.getElementById('configuredCount').textContent = configuredPatterns;
            document.getElementById('pendingCount').textContent = pendingPatterns;
            document.getElementById('errorCount').textContent = errorPatterns;
            
            // è®°å½•æ—¥å¿—
            log(`å›¾æ¡ˆæ€»æ•°: ${totalPatterns}`, 'info');
            log(`å·²é…ç½®å›¾æ¡ˆ: ${configuredPatterns}`, 'success');
            log(`å¾…é…ç½®å›¾æ¡ˆ: ${pendingPatterns}`, 'warning');
            log(`å¼‚å¸¸å›¾æ¡ˆ: ${errorPatterns}`, 'error');
            
            // è¯¦ç»†åˆ†æ
            mockPatterns.forEach((pattern, index) => {
                const isConfigured = pattern.patternCode && pattern.patternName && 
                                   pattern.machineModel && pattern.defaultPrintSpeed && 
                                   pattern.defaultPressure && pattern.imageUrl;
                const isPending = !isConfigured;
                const hasError = (pattern.defaultPrintSpeed && pattern.defaultPrintSpeed < 0) || 
                               (pattern.defaultPressure && pattern.defaultPressure < 0) ||
                               (pattern.imageUrl && !isValidImageUrl(pattern.imageUrl));
                
                let status = '';
                if (hasError) status = 'å¼‚å¸¸';
                else if (isConfigured) status = 'å·²é…ç½®';
                else status = 'å¾…é…ç½®';
                
                log(`å›¾æ¡ˆ${index + 1} (${pattern.patternName}): ${status}`, 
                    hasError ? 'error' : isConfigured ? 'success' : 'warning');
            });
            
            log('ç»Ÿè®¡é€»è¾‘æµ‹è¯•å®Œæˆ', 'success');
        }

        async function testTablePreview() {
            log('å¼€å§‹æµ‹è¯•è¡¨æ ¼é¢„è§ˆå›¾...', 'info');
            
            const testPattern = mockPatterns[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªå›¾æ¡ˆ
            const originalUrl = getImageUrl(testPattern.imageUrl);
            const smartUrl = getSmartImageUrl(testPattern.imageUrl);
            
            log(`åŸå§‹URL: ${originalUrl}`, 'info');
            log(`æ™ºèƒ½åˆ‡æ¢URL: ${smartUrl}`, 'info');
            
            // æµ‹è¯•æ™ºèƒ½åˆ‡æ¢çš„URL
            const smartPreview = document.getElementById('smartPreview');
            smartPreview.src = smartUrl;
            
            smartPreview.onload = () => {
                log('âœ… æ™ºèƒ½åˆ‡æ¢é¢„è§ˆå›¾åŠ è½½æˆåŠŸ', 'success');
            };
            
            smartPreview.onerror = () => {
                log('âŒ æ™ºèƒ½åˆ‡æ¢é¢„è§ˆå›¾åŠ è½½å¤±è´¥', 'error');
            };
            
            // æµ‹è¯•URLå¯è®¿é—®æ€§
            try {
                const response = await fetch(smartUrl, { method: 'HEAD' });
                if (response.ok) {
                    log(`âœ… æ™ºèƒ½åˆ‡æ¢URLå¯è®¿é—® (${response.status})`, 'success');
                } else {
                    log(`âŒ æ™ºèƒ½åˆ‡æ¢URLä¸å¯è®¿é—® (${response.status})`, 'error');
                }
            } catch (error) {
                log(`âŒ æ™ºèƒ½åˆ‡æ¢URLæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            log('è¡¨æ ¼é¢„è§ˆå›¾æµ‹è¯•å®Œæˆ', 'info');
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ è¡¨æ ¼é¢„è§ˆå›¾ä¿®å¤æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            log('ä¿®å¤å†…å®¹ï¼šè¡¨æ ¼é¢„è§ˆå›¾ç°åœ¨ä½¿ç”¨æ™ºèƒ½åˆ‡æ¢é€»è¾‘', 'info');
            
            // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
            setTimeout(() => {
                log('è‡ªåŠ¨å¼€å§‹ç»Ÿè®¡é€»è¾‘æµ‹è¯•...', 'info');
                testStatistics();
                
                setTimeout(() => {
                    log('è‡ªåŠ¨å¼€å§‹è¡¨æ ¼é¢„è§ˆæµ‹è¯•...', 'info');
                    testTablePreview();
                }, 2000);
            }, 1000);
        });
    </script>
</body>
</html>