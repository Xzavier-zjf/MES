<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表格预览图修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .title {
            color: #409eff;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .comparison-before {
            border-color: #f56c6c;
            background: #fef0f0;
        }
        .comparison-after {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        .mock-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .mock-table th,
        .mock-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .mock-table th {
            background: #f5f7fa;
            font-weight: bold;
        }
        .preview-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-slot {
            width: 60px;
            height: 60px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            font-size: 10px;
            color: #999;
        }
        .stats-display {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #409eff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #337ecc;
        }
        button.success {
            background: #67c23a;
        }
        .log {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #67c23a; }
        .error { color: #f56c6c; }
        .info { color: #409eff; }
        .warning { color: #e6a23c; }
    </style>
</head>
<body>
    <h1>🔧 表格预览图修复测试</h1>
    
    <div class="container">
        <h2 class="title">问题说明</h2>
        <p><strong>问题：</strong>保存后页面表格中的预览图没有显示，因为表格使用的是 getImageUrl() 而不是 getSmartImageUrl()。</p>
        <p><strong>修复：</strong>将表格预览图的URL生成改为使用智能切换逻辑。</p>
    </div>

    <div class="container">
        <h2 class="title">修复前后对比</h2>
        
        <div class="comparison-section">
            <div class="comparison-item comparison-before">
                <h4>修复前</h4>
                <p>使用 getImageUrl(row.imageUrl)</p>
                <table class="mock-table">
                    <thead>
                        <tr>
                            <th>图案名称</th>
                            <th>预览图</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>测试图案1</td>
                            <td>
                                <div class="image-slot">
                                    <div>📷</div>
                                    <div>暂无图片</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="comparison-item comparison-after">
                <h4>修复后</h4>
                <p>使用 getSmartImageUrl(row.imageUrl)</p>
                <table class="mock-table">
                    <thead>
                        <tr>
                            <th>图案名称</th>
                            <th>预览图</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>测试图案1</td>
                            <td>
                                <img id="smartPreview" class="preview-image" alt="智能切换预览">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="title">统计逻辑测试</h2>
        <p>测试已配置图案、待配置图案、异常图案的统计逻辑是否正确。</p>
        
        <button onclick="testStatistics()" class="success">测试统计逻辑</button>
        <button onclick="testTablePreview()">测试表格预览</button>
        <button onclick="clearLog()">清除日志</button>
        
        <div class="stats-display">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">图案总数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="configuredCount">0</div>
                <div class="stat-label">已配置图案</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">待配置图案</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">异常图案</div>
            </div>
        </div>
        
        <div id="testLog" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 模拟getImageUrl函数
        function getImageUrl(path) {
            if (!path) return '';
            const baseUrl = 'http://localhost:8080';
            const pathParts = path.split('/');
            const encodedParts = pathParts.map((part, index) => {
                if (index === pathParts.length - 1 && part) {
                    return encodeURIComponent(part);
                }
                return part;
            });
            const encodedPath = encodedParts.join('/');
            return `${baseUrl}/api${encodedPath}`;
        }

        // 智能切换函数
        function getSmartImageUrl(path) {
            if (!path) return '';
            
            if (path.endsWith('.jpg') || path.endsWith('.png')) {
                const svgPath = path.replace(/\.(jpg|png)$/i, '.svg');
                return getImageUrl(svgPath);
            }
            
            return getImageUrl(path);
        }

        // 验证图片URL格式
        function isValidImageUrl(url) {
            if (!url) return false;
            
            const isValidFormat = url.startsWith('http') || url.startsWith('/') || url.startsWith('data:image');
            if (!isValidFormat) return false;
            
            if (url.endsWith('.jpg') || url.endsWith('.png')) {
                return true; // 假设对应的SVG版本存在
            }
            
            return true;
        }

        // 模拟图案数据
        const mockPatterns = [
            {
                id: 1,
                patternCode: 'PATTERN-001',
                patternName: '测试图案1',
                machineModel: 'A',
                defaultPrintSpeed: 100,
                defaultPressure: 50,
                imageUrl: '/uploads/patterns/test-pattern-1.jpg'
            },
            {
                id: 2,
                patternCode: 'PATTERN-002',
                patternName: '测试图案2',
                machineModel: 'B',
                defaultPrintSpeed: 120,
                defaultPressure: 60,
                imageUrl: '/uploads/patterns/test-pattern-2.png'
            },
            {
                id: 3,
                patternCode: '',
                patternName: '未完成图案',
                machineModel: '',
                defaultPrintSpeed: 0,
                defaultPressure: 0,
                imageUrl: ''
            },
            {
                id: 4,
                patternCode: 'PATTERN-004',
                patternName: '异常图案',
                machineModel: 'A',
                defaultPrintSpeed: -10, // 异常值
                defaultPressure: 40,
                imageUrl: '/uploads/patterns/error-pattern.jpg'
            }
        ];

        function testStatistics() {
            log('开始测试统计逻辑...', 'info');
            
            const totalPatterns = mockPatterns.length;
            
            const configuredPatterns = mockPatterns.filter(p => 
                p.patternCode && p.patternName && p.machineModel && 
                p.defaultPrintSpeed && p.defaultPressure && p.imageUrl
            ).length;
            
            const pendingPatterns = mockPatterns.filter(p => 
                !p.patternCode || !p.patternName || !p.machineModel || 
                !p.defaultPrintSpeed || !p.defaultPressure || !p.imageUrl
            ).length;
            
            const errorPatterns = mockPatterns.filter(p => 
                (p.defaultPrintSpeed && p.defaultPrintSpeed < 0) || 
                (p.defaultPressure && p.defaultPressure < 0) ||
                (p.imageUrl && !isValidImageUrl(p.imageUrl))
            ).length;
            
            // 更新显示
            document.getElementById('totalCount').textContent = totalPatterns;
            document.getElementById('configuredCount').textContent = configuredPatterns;
            document.getElementById('pendingCount').textContent = pendingPatterns;
            document.getElementById('errorCount').textContent = errorPatterns;
            
            // 记录日志
            log(`图案总数: ${totalPatterns}`, 'info');
            log(`已配置图案: ${configuredPatterns}`, 'success');
            log(`待配置图案: ${pendingPatterns}`, 'warning');
            log(`异常图案: ${errorPatterns}`, 'error');
            
            // 详细分析
            mockPatterns.forEach((pattern, index) => {
                const isConfigured = pattern.patternCode && pattern.patternName && 
                                   pattern.machineModel && pattern.defaultPrintSpeed && 
                                   pattern.defaultPressure && pattern.imageUrl;
                const isPending = !isConfigured;
                const hasError = (pattern.defaultPrintSpeed && pattern.defaultPrintSpeed < 0) || 
                               (pattern.defaultPressure && pattern.defaultPressure < 0) ||
                               (pattern.imageUrl && !isValidImageUrl(pattern.imageUrl));
                
                let status = '';
                if (hasError) status = '异常';
                else if (isConfigured) status = '已配置';
                else status = '待配置';
                
                log(`图案${index + 1} (${pattern.patternName}): ${status}`, 
                    hasError ? 'error' : isConfigured ? 'success' : 'warning');
            });
            
            log('统计逻辑测试完成', 'success');
        }

        async function testTablePreview() {
            log('开始测试表格预览图...', 'info');
            
            const testPattern = mockPatterns[0]; // 使用第一个图案
            const originalUrl = getImageUrl(testPattern.imageUrl);
            const smartUrl = getSmartImageUrl(testPattern.imageUrl);
            
            log(`原始URL: ${originalUrl}`, 'info');
            log(`智能切换URL: ${smartUrl}`, 'info');
            
            // 测试智能切换的URL
            const smartPreview = document.getElementById('smartPreview');
            smartPreview.src = smartUrl;
            
            smartPreview.onload = () => {
                log('✅ 智能切换预览图加载成功', 'success');
            };
            
            smartPreview.onerror = () => {
                log('❌ 智能切换预览图加载失败', 'error');
            };
            
            // 测试URL可访问性
            try {
                const response = await fetch(smartUrl, { method: 'HEAD' });
                if (response.ok) {
                    log(`✅ 智能切换URL可访问 (${response.status})`, 'success');
                } else {
                    log(`❌ 智能切换URL不可访问 (${response.status})`, 'error');
                }
            } catch (error) {
                log(`❌ 智能切换URL测试失败: ${error.message}`, 'error');
            }
            
            log('表格预览图测试完成', 'info');
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // 页面加载完成后自动测试
        document.addEventListener('DOMContentLoaded', function() {
            log('🔧 表格预览图修复测试工具已加载', 'success');
            log('修复内容：表格预览图现在使用智能切换逻辑', 'info');
            
            // 自动运行测试
            setTimeout(() => {
                log('自动开始统计逻辑测试...', 'info');
                testStatistics();
                
                setTimeout(() => {
                    log('自动开始表格预览测试...', 'info');
                    testTablePreview();
                }, 2000);
            }, 1000);
        });
    </script>
</body>
</html>