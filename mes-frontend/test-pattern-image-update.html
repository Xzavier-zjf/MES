<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾æ¡ˆå›¾ç‰‡æ›´æ¢åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-title {
            color: #409eff;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #337ecc;
        }
        button.danger {
            background: #f56c6c;
        }
        button.danger:hover {
            background: #dd6161;
        }
        .preview-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            background: #fafafa;
        }
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .error {
            color: #f56c6c;
            font-size: 12px;
            margin-top: 5px;
        }
        .success {
            color: #67c23a;
            font-size: 12px;
            margin-top: 5px;
        }
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            color: #0050b3;
        }
        .test-results {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        .upload-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .upload-type-selector label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }
        .upload-type-selector input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¨ å°åˆ·å›¾æ¡ˆç®¡ç† - å›¾ç‰‡æ›´æ¢åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="info">
        <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯åœ¨ç¼–è¾‘å›¾æ¡ˆæ—¶ï¼Œé‡æ–°é€‰æ‹©å›¾ç‰‡URLä½œä¸ºæ›´æ¢å›¾æ¡ˆçš„æ–¹å¼ï¼Œå¡«å…¥æ­£ç¡®çš„å›¾ç‰‡URLåï¼Œé¡µé¢æ˜¯å¦æ­£ç¡®æ›´æ¢å›¾æ¡ˆã€‚
    </div>

    <!-- æµ‹è¯•ç”¨å›¾æ¡ˆæ•°æ® -->
    <div class="test-container">
        <h2 class="test-title">1. æ¨¡æ‹Ÿç°æœ‰å›¾æ¡ˆæ•°æ®</h2>
        <div class="form-group">
            <label>å›¾æ¡ˆç¼–å·ï¼š</label>
            <input type="text" id="patternCode" value="PATTERN-001" readonly>
        </div>
        <div class="form-group">
            <label>å›¾æ¡ˆåç§°ï¼š</label>
            <input type="text" id="patternName" value="æµ‹è¯•å›¾æ¡ˆ" readonly>
        </div>
        <div class="form-group">
            <label>å½“å‰å›¾ç‰‡URLï¼š</label>
            <input type="text" id="currentImageUrl" value="https://picsum.photos/200/200?random=1" readonly>
        </div>
        <div class="form-group">
            <label>å½“å‰å›¾ç‰‡é¢„è§ˆï¼š</label>
            <div class="preview-container">
                <img id="currentPreview" class="preview-image" src="https://picsum.photos/200/200?random=1" alt="å½“å‰å›¾æ¡ˆ">
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ›´æ¢æµ‹è¯• -->
    <div class="test-container">
        <h2 class="test-title">2. å›¾ç‰‡æ›´æ¢åŠŸèƒ½æµ‹è¯•</h2>
        
        <div class="upload-type-selector">
            <label>
                <input type="radio" name="uploadType" value="url" checked>
                å›¾ç‰‡URL
            </label>
            <label>
                <input type="radio" name="uploadType" value="path">
                æ–‡ä»¶è·¯å¾„
            </label>
            <label>
                <input type="radio" name="uploadType" value="file">
                æ–‡ä»¶ä¸Šä¼ 
            </label>
        </div>

        <!-- URLè¾“å…¥æ–¹å¼ -->
        <div id="urlSection" class="form-group">
            <label>æ–°å›¾ç‰‡URLï¼š</label>
            <input type="text" id="newImageUrl" placeholder="è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL">
            <button onclick="validateUrl()">éªŒè¯URL</button>
            <button onclick="previewUrl()">é¢„è§ˆå›¾ç‰‡</button>
            <div id="urlValidation"></div>
        </div>

        <!-- è·¯å¾„é€‰æ‹©æ–¹å¼ -->
        <div id="pathSection" class="form-group" style="display: none;">
            <label>é€‰æ‹©å›¾ç‰‡è·¯å¾„ï¼š</label>
            <select id="imagePath">
                <option value="">è¯·é€‰æ‹©ç°æœ‰å›¾ç‰‡è·¯å¾„</option>
                <option value="/uploads/patterns/test-pattern-1.jpg">æµ‹è¯•å›¾æ¡ˆ1</option>
                <option value="/uploads/patterns/test-pattern-2.png">æµ‹è¯•å›¾æ¡ˆ2</option>
                <option value="/uploads/patterns/geometric-pattern.jpg">å‡ ä½•å›¾æ¡ˆ</option>
                <option value="/uploads/patterns/marble-texture.jpg">å¤§ç†çŸ³çº¹ç†</option>
            </select>
            <button onclick="previewPath()">é¢„è§ˆå›¾ç‰‡</button>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ æ–¹å¼ -->
        <div id="fileSection" class="form-group" style="display: none;">
            <label>é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼š</label>
            <input type="file" id="imageFile" accept="image/*">
            <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
            <div id="uploadProgress"></div>
        </div>

        <!-- æ–°å›¾ç‰‡é¢„è§ˆ -->
        <div class="form-group">
            <label>æ–°å›¾ç‰‡é¢„è§ˆï¼š</label>
            <div class="preview-container">
                <img id="newPreview" class="preview-image" style="display: none;" alt="æ–°å›¾æ¡ˆé¢„è§ˆ">
                <div id="previewPlaceholder">æš‚æ— é¢„è§ˆ</div>
            </div>
        </div>

        <button onclick="updatePattern()">æ›´æ–°å›¾æ¡ˆ</button>
        <button onclick="resetTest()" class="danger">é‡ç½®æµ‹è¯•</button>
    </div>

    <!-- æµ‹è¯•ç”¨ä¾‹ -->
    <div class="test-container">
        <h2 class="test-title">3. é¢„è®¾æµ‹è¯•ç”¨ä¾‹</h2>
        <p>ç‚¹å‡»ä»¥ä¸‹æŒ‰é’®å¿«é€Ÿæµ‹è¯•ä¸åŒçš„å›¾ç‰‡URLï¼š</p>
        
        <button onclick="testUrl('https://picsum.photos/200/200?random=2')">æµ‹è¯•URL 1</button>
        <button onclick="testUrl('https://picsum.photos/200/200?random=3')">æµ‹è¯•URL 2</button>
        <button onclick="testUrl('https://picsum.photos/200/200?random=4')">æµ‹è¯•URL 3</button>
        <button onclick="testUrl('https://via.placeholder.com/200x200/ff6b6b/ffffff?text=Pattern')">æµ‹è¯•å ä½å›¾</button>
        <button onclick="testUrl('invalid-url')" class="danger">æµ‹è¯•æ— æ•ˆURL</button>
        <button onclick="runAutomatedTests()" style="background: #67c23a;">è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•</button>
    </div>

    <!-- æµ‹è¯•ç»“æœ -->
    <div class="test-results">
        <h3>æµ‹è¯•ç»“æœï¼š</h3>
        <div id="testResults">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script src="test-pattern-image-replacement.js"></script>
    <script>
        let currentTest = {
            originalUrl: 'https://picsum.photos/200/200?random=1',
            newUrl: '',
            uploadType: 'url'
        };

        // ä¸Šä¼ æ–¹å¼åˆ‡æ¢
        document.querySelectorAll('input[name="uploadType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                currentTest.uploadType = this.value;
                switchUploadType(this.value);
            });
        });

        function switchUploadType(type) {
            document.getElementById('urlSection').style.display = type === 'url' ? 'block' : 'none';
            document.getElementById('pathSection').style.display = type === 'path' ? 'block' : 'none';
            document.getElementById('fileSection').style.display = type === 'file' ? 'block' : 'none';
            
            // æ¸…é™¤é¢„è§ˆ
            clearPreview();
        }

        function clearPreview() {
            const newPreview = document.getElementById('newPreview');
            const placeholder = document.getElementById('previewPlaceholder');
            newPreview.style.display = 'none';
            placeholder.textContent = 'æš‚æ— é¢„è§ˆ';
            placeholder.style.display = 'block';
        }

        function showPreview(url) {
            const newPreview = document.getElementById('newPreview');
            const placeholder = document.getElementById('previewPlaceholder');
            
            newPreview.src = url;
            newPreview.style.display = 'block';
            placeholder.style.display = 'none';
            
            // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
            newPreview.onerror = function() {
                newPreview.style.display = 'none';
                placeholder.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                placeholder.style.display = 'block';
                logResult('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥: ' + url, 'error');
            };
            
            newPreview.onload = function() {
                logResult('âœ… å›¾ç‰‡é¢„è§ˆæˆåŠŸ: ' + url, 'success');
            };
        }

        async function validateUrl() {
            const url = document.getElementById('newImageUrl').value.trim();
            const validation = document.getElementById('urlValidation');
            
            if (!url) {
                validation.innerHTML = '<div class="error">è¯·è¾“å…¥å›¾ç‰‡URL</div>';
                return false;
            }
            
            // åŸºæœ¬URLæ ¼å¼éªŒè¯
            try {
                new URL(url);
            } catch (e) {
                validation.innerHTML = '<div class="error">URLæ ¼å¼æ— æ•ˆ</div>';
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡URL
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
            const isImageUrl = imageExtensions.some(ext => 
                url.toLowerCase().includes(ext) || 
                url.includes('picsum.photos') || 
                url.includes('placeholder.com')
            );
            
            if (!isImageUrl) {
                validation.innerHTML = '<div class="error">URLå¯èƒ½ä¸æ˜¯å›¾ç‰‡é“¾æ¥</div>';
            } else {
                validation.innerHTML = '<div class="success">URLæ ¼å¼æ­£ç¡®</div>';
            }
            
            // å°è¯•éªŒè¯URLå¯è®¿é—®æ€§
            try {
                const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                validation.innerHTML += '<div class="success">URLå¯è®¿é—®</div>';
                return true;
            } catch (error) {
                validation.innerHTML += '<div class="error">URLå¯è®¿é—®æ€§éªŒè¯å¤±è´¥ï¼ˆå¯èƒ½æ˜¯CORSé™åˆ¶ï¼‰</div>';
                return true; // å³ä½¿CORSå¤±è´¥ï¼Œä¹Ÿå…è®¸ç»§ç»­æµ‹è¯•
            }
        }

        function previewUrl() {
            const url = document.getElementById('newImageUrl').value.trim();
            if (!url) {
                alert('è¯·å…ˆè¾“å…¥å›¾ç‰‡URL');
                return;
            }
            
            currentTest.newUrl = url;
            showPreview(url);
            logResult('ğŸ” é¢„è§ˆURL: ' + url, 'info');
        }

        function previewPath() {
            const path = document.getElementById('imagePath').value;
            if (!path) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡è·¯å¾„');
                return;
            }
            
            // æ¨¡æ‹ŸæœåŠ¡å™¨è·¯å¾„è½¬æ¢ä¸ºå®Œæ•´URL
            const fullUrl = `http://localhost:8080/api${path}`;
            currentTest.newUrl = fullUrl;
            showPreview(fullUrl);
            logResult('ğŸ” é¢„è§ˆè·¯å¾„: ' + path + ' -> ' + fullUrl, 'info');
        }

        function uploadFile() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            const progress = document.getElementById('uploadProgress');
            progress.innerHTML = '<div class="info">æ­£åœ¨ä¸Šä¼ ...</div>';
            
            // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ 
            setTimeout(() => {
                const fileName = `uploaded_${Date.now()}_${file.name}`;
                const uploadedUrl = `/uploads/patterns/${fileName}`;
                const fullUrl = `http://localhost:8080/api${uploadedUrl}`;
                
                currentTest.newUrl = fullUrl;
                
                // ä½¿ç”¨FileReaderåˆ›å»ºæœ¬åœ°é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    showPreview(e.target.result);
                };
                reader.readAsDataURL(file);
                
                progress.innerHTML = '<div class="success">ä¸Šä¼ æˆåŠŸ: ' + fileName + '</div>';
                logResult('ğŸ“ æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ' + fileName, 'success');
            }, 1500);
        }

        function testUrl(url) {
            document.getElementById('newImageUrl').value = url;
            currentTest.newUrl = url;
            showPreview(url);
            logResult('ğŸ§ª æµ‹è¯•URL: ' + url, 'info');
        }

        function updatePattern() {
            if (!currentTest.newUrl) {
                alert('è¯·å…ˆé€‰æ‹©æˆ–è¾“å…¥æ–°çš„å›¾ç‰‡');
                return;
            }
            
            // æ¨¡æ‹Ÿæ›´æ–°å›¾æ¡ˆ
            logResult('ğŸ”„ å¼€å§‹æ›´æ–°å›¾æ¡ˆ...', 'info');
            
            setTimeout(() => {
                // æ›´æ–°å½“å‰å›¾ç‰‡
                document.getElementById('currentImageUrl').value = currentTest.newUrl;
                document.getElementById('currentPreview').src = currentTest.newUrl;
                
                // æ¸…é™¤æ–°å›¾ç‰‡é¢„è§ˆ
                clearPreview();
                
                // æ¸…é™¤è¾“å…¥
                document.getElementById('newImageUrl').value = '';
                document.getElementById('imagePath').value = '';
                document.getElementById('imageFile').value = '';
                document.getElementById('urlValidation').innerHTML = '';
                document.getElementById('uploadProgress').innerHTML = '';
                
                logResult('âœ… å›¾æ¡ˆæ›´æ–°æˆåŠŸï¼æ–°å›¾ç‰‡URL: ' + currentTest.newUrl, 'success');
                
                // é‡ç½®æµ‹è¯•çŠ¶æ€
                currentTest.originalUrl = currentTest.newUrl;
                currentTest.newUrl = '';
                
            }, 1000);
        }

        function resetTest() {
            // é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
            const initialUrl = 'https://picsum.photos/200/200?random=1';
            document.getElementById('currentImageUrl').value = initialUrl;
            document.getElementById('currentPreview').src = initialUrl;
            
            // æ¸…é™¤æ‰€æœ‰è¾“å…¥
            document.getElementById('newImageUrl').value = '';
            document.getElementById('imagePath').value = '';
            document.getElementById('imageFile').value = '';
            document.getElementById('urlValidation').innerHTML = '';
            document.getElementById('uploadProgress').innerHTML = '';
            
            // æ¸…é™¤é¢„è§ˆ
            clearPreview();
            
            // é‡ç½®ä¸Šä¼ æ–¹å¼ä¸ºURL
            document.querySelector('input[name="uploadType"][value="url"]').checked = true;
            switchUploadType('url');
            
            // é‡ç½®æµ‹è¯•çŠ¶æ€
            currentTest = {
                originalUrl: initialUrl,
                newUrl: '',
                uploadType: 'url'
            };
            
            logResult('ğŸ”„ æµ‹è¯•å·²é‡ç½®', 'info');
        }

        function logResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        // è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
        async function runAutomatedTests() {
            logResult('ğŸ¤– å¼€å§‹è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•...', 'info');
            
            try {
                const results = await window.runPatternImageTests();
                
                logResult(`ğŸ“Š è‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆ: ${results.passed}/${results.total} é€šè¿‡`, 
                         results.failed === 0 ? 'success' : 'error');
                
                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                results.results.forEach(result => {
                    const status = result.success ? 'âœ…' : 'âŒ';
                    logResult(`${status} ${result.testName}: ${result.message}`, 
                             result.success ? 'success' : 'error');
                });
                
            } catch (error) {
                logResult('âŒ è‡ªåŠ¨åŒ–æµ‹è¯•è¿è¡Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logResult('ğŸš€ å›¾æ¡ˆå›¾ç‰‡æ›´æ¢åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            logResult('ğŸ“‹ æµ‹è¯•æ­¥éª¤ï¼š1. é€‰æ‹©ä¸Šä¼ æ–¹å¼ 2. è¾“å…¥/é€‰æ‹©æ–°å›¾ç‰‡ 3. é¢„è§ˆå›¾ç‰‡ 4. æ›´æ–°å›¾æ¡ˆ', 'info');
            logResult('ğŸ¤– ç‚¹å‡»"è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•"æŒ‰é’®å¯æ‰§è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>