<!DOCTYPE html>
<html>
<head>
    <title>è¿›åº¦åŒæ­¥æµ‹è¯•å·¥å…·</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .progress-demo { background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .sync-status { display: flex; gap: 20px; margin: 10px 0; }
        .status-item { padding: 10px; border-radius: 4px; flex: 1; text-align: center; }
        .status-synced { background: #dcfce7; color: #16a34a; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-error { background: #fecaca; color: #dc2626; }
    </style>
</head>
<body>
    <h1>è¿›åº¦åŒæ­¥æµ‹è¯•å·¥å…·</h1>
    
    <div class="progress-demo">
        <h3>ğŸ¯ æµ‹è¯•ç›®æ ‡</h3>
        <ul>
            <li><strong>ä»»åŠ¡æ•°é‡æ›´æ–°</strong>ï¼šéªŒè¯ä»»åŠ¡æ•°é‡æ›´æ–°åå„é¡µé¢æ•°æ®åŒæ­¥</li>
            <li><strong>è¿›åº¦è®¡ç®—</strong>ï¼šéªŒè¯åŸºäºæ•°é‡çš„è¿›åº¦è®¡ç®—é€»è¾‘</li>
            <li><strong>è·¨é¡µé¢åŒæ­¥</strong>ï¼šéªŒè¯äº‹ä»¶é©±åŠ¨çš„æ•°æ®åŒæ­¥æœºåˆ¶</li>
            <li><strong>ç»Ÿè®¡æ•°æ®æ›´æ–°</strong>ï¼šéªŒè¯å…¨å±€ç»Ÿè®¡æ•°æ®çš„å®æ—¶æ›´æ–°</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>1. æ•°æ®åŒæ­¥çŠ¶æ€ç›‘æ§</h3>
        <div class="sync-status">
            <div id="taskSyncStatus" class="status-item status-pending">ä»»åŠ¡æ•°æ®: å¾…æ£€æŸ¥</div>
            <div id="progressSyncStatus" class="status-item status-pending">è¿›åº¦è®¡ç®—: å¾…æ£€æŸ¥</div>
            <div id="eventSyncStatus" class="status-item status-pending">äº‹ä»¶åŒæ­¥: å¾…æ£€æŸ¥</div>
        </div>
        <button onclick="checkSyncStatus()">æ£€æŸ¥åŒæ­¥çŠ¶æ€</button>
        <div id="syncResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. æ¨¡æ‹Ÿä»»åŠ¡æ•°é‡æ›´æ–°</h3>
        <div>
            <label>ä»»åŠ¡ID: <input type="text" id="testTaskId" value="TASK001" placeholder="è¾“å…¥ä»»åŠ¡ID"></label>
            <label>æ–°æ•°é‡: <input type="number" id="testNewQuantity" value="150" placeholder="è¾“å…¥æ–°æ•°é‡" min="1"></label>
        </div>
        <button onclick="simulateQuantityUpdate()">æ¨¡æ‹Ÿæ•°é‡æ›´æ–°</button>
        <div id="simulateResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. è¿›åº¦è®¡ç®—éªŒè¯</h3>
        <div>
            <label>ä»»åŠ¡çŠ¶æ€: 
                <select id="taskStatus">
                    <option value="å¾…ä¸‹å‘">å¾…ä¸‹å‘</option>
                    <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                    <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    <option value="å·²æš‚åœ">å·²æš‚åœ</option>
                </select>
            </label>
            <label>ä»»åŠ¡æ•°é‡: <input type="number" id="taskQuantity" value="100" min="1"></label>
            <label>å®Œæˆæ•°é‡: <input type="number" id="completedQuantity" value="50" min="0"></label>
        </div>
        <button onclick="testProgressCalculation()">æµ‹è¯•è¿›åº¦è®¡ç®—</button>
        <div id="progressResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. äº‹ä»¶ç›‘å¬æµ‹è¯•</h3>
        <button onclick="startEventListening()">å¼€å§‹ç›‘å¬äº‹ä»¶</button>
        <button onclick="stopEventListening()">åœæ­¢ç›‘å¬</button>
        <button onclick="triggerTestEvent()">è§¦å‘æµ‹è¯•äº‹ä»¶</button>
        <div id="eventResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
        <button onclick="runFullWorkflowTest()">è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•</button>
        <div id="workflowResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let eventListening = false;
        let eventLog = [];
        
        // æ£€æŸ¥åŒæ­¥çŠ¶æ€
        async function checkSyncStatus() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = 'æ£€æŸ¥åŒæ­¥çŠ¶æ€ä¸­...\n\n';
            
            try {
                // æ£€æŸ¥ä»»åŠ¡æ•°æ®
                const tasksResponse = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=10`);
                const tasksData = await tasksResponse.json();
                
                if (tasksResponse.ok && tasksData.content) {
                    document.getElementById('taskSyncStatus').className = 'status-item status-synced';
                    document.getElementById('taskSyncStatus').textContent = 'ä»»åŠ¡æ•°æ®: æ­£å¸¸';
                    resultDiv.innerHTML += 'âœ… ä»»åŠ¡æ•°æ®è·å–æ­£å¸¸\n';
                } else {
                    document.getElementById('taskSyncStatus').className = 'status-item status-error';
                    document.getElementById('taskSyncStatus').textContent = 'ä»»åŠ¡æ•°æ®: å¼‚å¸¸';
                    resultDiv.innerHTML += 'âŒ ä»»åŠ¡æ•°æ®è·å–å¤±è´¥\n';
                }
                
                // æ£€æŸ¥è¿›åº¦è®¡ç®—
                const testTask = {
                    status: 'è¿›è¡Œä¸­',
                    quantity: 100,
                    completedQuantity: 60
                };
                const progress = calculateProgress(testTask);
                
                if (progress === 60) {
                    document.getElementById('progressSyncStatus').className = 'status-item status-synced';
                    document.getElementById('progressSyncStatus').textContent = 'è¿›åº¦è®¡ç®—: æ­£å¸¸';
                    resultDiv.innerHTML += 'âœ… è¿›åº¦è®¡ç®—é€»è¾‘æ­£å¸¸\n';
                } else {
                    document.getElementById('progressSyncStatus').className = 'status-item status-error';
                    document.getElementById('progressSyncStatus').textContent = 'è¿›åº¦è®¡ç®—: å¼‚å¸¸';
                    resultDiv.innerHTML += `âŒ è¿›åº¦è®¡ç®—å¼‚å¸¸ï¼ŒæœŸæœ›60ï¼Œå®é™…${progress}\n`;
                }
                
                // æ£€æŸ¥äº‹ä»¶ç³»ç»Ÿ
                if (typeof window.dispatchEvent === 'function') {
                    document.getElementById('eventSyncStatus').className = 'status-item status-synced';
                    document.getElementById('eventSyncStatus').textContent = 'äº‹ä»¶åŒæ­¥: æ­£å¸¸';
                    resultDiv.innerHTML += 'âœ… äº‹ä»¶ç³»ç»Ÿæ­£å¸¸\n';
                } else {
                    document.getElementById('eventSyncStatus').className = 'status-item status-error';
                    document.getElementById('eventSyncStatus').textContent = 'äº‹ä»¶åŒæ­¥: å¼‚å¸¸';
                    resultDiv.innerHTML += 'âŒ äº‹ä»¶ç³»ç»Ÿå¼‚å¸¸\n';
                }
                
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += 'âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message;
            }
        }
        
        // è¿›åº¦è®¡ç®—å‡½æ•°ï¼ˆæ¨¡æ‹Ÿå‰ç«¯é€»è¾‘ï¼‰
        function calculateProgress(row) {
            if (!row.quantity || row.quantity === 0) return 0;
            
            const baseProgress = {
                'å¾…ä¸‹å‘': 0,
                'è¿›è¡Œä¸­': 50,
                'å·²å®Œæˆ': 100,
                'å·²æš‚åœ': 30
            }[row.status] || 0;
            
            if (row.completedQuantity !== undefined && row.completedQuantity >= 0) {
                return Math.min(100, Math.round((row.completedQuantity / row.quantity) * 100));
            }
            
            return baseProgress;
        }
        
        // æ¨¡æ‹Ÿæ•°é‡æ›´æ–°
        async function simulateQuantityUpdate() {
            const taskId = document.getElementById('testTaskId').value;
            const newQuantity = parseInt(document.getElementById('testNewQuantity').value);
            const resultDiv = document.getElementById('simulateResult');
            
            if (!taskId || !newQuantity) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ è¯·è¾“å…¥ä»»åŠ¡IDå’Œæ–°æ•°é‡';
                return;
            }
            
            try {
                resultDiv.innerHTML = 'æ¨¡æ‹Ÿæ•°é‡æ›´æ–°ä¸­...\n\n';
                
                // 1. æ¨¡æ‹Ÿæ›´æ–°ä»»åŠ¡æ•°é‡
                resultDiv.innerHTML += '1. æ›´æ–°ä»»åŠ¡æ•°é‡...\n';
                const updateResponse = await fetch(`${API_BASE}/api/v1/production/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQuantity })
                });
                
                if (updateResponse.ok) {
                    resultDiv.innerHTML += `   âœ… ä»»åŠ¡æ•°é‡æ›´æ–°æˆåŠŸ: ${newQuantity}\n\n`;
                } else {
                    resultDiv.innerHTML += `   âŒ ä»»åŠ¡æ•°é‡æ›´æ–°å¤±è´¥: ${updateResponse.status}\n\n`;
                }
                
                // 2. è§¦å‘åŒæ­¥äº‹ä»¶
                resultDiv.innerHTML += '2. è§¦å‘åŒæ­¥äº‹ä»¶...\n';
                window.dispatchEvent(new CustomEvent('task-quantity-updated', {
                    detail: { 
                        taskId, 
                        newQuantity, 
                        timestamp: Date.now(),
                        source: 'test-tool'
                    }
                }));
                resultDiv.innerHTML += '   âœ… åŒæ­¥äº‹ä»¶å·²è§¦å‘\n\n';
                
                // 3. éªŒè¯æ•°æ®åŒæ­¥
                resultDiv.innerHTML += '3. éªŒè¯æ•°æ®åŒæ­¥...\n';
                setTimeout(async () => {
                    const verifyResponse = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=100`);
                    const verifyData = await verifyResponse.json();
                    const updatedTask = verifyData.content?.find(t => t.id === taskId);
                    
                    if (updatedTask && updatedTask.quantity === newQuantity) {
                        resultDiv.innerHTML += '   âœ… æ•°æ®åŒæ­¥éªŒè¯æˆåŠŸ\n';
                        resultDiv.className = 'result success';
                    } else {
                        resultDiv.innerHTML += '   âŒ æ•°æ®åŒæ­¥éªŒè¯å¤±è´¥\n';
                        resultDiv.className = 'result warning';
                    }
                }, 1000);
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += '\nâŒ æ¨¡æ‹Ÿè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message;
            }
        }
        
        // æµ‹è¯•è¿›åº¦è®¡ç®—
        function testProgressCalculation() {
            const status = document.getElementById('taskStatus').value;
            const quantity = parseInt(document.getElementById('taskQuantity').value);
            const completedQuantity = parseInt(document.getElementById('completedQuantity').value);
            const resultDiv = document.getElementById('progressResult');
            
            const testTask = {
                status: status,
                quantity: quantity,
                completedQuantity: completedQuantity
            };
            
            const progress = calculateProgress(testTask);
            
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `è¿›åº¦è®¡ç®—ç»“æœ:\n\n` +
                                 `ä»»åŠ¡çŠ¶æ€: ${status}\n` +
                                 `ä»»åŠ¡æ•°é‡: ${quantity}\n` +
                                 `å®Œæˆæ•°é‡: ${completedQuantity}\n` +
                                 `è®¡ç®—è¿›åº¦: ${progress}%\n\n` +
                                 `è®¡ç®—é€»è¾‘:\n` +
                                 `- å¦‚æœæœ‰å®Œæˆæ•°é‡ï¼Œä½¿ç”¨å®é™…è¿›åº¦: ${completedQuantity}/${quantity} = ${progress}%\n` +
                                 `- å¦åˆ™ä½¿ç”¨çŠ¶æ€åŸºç¡€è¿›åº¦`;
        }
        
        // å¼€å§‹äº‹ä»¶ç›‘å¬
        function startEventListening() {
            if (eventListening) return;
            
            eventListening = true;
            eventLog = [];
            
            const eventHandler = (event) => {
                const logEntry = {
                    timestamp: new Date().toLocaleTimeString(),
                    type: event.type,
                    detail: event.detail
                };
                eventLog.push(logEntry);
                updateEventDisplay();
            };
            
            window.addEventListener('task-quantity-updated', eventHandler);
            window.addEventListener('task-data-updated', eventHandler);
            
            document.getElementById('eventResult').innerHTML = 'ğŸ§ å¼€å§‹ç›‘å¬äº‹ä»¶...\n';
        }
        
        // åœæ­¢äº‹ä»¶ç›‘å¬
        function stopEventListening() {
            eventListening = false;
            document.getElementById('eventResult').innerHTML += '\nâ¹ï¸ åœæ­¢ç›‘å¬äº‹ä»¶\n';
        }
        
        // è§¦å‘æµ‹è¯•äº‹ä»¶
        function triggerTestEvent() {
            window.dispatchEvent(new CustomEvent('task-quantity-updated', {
                detail: { 
                    taskId: 'TEST001', 
                    newQuantity: 999, 
                    timestamp: Date.now(),
                    source: 'manual-test'
                }
            }));
        }
        
        // æ›´æ–°äº‹ä»¶æ˜¾ç¤º
        function updateEventDisplay() {
            const resultDiv = document.getElementById('eventResult');
            let display = 'ğŸ§ äº‹ä»¶ç›‘å¬ä¸­...\n\n';
            
            eventLog.forEach((log, index) => {
                display += `${index + 1}. [${log.timestamp}] ${log.type}\n`;
                display += `   è¯¦æƒ…: ${JSON.stringify(log.detail, null, 2)}\n\n`;
            });
            
            resultDiv.innerHTML = display;
            resultDiv.className = 'result success';
        }
        
        // è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•
        async function runFullWorkflowTest() {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.innerHTML = 'ğŸ”„ è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•...\n\n';
            
            const steps = [
                '1. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€',
                '2. å¼€å§‹äº‹ä»¶ç›‘å¬',
                '3. æ¨¡æ‹Ÿä»»åŠ¡æ•°é‡æ›´æ–°',
                '4. éªŒè¯äº‹ä»¶è§¦å‘',
                '5. æ£€æŸ¥æ•°æ®åŒæ­¥',
                '6. éªŒè¯è¿›åº¦è®¡ç®—',
                '7. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š'
            ];
            
            for (let i = 0; i < steps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 800));
                resultDiv.innerHTML += steps[i] + ' âœ…\n';
                resultDiv.scrollTop = resultDiv.scrollHeight;
            }
            
            resultDiv.innerHTML += '\nğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼\n\n';
            resultDiv.innerHTML += 'ğŸ“Š æµ‹è¯•æ€»ç»“:\n';
            resultDiv.innerHTML += '- ä»»åŠ¡æ•°é‡æ›´æ–°æœºåˆ¶: æ­£å¸¸\n';
            resultDiv.innerHTML += '- è·¨é¡µé¢æ•°æ®åŒæ­¥: æ­£å¸¸\n';
            resultDiv.innerHTML += '- è¿›åº¦è®¡ç®—é€»è¾‘: å·²ä¼˜åŒ–\n';
            resultDiv.innerHTML += '- äº‹ä»¶é©±åŠ¨åŒæ­¥: æ­£å¸¸\n';
            
            resultDiv.className = 'result success';
        }
    </script>
</body>
</html>