<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾æ¡ˆæ›´æ–°è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-title {
            color: #409eff;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #337ecc;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-error {
            color: #dc3545;
        }
        .log-success {
            color: #28a745;
        }
        .log-info {
            color: #17a2b8;
        }
        .log-warning {
            color: #ffc107;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å›¾æ¡ˆæ›´æ–°è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-container">
        <h2 class="debug-title">1. è·å–ç°æœ‰å›¾æ¡ˆæ•°æ®</h2>
        <button onclick="fetchPatterns()">è·å–å›¾æ¡ˆåˆ—è¡¨</button>
        <button onclick="fetchPatternById()">æ ¹æ®IDè·å–å›¾æ¡ˆ</button>
        
        <div class="form-group">
            <label>å›¾æ¡ˆIDï¼š</label>
            <input type="text" id="patternId" placeholder="è¾“å…¥è¦æŸ¥è¯¢çš„å›¾æ¡ˆID">
        </div>
        
        <div class="form-group">
            <label>è·å–åˆ°çš„æ•°æ®ï¼š</label>
            <div id="fetchedData" class="data-display">ç­‰å¾…è·å–æ•°æ®...</div>
        </div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">2. æ¨¡æ‹Ÿå›¾æ¡ˆæ›´æ–°</h2>
        
        <div class="form-group">
            <label>å›¾æ¡ˆIDï¼š</label>
            <input type="text" id="updatePatternId" placeholder="è¦æ›´æ–°çš„å›¾æ¡ˆID">
        </div>
        
        <div class="form-group">
            <label>å›¾æ¡ˆç¼–å·ï¼š</label>
            <input type="text" id="patternCode" value="TEST-PATTERN-001">
        </div>
        
        <div class="form-group">
            <label>å›¾æ¡ˆåç§°ï¼š</label>
            <input type="text" id="patternName" value="æµ‹è¯•å›¾æ¡ˆ">
        </div>
        
        <div class="form-group">
            <label>å½“å‰å›¾ç‰‡URLï¼š</label>
            <input type="text" id="currentImageUrl" readonly>
        </div>
        
        <div class="form-group">
            <label>æ–°å›¾ç‰‡URLï¼š</label>
            <input type="text" id="newImageUrl" placeholder="è¾“å…¥æ–°çš„å›¾ç‰‡URL">
            <img id="newImagePreview" class="image-preview" style="display: none;">
        </div>
        
        <button onclick="previewNewImage()">é¢„è§ˆæ–°å›¾ç‰‡</button>
        <button onclick="updatePattern()" class="success">æ›´æ–°å›¾æ¡ˆ</button>
        <button onclick="verifyUpdate()" class="success">éªŒè¯æ›´æ–°ç»“æœ</button>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">3. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="runFullTest()" class="success">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <button onclick="clearLogs()" class="danger">æ¸…é™¤æ—¥å¿—</button>
        
        <div class="form-group">
            <label>æµ‹è¯•æ—¥å¿—ï¼š</label>
            <div id="testLogs" class="log-container">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1/process/print-patterns';
        let currentPatternData = null;

        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('testLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('testLogs').innerHTML = 'ç­‰å¾…æµ‹è¯•...';
        }

        // è·å–å›¾æ¡ˆåˆ—è¡¨
        async function fetchPatterns() {
            try {
                log('å¼€å§‹è·å–å›¾æ¡ˆåˆ—è¡¨...', 'info');
                
                const response = await fetch(`${API_BASE}/all?page=0&size=10&sort=id,desc`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`æˆåŠŸè·å–å›¾æ¡ˆåˆ—è¡¨ï¼Œå…± ${data.content?.length || 0} æ¡è®°å½•`, 'success');
                
                document.getElementById('fetchedData').textContent = JSON.stringify(data, null, 2);
                
                // å¦‚æœæœ‰æ•°æ®ï¼Œè‡ªåŠ¨å¡«å……ç¬¬ä¸€ä¸ªå›¾æ¡ˆçš„ä¿¡æ¯
                if (data.content && data.content.length > 0) {
                    const firstPattern = data.content[0];
                    document.getElementById('patternId').value = firstPattern.id;
                    document.getElementById('updatePatternId').value = firstPattern.id;
                    document.getElementById('patternCode').value = firstPattern.patternCode || '';
                    document.getElementById('patternName').value = firstPattern.patternName || '';
                    document.getElementById('currentImageUrl').value = firstPattern.imageUrl || '';
                    currentPatternData = firstPattern;
                    log(`è‡ªåŠ¨å¡«å……ç¬¬ä¸€ä¸ªå›¾æ¡ˆä¿¡æ¯: ID=${firstPattern.id}`, 'info');
                }
                
            } catch (error) {
                log(`è·å–å›¾æ¡ˆåˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('fetchedData').textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // æ ¹æ®IDè·å–å›¾æ¡ˆ
        async function fetchPatternById() {
            const patternId = document.getElementById('patternId').value.trim();
            
            if (!patternId) {
                log('è¯·è¾“å…¥å›¾æ¡ˆID', 'warning');
                return;
            }
            
            try {
                log(`å¼€å§‹è·å–å›¾æ¡ˆè¯¦æƒ…ï¼ŒID: ${patternId}`, 'info');
                
                const response = await fetch(`${API_BASE}/${patternId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`æˆåŠŸè·å–å›¾æ¡ˆè¯¦æƒ…`, 'success');
                
                document.getElementById('fetchedData').textContent = JSON.stringify(data, null, 2);
                currentPatternData = data;
                
                // å¡«å……æ›´æ–°è¡¨å•
                document.getElementById('updatePatternId').value = data.id;
                document.getElementById('patternCode').value = data.patternCode || '';
                document.getElementById('patternName').value = data.patternName || '';
                document.getElementById('currentImageUrl').value = data.imageUrl || '';
                
            } catch (error) {
                log(`è·å–å›¾æ¡ˆè¯¦æƒ…å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('fetchedData').textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // é¢„è§ˆæ–°å›¾ç‰‡
        function previewNewImage() {
            const newImageUrl = document.getElementById('newImageUrl').value.trim();
            const preview = document.getElementById('newImagePreview');
            
            if (!newImageUrl) {
                log('è¯·è¾“å…¥æ–°å›¾ç‰‡URL', 'warning');
                preview.style.display = 'none';
                return;
            }
            
            log(`é¢„è§ˆæ–°å›¾ç‰‡: ${newImageUrl}`, 'info');
            preview.src = newImageUrl;
            preview.style.display = 'block';
            
            preview.onload = () => {
                log('æ–°å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
            };
            
            preview.onerror = () => {
                log('æ–°å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                preview.style.display = 'none';
            };
        }

        // æ›´æ–°å›¾æ¡ˆ
        async function updatePattern() {
            const patternId = document.getElementById('updatePatternId').value.trim();
            const patternCode = document.getElementById('patternCode').value.trim();
            const patternName = document.getElementById('patternName').value.trim();
            const newImageUrl = document.getElementById('newImageUrl').value.trim();
            
            if (!patternId) {
                log('è¯·è¾“å…¥å›¾æ¡ˆID', 'warning');
                return;
            }
            
            if (!patternCode || !patternName) {
                log('è¯·å¡«å†™å›¾æ¡ˆç¼–å·å’Œåç§°', 'warning');
                return;
            }
            
            try {
                log(`å¼€å§‹æ›´æ–°å›¾æ¡ˆï¼ŒID: ${patternId}`, 'info');
                
                const updateData = {
                    patternCode: patternCode,
                    patternName: patternName,
                    machineModel: currentPatternData?.machineModel || 'A',
                    defaultPrintSpeed: currentPatternData?.defaultPrintSpeed || 100,
                    defaultPressure: currentPatternData?.defaultPressure || 50,
                    planId: currentPatternData?.planId || '',
                    taskId: currentPatternData?.taskId || '',
                    deviceId: currentPatternData?.deviceId || '',
                    imageUrl: newImageUrl || currentPatternData?.imageUrl || ''
                };
                
                log(`å‘é€æ›´æ–°æ•°æ®: ${JSON.stringify(updateData, null, 2)}`, 'info');
                
                const response = await fetch(`${API_BASE}/${patternId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                log(`æ›´æ–°è¯·æ±‚å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                // å¤„ç†å“åº”
                const responseText = await response.text();
                log(`æ›´æ–°å“åº”å†…å®¹: ${responseText || '(ç©ºå“åº”)'}`, 'info');
                
                let responseData = null;
                if (responseText) {
                    try {
                        responseData = JSON.parse(responseText);
                    } catch (e) {
                        log('å“åº”ä¸æ˜¯JSONæ ¼å¼ï¼Œä½†æ›´æ–°å¯èƒ½æˆåŠŸ', 'warning');
                    }
                }
                
                log('å›¾æ¡ˆæ›´æ–°è¯·æ±‚å®Œæˆ', 'success');
                
                // ç«‹å³éªŒè¯æ›´æ–°ç»“æœ
                setTimeout(() => {
                    verifyUpdate();
                }, 1000);
                
            } catch (error) {
                log(`æ›´æ–°å›¾æ¡ˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // éªŒè¯æ›´æ–°ç»“æœ
        async function verifyUpdate() {
            const patternId = document.getElementById('updatePatternId').value.trim();
            
            if (!patternId) {
                log('è¯·è¾“å…¥å›¾æ¡ˆID', 'warning');
                return;
            }
            
            try {
                log(`éªŒè¯æ›´æ–°ç»“æœï¼Œé‡æ–°è·å–å›¾æ¡ˆæ•°æ®...`, 'info');
                
                const response = await fetch(`${API_BASE}/${patternId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const updatedData = await response.json();
                log(`éªŒè¯å®Œæˆï¼Œè·å–åˆ°æ›´æ–°åçš„æ•°æ®`, 'success');
                
                // æ¯”è¾ƒæ›´æ–°å‰åçš„æ•°æ®
                const expectedImageUrl = document.getElementById('newImageUrl').value.trim();
                const actualImageUrl = updatedData.imageUrl || '';
                
                log(`æœŸæœ›çš„å›¾ç‰‡URL: ${expectedImageUrl}`, 'info');
                log(`å®é™…çš„å›¾ç‰‡URL: ${actualImageUrl}`, 'info');
                
                if (expectedImageUrl && actualImageUrl === expectedImageUrl) {
                    log('âœ… å›¾ç‰‡URLæ›´æ–°æˆåŠŸï¼', 'success');
                } else if (expectedImageUrl && actualImageUrl !== expectedImageUrl) {
                    log('âŒ å›¾ç‰‡URLæ›´æ–°å¤±è´¥ï¼Œæ•°æ®ä¸åŒ¹é…', 'error');
                } else {
                    log('âš ï¸ æœªè®¾ç½®æ–°å›¾ç‰‡URLï¼Œæ— æ³•éªŒè¯', 'warning');
                }
                
                // æ˜¾ç¤ºå®Œæ•´çš„æ›´æ–°åæ•°æ®
                document.getElementById('fetchedData').textContent = JSON.stringify(updatedData, null, 2);
                
            } catch (error) {
                log(`éªŒè¯æ›´æ–°ç»“æœå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...', 'info');
            
            // 1. è·å–å›¾æ¡ˆåˆ—è¡¨
            await fetchPatterns();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. è®¾ç½®æµ‹è¯•å›¾ç‰‡URL
            const testImageUrl = `https://picsum.photos/200/200?random=${Date.now()}`;
            document.getElementById('newImageUrl').value = testImageUrl;
            log(`è®¾ç½®æµ‹è¯•å›¾ç‰‡URL: ${testImageUrl}`, 'info');
            
            // 3. é¢„è§ˆå›¾ç‰‡
            previewNewImage();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 4. æ‰§è¡Œæ›´æ–°
            await updatePattern();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 5. éªŒè¯ç»“æœ
            await verifyUpdate();
            
            log('ğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹ç»“æŸ', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨è·å–å›¾æ¡ˆæ•°æ®...', 'info');
            fetchPatterns();
        });
    </script>
</body>
</html>