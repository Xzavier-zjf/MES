<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图案更新调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-title {
            color: #409eff;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #337ecc;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-error {
            color: #dc3545;
        }
        .log-success {
            color: #28a745;
        }
        .log-info {
            color: #17a2b8;
        }
        .log-warning {
            color: #ffc107;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>🔍 图案更新调试页面</h1>
    
    <div class="debug-container">
        <h2 class="debug-title">1. 获取现有图案数据</h2>
        <button onclick="fetchPatterns()">获取图案列表</button>
        <button onclick="fetchPatternById()">根据ID获取图案</button>
        
        <div class="form-group">
            <label>图案ID：</label>
            <input type="text" id="patternId" placeholder="输入要查询的图案ID">
        </div>
        
        <div class="form-group">
            <label>获取到的数据：</label>
            <div id="fetchedData" class="data-display">等待获取数据...</div>
        </div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">2. 模拟图案更新</h2>
        
        <div class="form-group">
            <label>图案ID：</label>
            <input type="text" id="updatePatternId" placeholder="要更新的图案ID">
        </div>
        
        <div class="form-group">
            <label>图案编号：</label>
            <input type="text" id="patternCode" value="TEST-PATTERN-001">
        </div>
        
        <div class="form-group">
            <label>图案名称：</label>
            <input type="text" id="patternName" value="测试图案">
        </div>
        
        <div class="form-group">
            <label>当前图片URL：</label>
            <input type="text" id="currentImageUrl" readonly>
        </div>
        
        <div class="form-group">
            <label>新图片URL：</label>
            <input type="text" id="newImageUrl" placeholder="输入新的图片URL">
            <img id="newImagePreview" class="image-preview" style="display: none;">
        </div>
        
        <button onclick="previewNewImage()">预览新图片</button>
        <button onclick="updatePattern()" class="success">更新图案</button>
        <button onclick="verifyUpdate()" class="success">验证更新结果</button>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">3. 完整流程测试</h2>
        <button onclick="runFullTest()" class="success">运行完整测试</button>
        <button onclick="clearLogs()" class="danger">清除日志</button>
        
        <div class="form-group">
            <label>测试日志：</label>
            <div id="testLogs" class="log-container">等待测试...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1/process/print-patterns';
        let currentPatternData = null;

        // 日志记录
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('testLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('testLogs').innerHTML = '等待测试...';
        }

        // 获取图案列表
        async function fetchPatterns() {
            try {
                log('开始获取图案列表...', 'info');
                
                const response = await fetch(`${API_BASE}/all?page=0&size=10&sort=id,desc`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`成功获取图案列表，共 ${data.content?.length || 0} 条记录`, 'success');
                
                document.getElementById('fetchedData').textContent = JSON.stringify(data, null, 2);
                
                // 如果有数据，自动填充第一个图案的信息
                if (data.content && data.content.length > 0) {
                    const firstPattern = data.content[0];
                    document.getElementById('patternId').value = firstPattern.id;
                    document.getElementById('updatePatternId').value = firstPattern.id;
                    document.getElementById('patternCode').value = firstPattern.patternCode || '';
                    document.getElementById('patternName').value = firstPattern.patternName || '';
                    document.getElementById('currentImageUrl').value = firstPattern.imageUrl || '';
                    currentPatternData = firstPattern;
                    log(`自动填充第一个图案信息: ID=${firstPattern.id}`, 'info');
                }
                
            } catch (error) {
                log(`获取图案列表失败: ${error.message}`, 'error');
                document.getElementById('fetchedData').textContent = `错误: ${error.message}`;
            }
        }

        // 根据ID获取图案
        async function fetchPatternById() {
            const patternId = document.getElementById('patternId').value.trim();
            
            if (!patternId) {
                log('请输入图案ID', 'warning');
                return;
            }
            
            try {
                log(`开始获取图案详情，ID: ${patternId}`, 'info');
                
                const response = await fetch(`${API_BASE}/${patternId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`成功获取图案详情`, 'success');
                
                document.getElementById('fetchedData').textContent = JSON.stringify(data, null, 2);
                currentPatternData = data;
                
                // 填充更新表单
                document.getElementById('updatePatternId').value = data.id;
                document.getElementById('patternCode').value = data.patternCode || '';
                document.getElementById('patternName').value = data.patternName || '';
                document.getElementById('currentImageUrl').value = data.imageUrl || '';
                
            } catch (error) {
                log(`获取图案详情失败: ${error.message}`, 'error');
                document.getElementById('fetchedData').textContent = `错误: ${error.message}`;
            }
        }

        // 预览新图片
        function previewNewImage() {
            const newImageUrl = document.getElementById('newImageUrl').value.trim();
            const preview = document.getElementById('newImagePreview');
            
            if (!newImageUrl) {
                log('请输入新图片URL', 'warning');
                preview.style.display = 'none';
                return;
            }
            
            log(`预览新图片: ${newImageUrl}`, 'info');
            preview.src = newImageUrl;
            preview.style.display = 'block';
            
            preview.onload = () => {
                log('新图片加载成功', 'success');
            };
            
            preview.onerror = () => {
                log('新图片加载失败', 'error');
                preview.style.display = 'none';
            };
        }

        // 更新图案
        async function updatePattern() {
            const patternId = document.getElementById('updatePatternId').value.trim();
            const patternCode = document.getElementById('patternCode').value.trim();
            const patternName = document.getElementById('patternName').value.trim();
            const newImageUrl = document.getElementById('newImageUrl').value.trim();
            
            if (!patternId) {
                log('请输入图案ID', 'warning');
                return;
            }
            
            if (!patternCode || !patternName) {
                log('请填写图案编号和名称', 'warning');
                return;
            }
            
            try {
                log(`开始更新图案，ID: ${patternId}`, 'info');
                
                const updateData = {
                    patternCode: patternCode,
                    patternName: patternName,
                    machineModel: currentPatternData?.machineModel || 'A',
                    defaultPrintSpeed: currentPatternData?.defaultPrintSpeed || 100,
                    defaultPressure: currentPatternData?.defaultPressure || 50,
                    planId: currentPatternData?.planId || '',
                    taskId: currentPatternData?.taskId || '',
                    deviceId: currentPatternData?.deviceId || '',
                    imageUrl: newImageUrl || currentPatternData?.imageUrl || ''
                };
                
                log(`发送更新数据: ${JSON.stringify(updateData, null, 2)}`, 'info');
                
                const response = await fetch(`${API_BASE}/${patternId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                log(`更新请求响应状态: ${response.status} ${response.statusText}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                // 处理响应
                const responseText = await response.text();
                log(`更新响应内容: ${responseText || '(空响应)'}`, 'info');
                
                let responseData = null;
                if (responseText) {
                    try {
                        responseData = JSON.parse(responseText);
                    } catch (e) {
                        log('响应不是JSON格式，但更新可能成功', 'warning');
                    }
                }
                
                log('图案更新请求完成', 'success');
                
                // 立即验证更新结果
                setTimeout(() => {
                    verifyUpdate();
                }, 1000);
                
            } catch (error) {
                log(`更新图案失败: ${error.message}`, 'error');
            }
        }

        // 验证更新结果
        async function verifyUpdate() {
            const patternId = document.getElementById('updatePatternId').value.trim();
            
            if (!patternId) {
                log('请输入图案ID', 'warning');
                return;
            }
            
            try {
                log(`验证更新结果，重新获取图案数据...`, 'info');
                
                const response = await fetch(`${API_BASE}/${patternId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const updatedData = await response.json();
                log(`验证完成，获取到更新后的数据`, 'success');
                
                // 比较更新前后的数据
                const expectedImageUrl = document.getElementById('newImageUrl').value.trim();
                const actualImageUrl = updatedData.imageUrl || '';
                
                log(`期望的图片URL: ${expectedImageUrl}`, 'info');
                log(`实际的图片URL: ${actualImageUrl}`, 'info');
                
                if (expectedImageUrl && actualImageUrl === expectedImageUrl) {
                    log('✅ 图片URL更新成功！', 'success');
                } else if (expectedImageUrl && actualImageUrl !== expectedImageUrl) {
                    log('❌ 图片URL更新失败，数据不匹配', 'error');
                } else {
                    log('⚠️ 未设置新图片URL，无法验证', 'warning');
                }
                
                // 显示完整的更新后数据
                document.getElementById('fetchedData').textContent = JSON.stringify(updatedData, null, 2);
                
            } catch (error) {
                log(`验证更新结果失败: ${error.message}`, 'error');
            }
        }

        // 运行完整测试
        async function runFullTest() {
            log('🚀 开始运行完整测试流程...', 'info');
            
            // 1. 获取图案列表
            await fetchPatterns();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. 设置测试图片URL
            const testImageUrl = `https://picsum.photos/200/200?random=${Date.now()}`;
            document.getElementById('newImageUrl').value = testImageUrl;
            log(`设置测试图片URL: ${testImageUrl}`, 'info');
            
            // 3. 预览图片
            previewNewImage();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 4. 执行更新
            await updatePattern();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 5. 验证结果
            await verifyUpdate();
            
            log('🎉 完整测试流程结束', 'info');
        }

        // 页面加载时自动获取数据
        window.addEventListener('load', function() {
            log('页面加载完成，自动获取图案数据...', 'info');
            fetchPatterns();
        });
    </script>
</body>
</html>