# 注塑参数数量逻辑分析报告

## 问题分析

### 原有问题
1. **数量显示不准确**：表格中显示的是注塑参数中的数量，而不是任务的实际数量
2. **缺少数量验证**：新增时没有验证输入数量与任务数量的关系
3. **数量不一致风险**：可能导致生产数量与任务数量不匹配

## 修复方案

### 1. 任务数量显示优化

**修复前**：
```vue
<el-tag>{{ row.quantity }} 件</el-tag>
```

**修复后**：
```vue
<el-tag :type="getQuantityTagType(row)">
  {{ getTaskQuantityDisplay(row) }}
</el-tag>
```

**显示逻辑**：
- 数量匹配：`100 件` (绿色)
- 数量不匹配：`80/100 件` (黄色/红色)
- 超出数量：`120/100 件` (红色)

### 2. 新增模式数量验证

**功能增强**：
- 选择任务时自动填充任务数量
- 实时显示任务总数量
- 数量超出时显示警告标签
- 提交时进行数量验证确认

**验证逻辑**：
```javascript
// 任务变化时自动设置数量
const onTaskChange = (taskId) => {
  const selectedTask = availableInjectionTasks.value.find(task => task.id === taskId)
  if (selectedTask && selectedTask.quantity) {
    form.value.quantity = selectedTask.quantity
  }
}

// 提交时验证数量
if (selectedTaskQuantity > 0 && paramData.quantity > selectedTaskQuantity) {
  // 显示确认对话框
  const confirmResult = await ElMessageBox.confirm(...)
}
```

### 3. 编辑模式处理

**设计决策**：
- 编辑模式不显示数量字段
- 数量应该由任务管理，工艺参数只管理工艺相关参数
- 如需修改数量，应在任务管理中进行

## 数据流程

### 数据获取流程
1. **获取注塑参数列表** → `injectionParams`
2. **获取任务映射** → `taskMap` (显示任务编号)
3. **获取任务详细信息** → `taskDetailsMap` (包含数量等详细信息)
4. **获取可用任务列表** → `availableInjectionTasks` (新增时选择)

### 数量验证流程
1. **选择任务** → 自动填充任务数量
2. **修改数量** → 实时显示数量状态
3. **提交验证** → 检查数量合理性
4. **确认创建** → 创建工艺参数

## 用户体验改进

### 1. 视觉反馈
- **绿色标签**：数量匹配，正常状态
- **黄色标签**：数量不足，需要注意
- **红色标签**：数量超出，需要确认

### 2. 交互优化
- **自动填充**：选择任务后自动设置合理数量
- **实时提示**：显示任务总数量和当前状态
- **确认机制**：超出数量时需要用户确认

### 3. 数据一致性
- **任务关联**：确保工艺参数与任务数据一致
- **数量追踪**：可以追踪每个任务的工艺参数配置情况
- **逻辑验证**：提供数量逻辑验证功能

## 测试建议

### 1. 功能测试
- [ ] 任务数量正确显示
- [ ] 数量标签颜色正确
- [ ] 选择任务时自动填充数量
- [ ] 数量超出时显示警告
- [ ] 提交时数量验证正常

### 2. 边界测试
- [ ] 任务数量为0的情况
- [ ] 任务不存在的情况
- [ ] 数量超出很多的情况
- [ ] 网络异常时的处理

### 3. 用户体验测试
- [ ] 操作流程是否顺畅
- [ ] 提示信息是否清晰
- [ ] 错误处理是否友好

## 后续优化建议

### 1. 数量同步机制
- 考虑任务数量变更时自动更新工艺参数数量
- 提供批量数量调整功能

### 2. 数量分配管理
- 一个任务可能对应多个工艺参数
- 需要考虑数量分配和汇总逻辑

### 3. 历史记录追踪
- 记录数量变更历史
- 提供数量变更审计功能