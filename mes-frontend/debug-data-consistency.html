<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据一致性检查工具</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .problem-demo { background: #fef2f2; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ef4444; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .inconsistent { background-color: #fef2f2; }
        .consistent { background-color: #f0fdf4; }
    </style>
</head>
<body>
    <h1>数据一致性检查工具</h1>
    
    <div class="problem-demo">
        <h3>🚨 发现的问题</h3>
        <p><strong>现象</strong>：任务管理页面显示计划PLAN-20250625-001已完成，但注塑工艺参数页面显示任务数量100/8001件</p>
        <p><strong>分析</strong>：工艺参数数量(100)与任务数量(8001)严重不一致，可能存在数据同步问题</p>
        <p><strong>影响</strong>：数据不一致可能导致生产计划和实际执行出现偏差</p>
    </div>
    
    <div class="debug-section">
        <h3>1. 特定计划数据检查</h3>
        <div>
            <label>计划编号: <input type="text" id="planCode" value="PLAN-20250625-001" placeholder="输入计划编号"></label>
        </div>
        <button onclick="checkSpecificPlan()">检查特定计划</button>
        <div id="specificPlanResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. 全量数据一致性检查</h3>
        <button onclick="checkAllDataConsistency()">检查所有数据一致性</button>
        <div id="allDataResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>3. 数据不一致详情</h3>
        <table id="inconsistencyTable" style="display: none;">
            <thead>
                <tr>
                    <th>计划编号</th>
                    <th>任务编号</th>
                    <th>任务状态</th>
                    <th>任务数量</th>
                    <th>工艺参数数量</th>
                    <th>差异</th>
                    <th>问题类型</th>
                </tr>
            </thead>
            <tbody id="inconsistencyTableBody">
            </tbody>
        </table>
        <div id="inconsistencyResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. 数据修复建议</h3>
        <button onclick="generateFixSuggestions()">生成修复建议</button>
        <div id="fixSuggestionsResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let allTasks = [];
        let allInjectionParams = [];
        let allPlans = [];
        
        // 检查特定计划
        async function checkSpecificPlan() {
            const planCode = document.getElementById('planCode').value;
            const resultDiv = document.getElementById('specificPlanResult');
            
            if (!planCode) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 请输入计划编号';
                return;
            }
            
            try {
                resultDiv.innerHTML = '检查特定计划数据中...\n\n';
                
                // 获取计划数据
                const plansResponse = await fetch(`${API_BASE}/api/v1/production/plans?page=0&size=1000`);
                const plansData = await plansResponse.json();
                const targetPlan = plansData.content?.find(p => p.planCode === planCode);
                
                if (!targetPlan) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML += `❌ 未找到计划 ${planCode}`;
                    return;
                }
                
                // 获取相关任务
                const tasksResponse = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=1000`);
                const tasksData = await tasksResponse.json();
                const relatedTasks = tasksData.content?.filter(t => t.planId === targetPlan.id) || [];
                
                // 获取相关工艺参数
                const paramsResponse = await fetch(`${API_BASE}/api/v1/process/injection-params/all?page=0&size=1000`);
                const paramsData = await paramsResponse.json();
                const relatedParams = paramsData.content?.filter(p => 
                    relatedTasks.some(t => t.id === p.taskId)
                ) || [];
                
                // 分析数据
                let analysis = {
                    planInfo: targetPlan,
                    totalTasks: relatedTasks.length,
                    totalParams: relatedParams.length,
                    taskQuantitySum: relatedTasks.reduce((sum, t) => sum + (t.quantity || 0), 0),
                    paramQuantitySum: relatedParams.reduce((sum, p) => sum + (p.quantity || 0), 0),
                    completedTasks: relatedTasks.filter(t => t.status === '已完成').length,
                    inconsistencies: []
                };
                
                // 检查每个任务的一致性
                relatedTasks.forEach(task => {
                    const relatedParam = relatedParams.find(p => p.taskId === task.id);
                    if (relatedParam) {
                        if (task.quantity !== relatedParam.quantity) {
                            analysis.inconsistencies.push({
                                taskId: task.id,
                                taskCode: task.taskCode,
                                taskQuantity: task.quantity,
                                paramQuantity: relatedParam.quantity,
                                difference: Math.abs(task.quantity - relatedParam.quantity)
                            });
                        }
                    }
                });
                
                resultDiv.className = analysis.inconsistencies.length > 0 ? 'result warning' : 'result success';
                resultDiv.innerHTML = `计划 ${planCode} 数据检查结果:\n\n` +
                                     `计划总数量: ${targetPlan.totalQuantity}\n` +
                                     `计划状态: ${targetPlan.status}\n\n` +
                                     `关联任务数: ${analysis.totalTasks}\n` +
                                     `任务总数量: ${analysis.taskQuantitySum}\n` +
                                     `已完成任务: ${analysis.completedTasks}\n\n` +
                                     `工艺参数数: ${analysis.totalParams}\n` +
                                     `参数总数量: ${analysis.paramQuantitySum}\n\n` +
                                     `数据一致性: ${analysis.inconsistencies.length === 0 ? '✅ 一致' : `❌ 发现${analysis.inconsistencies.length}个不一致`}\n`;
                
                if (analysis.inconsistencies.length > 0) {
                    resultDiv.innerHTML += '\n不一致详情:\n';
                    analysis.inconsistencies.forEach((item, index) => {
                        resultDiv.innerHTML += `${index + 1}. 任务${item.taskCode}: 任务数量${item.taskQuantity} vs 参数数量${item.paramQuantity} (差异${item.difference})\n`;
                    });
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += '❌ 检查过程中发生错误: ' + error.message;
            }
        }
        
        // 检查所有数据一致性
        async function checkAllDataConsistency() {
            const resultDiv = document.getElementById('allDataResult');
            
            try {
                resultDiv.innerHTML = '检查全量数据一致性中...\n\n';
                
                // 获取所有数据
                const [tasksResponse, paramsResponse, plansResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=1000`),
                    fetch(`${API_BASE}/api/v1/process/injection-params/all?page=0&size=1000`),
                    fetch(`${API_BASE}/api/v1/production/plans?page=0&size=1000`)
                ]);
                
                allTasks = (await tasksResponse.json()).content || [];
                allInjectionParams = (await paramsResponse.json()).content || [];
                allPlans = (await plansResponse.json()).content || [];
                
                // 分析数据一致性
                let inconsistencies = [];
                let totalChecked = 0;
                
                allInjectionParams.forEach(param => {
                    const relatedTask = allTasks.find(t => t.id === param.taskId);
                    totalChecked++;
                    
                    if (!relatedTask) {
                        inconsistencies.push({
                            type: '任务不存在',
                            paramId: param.id,
                            taskId: param.taskId,
                            paramQuantity: param.quantity,
                            taskQuantity: 'N/A',
                            planCode: 'N/A'
                        });
                    } else if (relatedTask.quantity !== param.quantity) {
                        const plan = allPlans.find(p => p.id === relatedTask.planId);
                        inconsistencies.push({
                            type: '数量不一致',
                            paramId: param.id,
                            taskId: param.taskId,
                            taskCode: relatedTask.taskCode,
                            paramQuantity: param.quantity,
                            taskQuantity: relatedTask.quantity,
                            taskStatus: relatedTask.status,
                            planCode: plan?.planCode || 'N/A',
                            difference: Math.abs(relatedTask.quantity - param.quantity)
                        });
                    }
                });
                
                // 显示结果
                resultDiv.className = inconsistencies.length > 0 ? 'result warning' : 'result success';
                resultDiv.innerHTML = `全量数据一致性检查结果:\n\n` +
                                     `总检查项: ${totalChecked}\n` +
                                     `一致项: ${totalChecked - inconsistencies.length}\n` +
                                     `不一致项: ${inconsistencies.length}\n` +
                                     `一致性比例: ${Math.round(((totalChecked - inconsistencies.length) / totalChecked) * 100)}%\n\n`;
                
                if (inconsistencies.length > 0) {
                    // 按问题类型分组
                    const byType = inconsistencies.reduce((acc, item) => {
                        acc[item.type] = (acc[item.type] || 0) + 1;
                        return acc;
                    }, {});
                    
                    resultDiv.innerHTML += '问题分布:\n';
                    Object.entries(byType).forEach(([type, count]) => {
                        resultDiv.innerHTML += `- ${type}: ${count}个\n`;
                    });
                    
                    // 显示详细表格
                    showInconsistencyTable(inconsistencies);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += '❌ 检查过程中发生错误: ' + error.message;
            }
        }
        
        // 显示不一致详情表格
        function showInconsistencyTable(inconsistencies) {
            const table = document.getElementById('inconsistencyTable');
            const tbody = document.getElementById('inconsistencyTableBody');
            
            tbody.innerHTML = '';
            
            inconsistencies.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'inconsistent';
                row.innerHTML = `
                    <td>${item.planCode}</td>
                    <td>${item.taskCode || item.taskId}</td>
                    <td>${item.taskStatus || 'N/A'}</td>
                    <td>${item.taskQuantity}</td>
                    <td>${item.paramQuantity}</td>
                    <td>${item.difference || 'N/A'}</td>
                    <td>${item.type}</td>
                `;
            });
            
            table.style.display = 'table';
        }
        
        // 生成修复建议
        function generateFixSuggestions() {
            const resultDiv = document.getElementById('fixSuggestionsResult');
            
            if (allInjectionParams.length === 0) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = '⚠️ 请先运行数据一致性检查';
                return;
            }
            
            let suggestions = [];
            let inconsistencies = [];
            
            // 重新计算不一致项
            allInjectionParams.forEach(param => {
                const relatedTask = allTasks.find(t => t.id === param.taskId);
                if (relatedTask && relatedTask.quantity !== param.quantity) {
                    inconsistencies.push({
                        paramId: param.id,
                        taskId: param.taskId,
                        taskCode: relatedTask.taskCode,
                        paramQuantity: param.quantity,
                        taskQuantity: relatedTask.quantity,
                        taskStatus: relatedTask.status
                    });
                }
            });
            
            if (inconsistencies.length === 0) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = '✅ 数据一致，无需修复';
                return;
            }
            
            // 生成修复建议
            suggestions.push('🔧 数据修复建议:\n');
            suggestions.push('1. 批量同步工艺参数数量到任务数量');
            suggestions.push('2. 或者批量同步任务数量到工艺参数数量');
            suggestions.push('3. 手动逐个检查和修复不一致项\n');
            
            suggestions.push('📋 具体修复步骤:\n');
            
            // 按状态分组建议
            const completedTasks = inconsistencies.filter(i => i.taskStatus === '已完成');
            const inProgressTasks = inconsistencies.filter(i => i.taskStatus === '进行中');
            const otherTasks = inconsistencies.filter(i => !['已完成', '进行中'].includes(i.taskStatus));
            
            if (completedTasks.length > 0) {
                suggestions.push(`已完成任务 (${completedTasks.length}个):`);
                suggestions.push('- 建议将工艺参数数量同步为任务数量');
                suggestions.push('- 因为任务已完成，任务数量应该是准确的\n');
            }
            
            if (inProgressTasks.length > 0) {
                suggestions.push(`进行中任务 (${inProgressTasks.length}个):`);
                suggestions.push('- 需要人工判断哪个数量是正确的');
                suggestions.push('- 建议检查实际生产情况后决定\n');
            }
            
            if (otherTasks.length > 0) {
                suggestions.push(`其他状态任务 (${otherTasks.length}个):`);
                suggestions.push('- 建议统一数量标准');
                suggestions.push('- 可以批量处理\n');
            }
            
            suggestions.push('⚠️ 修复前建议:');
            suggestions.push('1. 备份当前数据');
            suggestions.push('2. 在测试环境先验证修复逻辑');
            suggestions.push('3. 通知相关人员数据变更');
            
            resultDiv.className = 'result warning';
            resultDiv.innerHTML = suggestions.join('\n');
        }
    </script>
</body>
</html>