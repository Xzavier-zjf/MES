<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .problem-demo { background: #fef2f2; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ef4444; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .inconsistent { background-color: #fef2f2; }
        .consistent { background-color: #f0fdf4; }
    </style>
</head>
<body>
    <h1>æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·</h1>
    
    <div class="problem-demo">
        <h3>ğŸš¨ å‘ç°çš„é—®é¢˜</h3>
        <p><strong>ç°è±¡</strong>ï¼šä»»åŠ¡ç®¡ç†é¡µé¢æ˜¾ç¤ºè®¡åˆ’PLAN-20250625-001å·²å®Œæˆï¼Œä½†æ³¨å¡‘å·¥è‰ºå‚æ•°é¡µé¢æ˜¾ç¤ºä»»åŠ¡æ•°é‡100/8001ä»¶</p>
        <p><strong>åˆ†æ</strong>ï¼šå·¥è‰ºå‚æ•°æ•°é‡(100)ä¸ä»»åŠ¡æ•°é‡(8001)ä¸¥é‡ä¸ä¸€è‡´ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®åŒæ­¥é—®é¢˜</p>
        <p><strong>å½±å“</strong>ï¼šæ•°æ®ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´ç”Ÿäº§è®¡åˆ’å’Œå®é™…æ‰§è¡Œå‡ºç°åå·®</p>
    </div>
    
    <div class="debug-section">
        <h3>1. ç‰¹å®šè®¡åˆ’æ•°æ®æ£€æŸ¥</h3>
        <div>
            <label>è®¡åˆ’ç¼–å·: <input type="text" id="planCode" value="PLAN-20250625-001" placeholder="è¾“å…¥è®¡åˆ’ç¼–å·"></label>
        </div>
        <button onclick="checkSpecificPlan()">æ£€æŸ¥ç‰¹å®šè®¡åˆ’</button>
        <div id="specificPlanResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. å…¨é‡æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥</h3>
        <button onclick="checkAllDataConsistency()">æ£€æŸ¥æ‰€æœ‰æ•°æ®ä¸€è‡´æ€§</button>
        <div id="allDataResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>3. æ•°æ®ä¸ä¸€è‡´è¯¦æƒ…</h3>
        <table id="inconsistencyTable" style="display: none;">
            <thead>
                <tr>
                    <th>è®¡åˆ’ç¼–å·</th>
                    <th>ä»»åŠ¡ç¼–å·</th>
                    <th>ä»»åŠ¡çŠ¶æ€</th>
                    <th>ä»»åŠ¡æ•°é‡</th>
                    <th>å·¥è‰ºå‚æ•°æ•°é‡</th>
                    <th>å·®å¼‚</th>
                    <th>é—®é¢˜ç±»å‹</th>
                </tr>
            </thead>
            <tbody id="inconsistencyTableBody">
            </tbody>
        </table>
        <div id="inconsistencyResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. æ•°æ®ä¿®å¤å»ºè®®</h3>
        <button onclick="generateFixSuggestions()">ç”Ÿæˆä¿®å¤å»ºè®®</button>
        <div id="fixSuggestionsResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let allTasks = [];
        let allInjectionParams = [];
        let allPlans = [];
        
        // æ£€æŸ¥ç‰¹å®šè®¡åˆ’
        async function checkSpecificPlan() {
            const planCode = document.getElementById('planCode').value;
            const resultDiv = document.getElementById('specificPlanResult');
            
            if (!planCode) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ è¯·è¾“å…¥è®¡åˆ’ç¼–å·';
                return;
            }
            
            try {
                resultDiv.innerHTML = 'æ£€æŸ¥ç‰¹å®šè®¡åˆ’æ•°æ®ä¸­...\n\n';
                
                // è·å–è®¡åˆ’æ•°æ®
                const plansResponse = await fetch(`${API_BASE}/api/v1/production/plans?page=0&size=1000`);
                const plansData = await plansResponse.json();
                const targetPlan = plansData.content?.find(p => p.planCode === planCode);
                
                if (!targetPlan) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML += `âŒ æœªæ‰¾åˆ°è®¡åˆ’ ${planCode}`;
                    return;
                }
                
                // è·å–ç›¸å…³ä»»åŠ¡
                const tasksResponse = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=1000`);
                const tasksData = await tasksResponse.json();
                const relatedTasks = tasksData.content?.filter(t => t.planId === targetPlan.id) || [];
                
                // è·å–ç›¸å…³å·¥è‰ºå‚æ•°
                const paramsResponse = await fetch(`${API_BASE}/api/v1/process/injection-params/all?page=0&size=1000`);
                const paramsData = await paramsResponse.json();
                const relatedParams = paramsData.content?.filter(p => 
                    relatedTasks.some(t => t.id === p.taskId)
                ) || [];
                
                // åˆ†ææ•°æ®
                let analysis = {
                    planInfo: targetPlan,
                    totalTasks: relatedTasks.length,
                    totalParams: relatedParams.length,
                    taskQuantitySum: relatedTasks.reduce((sum, t) => sum + (t.quantity || 0), 0),
                    paramQuantitySum: relatedParams.reduce((sum, p) => sum + (p.quantity || 0), 0),
                    completedTasks: relatedTasks.filter(t => t.status === 'å·²å®Œæˆ').length,
                    inconsistencies: []
                };
                
                // æ£€æŸ¥æ¯ä¸ªä»»åŠ¡çš„ä¸€è‡´æ€§
                relatedTasks.forEach(task => {
                    const relatedParam = relatedParams.find(p => p.taskId === task.id);
                    if (relatedParam) {
                        if (task.quantity !== relatedParam.quantity) {
                            analysis.inconsistencies.push({
                                taskId: task.id,
                                taskCode: task.taskCode,
                                taskQuantity: task.quantity,
                                paramQuantity: relatedParam.quantity,
                                difference: Math.abs(task.quantity - relatedParam.quantity)
                            });
                        }
                    }
                });
                
                resultDiv.className = analysis.inconsistencies.length > 0 ? 'result warning' : 'result success';
                resultDiv.innerHTML = `è®¡åˆ’ ${planCode} æ•°æ®æ£€æŸ¥ç»“æœ:\n\n` +
                                     `è®¡åˆ’æ€»æ•°é‡: ${targetPlan.totalQuantity}\n` +
                                     `è®¡åˆ’çŠ¶æ€: ${targetPlan.status}\n\n` +
                                     `å…³è”ä»»åŠ¡æ•°: ${analysis.totalTasks}\n` +
                                     `ä»»åŠ¡æ€»æ•°é‡: ${analysis.taskQuantitySum}\n` +
                                     `å·²å®Œæˆä»»åŠ¡: ${analysis.completedTasks}\n\n` +
                                     `å·¥è‰ºå‚æ•°æ•°: ${analysis.totalParams}\n` +
                                     `å‚æ•°æ€»æ•°é‡: ${analysis.paramQuantitySum}\n\n` +
                                     `æ•°æ®ä¸€è‡´æ€§: ${analysis.inconsistencies.length === 0 ? 'âœ… ä¸€è‡´' : `âŒ å‘ç°${analysis.inconsistencies.length}ä¸ªä¸ä¸€è‡´`}\n`;
                
                if (analysis.inconsistencies.length > 0) {
                    resultDiv.innerHTML += '\nä¸ä¸€è‡´è¯¦æƒ…:\n';
                    analysis.inconsistencies.forEach((item, index) => {
                        resultDiv.innerHTML += `${index + 1}. ä»»åŠ¡${item.taskCode}: ä»»åŠ¡æ•°é‡${item.taskQuantity} vs å‚æ•°æ•°é‡${item.paramQuantity} (å·®å¼‚${item.difference})\n`;
                    });
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += 'âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message;
            }
        }
        
        // æ£€æŸ¥æ‰€æœ‰æ•°æ®ä¸€è‡´æ€§
        async function checkAllDataConsistency() {
            const resultDiv = document.getElementById('allDataResult');
            
            try {
                resultDiv.innerHTML = 'æ£€æŸ¥å…¨é‡æ•°æ®ä¸€è‡´æ€§ä¸­...\n\n';
                
                // è·å–æ‰€æœ‰æ•°æ®
                const [tasksResponse, paramsResponse, plansResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=1000`),
                    fetch(`${API_BASE}/api/v1/process/injection-params/all?page=0&size=1000`),
                    fetch(`${API_BASE}/api/v1/production/plans?page=0&size=1000`)
                ]);
                
                allTasks = (await tasksResponse.json()).content || [];
                allInjectionParams = (await paramsResponse.json()).content || [];
                allPlans = (await plansResponse.json()).content || [];
                
                // åˆ†ææ•°æ®ä¸€è‡´æ€§
                let inconsistencies = [];
                let totalChecked = 0;
                
                allInjectionParams.forEach(param => {
                    const relatedTask = allTasks.find(t => t.id === param.taskId);
                    totalChecked++;
                    
                    if (!relatedTask) {
                        inconsistencies.push({
                            type: 'ä»»åŠ¡ä¸å­˜åœ¨',
                            paramId: param.id,
                            taskId: param.taskId,
                            paramQuantity: param.quantity,
                            taskQuantity: 'N/A',
                            planCode: 'N/A'
                        });
                    } else if (relatedTask.quantity !== param.quantity) {
                        const plan = allPlans.find(p => p.id === relatedTask.planId);
                        inconsistencies.push({
                            type: 'æ•°é‡ä¸ä¸€è‡´',
                            paramId: param.id,
                            taskId: param.taskId,
                            taskCode: relatedTask.taskCode,
                            paramQuantity: param.quantity,
                            taskQuantity: relatedTask.quantity,
                            taskStatus: relatedTask.status,
                            planCode: plan?.planCode || 'N/A',
                            difference: Math.abs(relatedTask.quantity - param.quantity)
                        });
                    }
                });
                
                // æ˜¾ç¤ºç»“æœ
                resultDiv.className = inconsistencies.length > 0 ? 'result warning' : 'result success';
                resultDiv.innerHTML = `å…¨é‡æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ç»“æœ:\n\n` +
                                     `æ€»æ£€æŸ¥é¡¹: ${totalChecked}\n` +
                                     `ä¸€è‡´é¡¹: ${totalChecked - inconsistencies.length}\n` +
                                     `ä¸ä¸€è‡´é¡¹: ${inconsistencies.length}\n` +
                                     `ä¸€è‡´æ€§æ¯”ä¾‹: ${Math.round(((totalChecked - inconsistencies.length) / totalChecked) * 100)}%\n\n`;
                
                if (inconsistencies.length > 0) {
                    // æŒ‰é—®é¢˜ç±»å‹åˆ†ç»„
                    const byType = inconsistencies.reduce((acc, item) => {
                        acc[item.type] = (acc[item.type] || 0) + 1;
                        return acc;
                    }, {});
                    
                    resultDiv.innerHTML += 'é—®é¢˜åˆ†å¸ƒ:\n';
                    Object.entries(byType).forEach(([type, count]) => {
                        resultDiv.innerHTML += `- ${type}: ${count}ä¸ª\n`;
                    });
                    
                    // æ˜¾ç¤ºè¯¦ç»†è¡¨æ ¼
                    showInconsistencyTable(inconsistencies);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += 'âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message;
            }
        }
        
        // æ˜¾ç¤ºä¸ä¸€è‡´è¯¦æƒ…è¡¨æ ¼
        function showInconsistencyTable(inconsistencies) {
            const table = document.getElementById('inconsistencyTable');
            const tbody = document.getElementById('inconsistencyTableBody');
            
            tbody.innerHTML = '';
            
            inconsistencies.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'inconsistent';
                row.innerHTML = `
                    <td>${item.planCode}</td>
                    <td>${item.taskCode || item.taskId}</td>
                    <td>${item.taskStatus || 'N/A'}</td>
                    <td>${item.taskQuantity}</td>
                    <td>${item.paramQuantity}</td>
                    <td>${item.difference || 'N/A'}</td>
                    <td>${item.type}</td>
                `;
            });
            
            table.style.display = 'table';
        }
        
        // ç”Ÿæˆä¿®å¤å»ºè®®
        function generateFixSuggestions() {
            const resultDiv = document.getElementById('fixSuggestionsResult');
            
            if (allInjectionParams.length === 0) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = 'âš ï¸ è¯·å…ˆè¿è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥';
                return;
            }
            
            let suggestions = [];
            let inconsistencies = [];
            
            // é‡æ–°è®¡ç®—ä¸ä¸€è‡´é¡¹
            allInjectionParams.forEach(param => {
                const relatedTask = allTasks.find(t => t.id === param.taskId);
                if (relatedTask && relatedTask.quantity !== param.quantity) {
                    inconsistencies.push({
                        paramId: param.id,
                        taskId: param.taskId,
                        taskCode: relatedTask.taskCode,
                        paramQuantity: param.quantity,
                        taskQuantity: relatedTask.quantity,
                        taskStatus: relatedTask.status
                    });
                }
            });
            
            if (inconsistencies.length === 0) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = 'âœ… æ•°æ®ä¸€è‡´ï¼Œæ— éœ€ä¿®å¤';
                return;
            }
            
            // ç”Ÿæˆä¿®å¤å»ºè®®
            suggestions.push('ğŸ”§ æ•°æ®ä¿®å¤å»ºè®®:\n');
            suggestions.push('1. æ‰¹é‡åŒæ­¥å·¥è‰ºå‚æ•°æ•°é‡åˆ°ä»»åŠ¡æ•°é‡');
            suggestions.push('2. æˆ–è€…æ‰¹é‡åŒæ­¥ä»»åŠ¡æ•°é‡åˆ°å·¥è‰ºå‚æ•°æ•°é‡');
            suggestions.push('3. æ‰‹åŠ¨é€ä¸ªæ£€æŸ¥å’Œä¿®å¤ä¸ä¸€è‡´é¡¹\n');
            
            suggestions.push('ğŸ“‹ å…·ä½“ä¿®å¤æ­¥éª¤:\n');
            
            // æŒ‰çŠ¶æ€åˆ†ç»„å»ºè®®
            const completedTasks = inconsistencies.filter(i => i.taskStatus === 'å·²å®Œæˆ');
            const inProgressTasks = inconsistencies.filter(i => i.taskStatus === 'è¿›è¡Œä¸­');
            const otherTasks = inconsistencies.filter(i => !['å·²å®Œæˆ', 'è¿›è¡Œä¸­'].includes(i.taskStatus));
            
            if (completedTasks.length > 0) {
                suggestions.push(`å·²å®Œæˆä»»åŠ¡ (${completedTasks.length}ä¸ª):`);
                suggestions.push('- å»ºè®®å°†å·¥è‰ºå‚æ•°æ•°é‡åŒæ­¥ä¸ºä»»åŠ¡æ•°é‡');
                suggestions.push('- å› ä¸ºä»»åŠ¡å·²å®Œæˆï¼Œä»»åŠ¡æ•°é‡åº”è¯¥æ˜¯å‡†ç¡®çš„\n');
            }
            
            if (inProgressTasks.length > 0) {
                suggestions.push(`è¿›è¡Œä¸­ä»»åŠ¡ (${inProgressTasks.length}ä¸ª):`);
                suggestions.push('- éœ€è¦äººå·¥åˆ¤æ–­å“ªä¸ªæ•°é‡æ˜¯æ­£ç¡®çš„');
                suggestions.push('- å»ºè®®æ£€æŸ¥å®é™…ç”Ÿäº§æƒ…å†µåå†³å®š\n');
            }
            
            if (otherTasks.length > 0) {
                suggestions.push(`å…¶ä»–çŠ¶æ€ä»»åŠ¡ (${otherTasks.length}ä¸ª):`);
                suggestions.push('- å»ºè®®ç»Ÿä¸€æ•°é‡æ ‡å‡†');
                suggestions.push('- å¯ä»¥æ‰¹é‡å¤„ç†\n');
            }
            
            suggestions.push('âš ï¸ ä¿®å¤å‰å»ºè®®:');
            suggestions.push('1. å¤‡ä»½å½“å‰æ•°æ®');
            suggestions.push('2. åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯ä¿®å¤é€»è¾‘');
            suggestions.push('3. é€šçŸ¥ç›¸å…³äººå‘˜æ•°æ®å˜æ›´');
            
            resultDiv.className = 'result warning';
            resultDiv.innerHTML = suggestions.join('\n');
        }
    </script>
</body>
</html>