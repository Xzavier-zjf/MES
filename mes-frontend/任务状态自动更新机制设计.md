# 任务状态自动更新机制设计

## 问题分析

### 当前状态管理问题
1. **手动状态管理**：任务状态需要用户手动在编辑对话框中修改
2. **状态与进度不同步**：进度可能达到100%，但状态仍然是"进行中"
3. **缺少自动化规则**：没有基于业务逻辑的状态自动转换机制
4. **数据不一致风险**：状态和实际完成情况可能不匹配

### 当前实现分析
```javascript
// 当前进度计算（TaskTable.vue）
function getProgress(row) {
  // 基于状态的基础进度
  const baseProgress = {
    '待下发': 0,
    '进行中': 50,
    '已完成': 100,
    '已暂停': 30
  }[row.status] || 0
  
  // 如果有实际完成数量，使用实际进度
  if (row.completedQuantity !== undefined && row.completedQuantity >= 0) {
    return Math.min(100, Math.round((row.completedQuantity / row.quantity) * 100))
  }
  
  return baseProgress
}
```

**问题**：进度计算考虑了完成数量，但状态不会自动更新

## 业务需求分析

### 状态转换规则
1. **待下发 → 进行中**：
   - 任务被分配给设备
   - 开始生产操作
   - 完成数量 > 0

2. **进行中 → 已完成**：
   - 完成数量 = 任务数量
   - 进度达到 100%
   - 质检通过（可选）

3. **进行中 → 已暂停**：
   - 设备故障
   - 材料不足
   - 人工暂停操作

4. **已暂停 → 进行中**：
   - 故障修复
   - 材料补充
   - 恢复生产

5. **任何状态 → 待下发**：
   - 重置任务
   - 重新分配

## 设计方案

### 方案一：基于完成数量的自动状态更新

#### 1. 状态自动更新规则
```javascript
function calculateAutoStatus(task) {
  const { status, quantity, completedQuantity = 0 } = task
  
  // 如果完成数量达到任务数量，自动设为已完成
  if (completedQuantity >= quantity && quantity > 0) {
    return '已完成'
  }
  
  // 如果有完成数量但未完成，且当前不是暂停状态，设为进行中
  if (completedQuantity > 0 && completedQuantity < quantity && status !== '已暂停') {
    return '进行中'
  }
  
  // 如果没有完成数量，保持原状态或设为待下发
  if (completedQuantity === 0) {
    return status === '已暂停' ? '已暂停' : '待下发'
  }
  
  return status // 保持原状态
}
```

#### 2. 状态更新触发时机
- **数量更新时**：任务数量或完成数量变更时
- **进度更新时**：生产过程中实时更新
- **定时检查**：定期检查状态一致性
- **手动触发**：用户手动刷新状态

### 方案二：增强的状态管理系统

#### 1. 状态机模式
```javascript
class TaskStatusManager {
  constructor() {
    this.statusTransitions = {
      '待下发': ['进行中', '已暂停'],
      '进行中': ['已完成', '已暂停', '待下发'],
      '已完成': ['待下发'], // 允许重置
      '已暂停': ['进行中', '待下发']
    }
  }
  
  canTransition(fromStatus, toStatus) {
    return this.statusTransitions[fromStatus]?.includes(toStatus) || false
  }
  
  autoUpdateStatus(task) {
    const suggestedStatus = this.calculateSuggestedStatus(task)
    if (suggestedStatus !== task.status && this.canTransition(task.status, suggestedStatus)) {
      return suggestedStatus
    }
    return task.status
  }
  
  calculateSuggestedStatus(task) {
    const { quantity, completedQuantity = 0, deviceStatus } = task
    
    // 完成数量达到任务数量
    if (completedQuantity >= quantity && quantity > 0) {
      return '已完成'
    }
    
    // 设备故障或维护
    if (deviceStatus === '故障' || deviceStatus === '维护') {
      return '已暂停'
    }
    
    // 有生产进度
    if (completedQuantity > 0) {
      return '进行中'
    }
    
    return '待下发'
  }
}
```

#### 2. 状态更新API
```javascript
// 新增状态更新API
export const updateTaskStatus = async (taskId, newStatus, reason = '') => {
  try {
    const response = await request.put(`/api/v1/production/tasks/${taskId}/status`, {
      status: newStatus,
      reason: reason,
      timestamp: new Date().toISOString()
    })
    return response
  } catch (error) {
    throw new Error('更新任务状态失败: ' + error.message)
  }
}

// 批量状态更新
export const batchUpdateTaskStatus = async (updates) => {
  try {
    const response = await request.put('/api/v1/production/tasks/batch-status', {
      updates: updates
    })
    return response
  } catch (error) {
    throw new Error('批量更新任务状态失败: ' + error.message)
  }
}
```

## 实施方案

### 阶段一：基础自动状态更新 ✅

#### 1. 添加状态计算逻辑 ✅
```javascript
// TaskTable.vue 中添加状态建议
function getSuggestedStatus(row) {
  const { status, quantity, completedQuantity = 0 } = row
  
  if (completedQuantity >= quantity && quantity > 0) {
    return '已完成'
  }
  
  if (completedQuantity > 0 && completedQuantity < quantity && status !== '已暂停') {
    return '进行中'
  }
  
  if (completedQuantity === 0) {
    return status === '已暂停' ? '已暂停' : '待下发'
  }
  
  return status
}

// 检查状态是否需要更新
function needsStatusUpdate(row) {
  const suggestedStatus = getSuggestedStatus(row)
  return suggestedStatus !== row.status
}
```

## 已完成的实施内容

### ✅ 核心功能实现
1. **状态建议逻辑**：在 TaskTable.vue 中实现状态计算和建议功能
2. **状态更新 API**：在 tasks.js 中添加 `updateTaskStatus` 和 `batchUpdateTaskStatus` 方法
3. **用户交互界面**：在任务表格中显示状态建议按钮
4. **自动状态更新**：完成数量达到100%时自动设为已完成
5. **事件通知机制**：状态更新后发送跨页面同步事件

### ✅ 用户体验优化
1. **视觉提示**：需要状态更新的任务显示警告图标
2. **确认对话框**：状态更新前显示详细的确认信息
3. **自动刷新**：状态更新后自动刷新任务列表
4. **事件同步**：跨页面的状态更新通知

### 🧪 测试工具
- **`test-status-update.html`**：完整的状态更新测试工具
- **状态转换规则测试**：验证各种状态转换场景
- **实际API测试**：测试真实的状态更新操作
- **事件监听测试**：验证状态更新事件机制

#### 2. 状态更新提示
```javascript
// 在表格中显示状态建议
<el-table-column label="状态" width="150" align="center">
  <template #default="{ row }">
    <div class="status-container">
      <span :class="`status-badge status-${getStatusClass(row.status)}`">
        {{ row.status }}
      </span>
      <el-tooltip 
        v-if="needsStatusUpdate(row)" 
        content="建议更新状态" 
        placement="top"
      >
        <el-button 
          size="small" 
          type="warning" 
          icon="Warning"
          @click="suggestStatusUpdate(row)"
        />
      </el-tooltip>
    </div>
  </template>
</el-table-column>
```

#### 3. 自动状态更新功能
```javascript
// TaskManager.vue 中添加状态更新方法
const suggestStatusUpdate = async (task) => {
  const suggestedStatus = getSuggestedStatus(task)
  
  try {
    const result = await ElMessageBox.confirm(
      `建议将任务 ${task.taskCode} 的状态从 "${task.status}" 更新为 "${suggestedStatus}"？\n\n` +
      `原因：${getStatusUpdateReason(task, suggestedStatus)}`,
      '状态更新建议',
      {
        confirmButtonText: '更新状态',
        cancelButtonText: '保持现状',
        type: 'info'
      }
    )
    
    if (result) {
      await updateTaskStatus(task.id, suggestedStatus, 'auto-suggestion')
      await filterTasks() // 刷新任务列表
      ElMessage.success('任务状态更新成功')
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('状态更新失败: ' + error.message)
    }
  }
}

const getStatusUpdateReason = (task, suggestedStatus) => {
  const { quantity, completedQuantity = 0 } = task
  
  if (suggestedStatus === '已完成') {
    return `完成数量 ${completedQuantity} 已达到任务数量 ${quantity}`
  }
  
  if (suggestedStatus === '进行中') {
    return `已有生产进度 ${completedQuantity}/${quantity}`
  }
  
  if (suggestedStatus === '待下发') {
    return '尚未开始生产'
  }
  
  return '基于当前进度的建议'
}
```

### 阶段二：智能状态管理

#### 1. 状态管理器集成
```javascript
// 创建状态管理器实例
import { TaskStatusManager } from '@/utils/taskStatusManager'

const statusManager = new TaskStatusManager()

// 在任务数据更新时检查状态
const checkAndUpdateTaskStatus = async (task) => {
  const suggestedStatus = statusManager.autoUpdateStatus(task)
  
  if (suggestedStatus !== task.status) {
    // 可以选择自动更新或提示用户
    if (shouldAutoUpdate(task, suggestedStatus)) {
      await updateTaskStatus(task.id, suggestedStatus, 'auto-update')
    } else {
      // 显示状态更新建议
      showStatusSuggestion(task, suggestedStatus)
    }
  }
}

const shouldAutoUpdate = (task, suggestedStatus) => {
  // 定义自动更新的条件
  return (
    // 完成数量达到100%时自动设为已完成
    (suggestedStatus === '已完成' && task.completedQuantity >= task.quantity) ||
    // 开始生产时自动设为进行中
    (suggestedStatus === '进行中' && task.status === '待下发' && task.completedQuantity > 0)
  )
}
```

#### 2. 批量状态检查
```javascript
// 批量检查和更新状态
const batchCheckTaskStatus = async () => {
  const tasksNeedingUpdate = []
  
  tasks.value.forEach(task => {
    const suggestedStatus = statusManager.autoUpdateStatus(task)
    if (suggestedStatus !== task.status && shouldAutoUpdate(task, suggestedStatus)) {
      tasksNeedingUpdate.push({
        taskId: task.id,
        currentStatus: task.status,
        suggestedStatus: suggestedStatus,
        reason: getStatusUpdateReason(task, suggestedStatus)
      })
    }
  })
  
  if (tasksNeedingUpdate.length > 0) {
    try {
      await batchUpdateTaskStatus(tasksNeedingUpdate)
      await filterTasks() // 刷新任务列表
      ElMessage.success(`批量更新了 ${tasksNeedingUpdate.length} 个任务的状态`)
    } catch (error) {
      ElMessage.error('批量状态更新失败: ' + error.message)
    }
  }
}
```

### 阶段三：用户体验优化

#### 1. 状态变更历史
```javascript
// 状态变更记录
const statusHistory = ref([])

const recordStatusChange = (taskId, fromStatus, toStatus, reason) => {
  statusHistory.value.push({
    taskId,
    fromStatus,
    toStatus,
    reason,
    timestamp: new Date(),
    user: getCurrentUser()
  })
}
```

#### 2. 状态同步通知
```javascript
// 状态更新后的同步通知
const notifyStatusUpdate = (taskId, newStatus) => {
  // 发送跨页面同步事件
  window.dispatchEvent(new CustomEvent('task-status-updated', {
    detail: { 
      taskId, 
      newStatus, 
      timestamp: Date.now(),
      source: 'task-manager'
    }
  }))
}
```

## 配置选项

### 用户偏好设置
```javascript
const statusUpdateSettings = ref({
  autoUpdateCompleted: true,    // 自动设置已完成状态
  autoUpdateInProgress: true,   // 自动设置进行中状态
  showSuggestions: true,        // 显示状态建议
  batchUpdateInterval: 300000,  // 批量检查间隔（5分钟）
  confirmBeforeUpdate: false    // 更新前确认
})
```

## 测试验证

### 测试场景
1. **完成数量达到任务数量**：状态应自动或建议更新为"已完成"
2. **开始生产**：状态应从"待下发"更新为"进行中"
3. **设备故障**：状态应更新为"已暂停"
4. **恢复生产**：状态应从"已暂停"更新为"进行中"
5. **批量状态检查**：多个任务的状态应正确更新

### 测试工具
创建专门的状态更新测试页面，验证各种状态转换场景。

## 总结

通过实施智能的任务状态自动更新机制，可以：
1. **提高数据准确性**：状态与实际进度保持同步
2. **减少人工操作**：自动化状态管理
3. **改善用户体验**：智能提示和建议
4. **增强系统可靠性**：一致的状态管理规则

建议采用渐进式实施，先实现基础的自动状态更新，再逐步增加智能化功能。