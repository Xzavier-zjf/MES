<!DOCTYPE html>
<html>
<head>
    <title>任务数量更新功能测试</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input, select { padding: 5px; margin: 5px; width: 200px; }
        label { display: inline-block; width: 120px; }
        .feature-demo { background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>任务数量更新功能测试</h1>
    
    <div class="feature-demo">
        <h3>🎯 新功能说明</h3>
        <ul>
            <li><strong>编辑模式增强</strong>：在编辑工艺参数时可以同时更新任务数量</li>
            <li><strong>数量同步</strong>：支持将任务数量同步到工艺参数数量</li>
            <li><strong>权限控制</strong>：只有有权限的用户才能修改任务数量</li>
            <li><strong>确认机制</strong>：更新任务数量前会显示确认对话框</li>
            <li><strong>影响提示</strong>：提醒用户更新任务数量可能影响其他工艺参数</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>1. 获取任务列表</h3>
        <button onclick="fetchTasks()">获取任务列表</button>
        <div id="tasksList" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. 测试任务数量更新</h3>
        <div>
            <label>任务ID: <input type="text" id="taskId" placeholder="输入任务ID"></label><br>
            <label>新数量: <input type="number" id="newQuantity" placeholder="输入新数量" min="1"></label><br>
        </div>
        <button onclick="testUpdateTaskQuantity()">测试更新任务数量</button>
        <div id="updateResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. 获取注塑参数列表</h3>
        <button onclick="fetchInjectionParams()">获取注塑参数列表</button>
        <div id="paramsList" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. 功能演示场景</h3>
        <div class="feature-demo">
            <h4>典型使用场景：</h4>
            <ol>
                <li>在注塑工艺参数页面点击"录入工艺"按钮</li>
                <li>在编辑对话框中看到当前任务数量</li>
                <li>修改任务数量并勾选"同时更新任务数量"</li>
                <li>点击"更新工艺参数"按钮</li>
                <li>系统显示确认对话框</li>
                <li>确认后同时更新工艺参数和任务数量</li>
            </ol>
        </div>
        <button onclick="simulateWorkflow()">模拟完整工作流程</button>
        <div id="workflowResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        async function fetchTasks() {
            const resultDiv = document.getElementById('tasksList');
            
            try {
                resultDiv.innerHTML = '获取任务列表中...';
                
                const response = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=10`);
                const responseData = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✅ 获取成功!\n\n' + JSON.stringify(responseData, null, 2);
                    
                    // 自动填充第一个任务ID
                    if (responseData.content && responseData.content.length > 0) {
                        document.getElementById('taskId').value = responseData.content[0].id;
                        document.getElementById('newQuantity').value = (responseData.content[0].quantity || 100) + 50;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ 获取失败!\n\n状态码: ' + response.status + 
                                         '\n\n错误响应:\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 网络错误!\n\n' + error.message;
            }
        }
        
        async function testUpdateTaskQuantity() {
            const taskId = document.getElementById('taskId').value;
            const newQuantity = parseInt(document.getElementById('newQuantity').value);
            const resultDiv = document.getElementById('updateResult');
            
            if (!taskId || !newQuantity) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 请输入任务ID和新数量';
                return;
            }
            
            try {
                resultDiv.innerHTML = '更新任务数量中...';
                
                const response = await fetch(`${API_BASE}/api/v1/production/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quantity: newQuantity
                    })
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✅ 任务数量更新成功!\n\n' +
                                         `任务ID: ${taskId}\n` +
                                         `新数量: ${newQuantity}\n\n` +
                                         '响应数据:\n' + JSON.stringify(responseData, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ 更新失败!\n\n状态码: ' + response.status + 
                                         '\n\n错误响应:\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 网络错误!\n\n' + error.message;
            }
        }
        
        async function fetchInjectionParams() {
            const resultDiv = document.getElementById('paramsList');
            
            try {
                resultDiv.innerHTML = '获取注塑参数列表中...';
                
                const response = await fetch(`${API_BASE}/api/v1/process/injection-params/all?page=0&size=10`);
                const responseData = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✅ 获取成功!\n\n' + JSON.stringify(responseData, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ 获取失败!\n\n状态码: ' + response.status + 
                                         '\n\n错误响应:\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 网络错误!\n\n' + error.message;
            }
        }
        
        async function simulateWorkflow() {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.innerHTML = '🔄 模拟工作流程...\n\n';
            
            const steps = [
                '1. 用户在注塑工艺参数页面点击"录入工艺"',
                '2. 系统打开编辑对话框，显示当前任务信息',
                '3. 用户看到任务数量字段和工艺参数数量',
                '4. 用户修改任务数量并勾选"同时更新任务数量"',
                '5. 用户点击"更新工艺参数"按钮',
                '6. 系统显示确认对话框：确认更新任务数量',
                '7. 用户确认后，系统先更新任务数量',
                '8. 然后更新工艺参数',
                '9. 显示成功消息：工艺参数和任务数量更新成功',
                '10. 刷新页面数据，显示最新的数量信息'
            ];
            
            for (let i = 0; i < steps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                resultDiv.innerHTML += steps[i] + '\n';
                resultDiv.scrollTop = resultDiv.scrollHeight;
            }
            
            resultDiv.innerHTML += '\n✅ 工作流程模拟完成！\n\n';
            resultDiv.innerHTML += '💡 提示：\n';
            resultDiv.innerHTML += '- 实际使用时会有用户交互确认\n';
            resultDiv.innerHTML += '- 权限控制会限制谁可以修改任务数量\n';
            resultDiv.innerHTML += '- 数据验证会确保数量的合理性\n';
            resultDiv.innerHTML += '- 错误处理会提供友好的错误提示\n';
            
            resultDiv.className = 'result success';
        }
    </script>
</body>
</html>