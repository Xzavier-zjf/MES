<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能切换最终测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .title {
            color: #67c23a;
            border-bottom: 2px solid #67c23a;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .test-item.success {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        .test-item.error {
            border-color: #f56c6c;
            background: #fef0f0;
        }
        .image-preview {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .status-success {
            background: #67c23a;
            color: white;
        }
        .status-error {
            background: #f56c6c;
            color: white;
        }
        .status-loading {
            background: #e6a23c;
            color: white;
        }
        .path-info {
            font-family: monospace;
            font-size: 11px;
            color: #666;
            word-break: break-all;
            margin: 5px 0;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #337ecc;
        }
        button.success {
            background: #67c23a;
        }
        .summary {
            background: linear-gradient(135deg, #67c23a 0%, #5dade2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .comparison-item {
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .comparison-before {
            background: #fef0f0;
            border: 1px solid #f56c6c;
        }
        .comparison-after {
            background: #f0f9ff;
            border: 1px solid #67c23a;
        }
    </style>
</head>
<body>
    <h1>🎯 智能切换最终测试</h1>
    
    <div class="container">
        <h2 class="title">修复方案说明</h2>
        <p><strong>问题：</strong>JPG/PNG文件包含SVG内容，但Content-Type不匹配，导致浏览器无法显示。</p>
        <p><strong>解决方案：</strong>前端智能检测JPG/PNG路径，自动切换到对应的SVG版本文件。</p>
        
        <div class="comparison">
            <div class="comparison-item comparison-before">
                <strong>修复前：</strong><br>
                选择 test-pattern-1.jpg → 显示"暂无图片"
            </div>
            <div class="comparison-item comparison-after">
                <strong>修复后：</strong><br>
                选择 test-pattern-1.jpg → 自动切换到 test-pattern-1.svg → 正常显示
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="title">智能切换测试</h2>
        <p>测试JPG/PNG路径是否能自动切换到SVG版本并正常显示。</p>
        
        <button onclick="runSmartSwitchingTest()" class="success">🚀 运行智能切换测试</button>
        <button onclick="clearResults()">清除结果</button>
        
        <div id="testResults" class="test-grid"></div>
    </div>

    <div id="summary" class="summary" style="display: none;">
        <h3>测试结果</h3>
        <div id="summaryContent"></div>
    </div>

    <script>
        // 测试路径列表（模拟PatternManager.vue中的预定义路径）
        const testPaths = [
            {
                name: 'JPG测试图案1',
                originalPath: '/uploads/patterns/test-pattern-1.jpg',
                expectedSvgPath: '/uploads/patterns/test-pattern-1.svg',
                description: 'JPG路径应自动切换到SVG'
            },
            {
                name: 'PNG测试图案2',
                originalPath: '/uploads/patterns/test-pattern-2.png',
                expectedSvgPath: '/uploads/patterns/test-pattern-2.svg',
                description: 'PNG路径应自动切换到SVG'
            },
            {
                name: 'JPG几何图案',
                originalPath: '/uploads/patterns/geometric-pattern.jpg',
                expectedSvgPath: '/uploads/patterns/geometric-pattern.svg',
                description: 'JPG几何图案切换测试'
            },
            {
                name: 'JPG大理石纹理',
                originalPath: '/uploads/patterns/marble-texture.jpg',
                expectedSvgPath: '/uploads/patterns/marble-texture.svg',
                description: 'JPG大理石纹理切换测试'
            },
            {
                name: 'SVG原生文件',
                originalPath: '/uploads/patterns/test-pattern-1.svg',
                expectedSvgPath: '/uploads/patterns/test-pattern-1.svg',
                description: 'SVG文件应保持不变'
            }
        ];

        let testStats = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // 模拟getImageUrl函数
        function getImageUrl(path) {
            if (!path) return ''
            
            if (path.startsWith('http://') || path.startsWith('https://')) {
                return path
            }
            
            const baseUrl = 'http://localhost:8080'
            let processedPath = path
            
            if (path.startsWith('/uploads/')) {
                processedPath = path
            } else if (path.startsWith('/')) {
                processedPath = path
            } else {
                processedPath = `/uploads/patterns/${path}`
            }
            
            const pathParts = processedPath.split('/')
            const encodedParts = pathParts.map((part, index) => {
                if (index === pathParts.length - 1 && part) {
                    return encodeURIComponent(part)
                }
                return part
            })
            
            const encodedPath = encodedParts.join('/')
            return `${baseUrl}/api${encodedPath}`
        }

        // 智能切换函数（与PatternManager.vue中的实现一致）
        function getSmartImageUrl(path) {
            if (!path) return ''
            
            // 如果是JPG/PNG格式，尝试对应的SVG版本
            if (path.endsWith('.jpg') || path.endsWith('.png')) {
                const svgPath = path.replace(/\.(jpg|png)$/i, '.svg')
                console.log(`智能切换JPG/PNG到SVG: ${path} -> ${svgPath}`)
                return getImageUrl(svgPath)
            }
            
            return getImageUrl(path)
        }

        function createTestItem(testData) {
            const item = document.createElement('div');
            item.className = 'test-item';
            
            const title = document.createElement('h4');
            title.textContent = testData.name;
            title.style.margin = '0 0 10px 0';
            
            const description = document.createElement('p');
            description.textContent = testData.description;
            description.style.fontSize = '12px';
            description.style.color = '#666';
            description.style.margin = '0 0 10px 0';
            
            const badge = document.createElement('div');
            badge.className = 'status-badge status-loading';
            badge.textContent = '测试中...';
            
            const originalPathInfo = document.createElement('div');
            originalPathInfo.className = 'path-info';
            originalPathInfo.textContent = `原始路径: ${testData.originalPath}`;
            
            const smartPathInfo = document.createElement('div');
            smartPathInfo.className = 'path-info';
            
            const urlInfo = document.createElement('div');
            urlInfo.className = 'path-info';
            
            const img = document.createElement('img');
            img.className = 'image-preview';
            img.alt = testData.name;
            
            item.appendChild(title);
            item.appendChild(description);
            item.appendChild(badge);
            item.appendChild(originalPathInfo);
            item.appendChild(smartPathInfo);
            item.appendChild(urlInfo);
            item.appendChild(img);
            
            return { item, badge, smartPathInfo, urlInfo, img };
        }

        async function testSinglePath(testData, container) {
            const { item, badge, smartPathInfo, urlInfo, img } = createTestItem(testData);
            container.appendChild(item);
            
            testStats.total++;
            
            try {
                // 使用智能切换生成URL
                const smartUrl = getSmartImageUrl(testData.originalPath);
                const expectedUrl = getImageUrl(testData.expectedSvgPath);
                
                smartPathInfo.textContent = `智能切换路径: ${testData.originalPath.endsWith('.svg') ? testData.originalPath : testData.originalPath.replace(/\.(jpg|png)$/i, '.svg')}`;
                urlInfo.textContent = `生成URL: ${smartUrl}`;
                
                console.log(`测试: ${testData.name}`);
                console.log(`原始路径: ${testData.originalPath}`);
                console.log(`智能切换URL: ${smartUrl}`);
                console.log(`期望URL: ${expectedUrl}`);
                
                // 验证URL是否正确切换
                const urlCorrect = smartUrl === expectedUrl;
                
                if (!urlCorrect) {
                    badge.textContent = '❌ URL切换错误';
                    badge.className = 'status-badge status-error';
                    item.className = 'test-item error';
                    testStats.failed++;
                    return;
                }
                
                // 测试图片是否可以加载
                const response = await fetch(smartUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    // 图片可访问，尝试显示
                    img.src = smartUrl;
                    
                    // 等待图片加载
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('加载超时'));
                        }, 5000);
                        
                        img.onload = () => {
                            clearTimeout(timeout);
                            badge.textContent = '✅ 智能切换成功';
                            badge.className = 'status-badge status-success';
                            item.className = 'test-item success';
                            testStats.passed++;
                            console.log(`✅ ${testData.name} 智能切换成功`);
                            resolve();
                        };
                        
                        img.onerror = () => {
                            clearTimeout(timeout);
                            badge.textContent = '❌ 图片显示失败';
                            badge.className = 'status-badge status-error';
                            item.className = 'test-item error';
                            testStats.failed++;
                            console.log(`❌ ${testData.name} 图片显示失败`);
                            reject(new Error('图片显示失败'));
                        };
                    }).catch(error => {
                        console.warn(`智能切换问题: ${testData.name} - ${error.message}`);
                    });
                    
                } else {
                    // 图片不可访问
                    badge.textContent = `❌ HTTP ${response.status}`;
                    badge.className = 'status-badge status-error';
                    item.className = 'test-item error';
                    testStats.failed++;
                    console.log(`❌ ${testData.name} HTTP错误: ${response.status}`);
                }
                
            } catch (error) {
                // 网络错误
                badge.textContent = '❌ 网络错误';
                badge.className = 'status-badge status-error';
                item.className = 'test-item error';
                testStats.failed++;
                console.log(`❌ ${testData.name} 网络错误: ${error.message}`);
            }
        }

        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const successRate = testStats.total > 0 ? Math.round((testStats.passed / testStats.total) * 100) : 0;
            
            let resultText = '';
            let resultColor = '';
            
            if (successRate === 100) {
                resultText = '🎉 所有智能切换测试通过！JPG/PNG路径问题已完全解决！';
                resultColor = '#67c23a';
            } else if (successRate >= 80) {
                resultText = '✅ 大部分智能切换正常，基本解决JPG/PNG显示问题';
                resultColor = '#e6a23c';
            } else {
                resultText = '❌ 智能切换存在问题，需要进一步调试';
                resultColor = '#f56c6c';
            }
            
            summaryContent.innerHTML = `
                <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                    <div><span style="font-size: 24px; font-weight: bold;">${testStats.total}</span><br>总测试数</div>
                    <div><span style="font-size: 24px; font-weight: bold;">${testStats.passed}</span><br>通过测试</div>
                    <div><span style="font-size: 24px; font-weight: bold;">${testStats.failed}</span><br>失败测试</div>
                    <div><span style="font-size: 24px; font-weight: bold;">${successRate}%</span><br>成功率</div>
                </div>
                <div style="font-size: 18px; font-weight: bold; color: ${resultColor};">
                    ${resultText}
                </div>
                <div style="margin-top: 15px; font-size: 14px;">
                    现在在图案管理页面选择JPG/PNG路径时，系统会自动切换到对应的SVG版本文件
                </div>
            `;
            
            document.getElementById('summary').style.display = 'block';
        }

        async function runSmartSwitchingTest() {
            const container = document.getElementById('testResults');
            container.innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            // 重置统计
            testStats = { total: 0, passed: 0, failed: 0 };
            
            console.log('开始运行智能切换测试...');
            
            for (const testData of testPaths) {
                await testSinglePath(testData, container);
                // 添加延迟避免请求过快
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            updateSummary();
            console.log('智能切换测试完成');
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testStats = { total: 0, passed: 0, failed: 0 };
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 智能切换最终测试工具已加载');
            console.log('这个测试将验证JPG/PNG路径是否能自动切换到SVG版本');
            
            // 3秒后自动运行测试
            setTimeout(() => {
                console.log('自动开始智能切换测试...');
                runSmartSwitchingTest();
            }, 2000);
        });
    </script>
</body>
</html>