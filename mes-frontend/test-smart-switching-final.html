<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ‡æ¢æœ€ç»ˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .title {
            color: #67c23a;
            border-bottom: 2px solid #67c23a;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .test-item.success {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        .test-item.error {
            border-color: #f56c6c;
            background: #fef0f0;
        }
        .image-preview {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .status-success {
            background: #67c23a;
            color: white;
        }
        .status-error {
            background: #f56c6c;
            color: white;
        }
        .status-loading {
            background: #e6a23c;
            color: white;
        }
        .path-info {
            font-family: monospace;
            font-size: 11px;
            color: #666;
            word-break: break-all;
            margin: 5px 0;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #337ecc;
        }
        button.success {
            background: #67c23a;
        }
        .summary {
            background: linear-gradient(135deg, #67c23a 0%, #5dade2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .comparison-item {
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .comparison-before {
            background: #fef0f0;
            border: 1px solid #f56c6c;
        }
        .comparison-after {
            background: #f0f9ff;
            border: 1px solid #67c23a;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ æ™ºèƒ½åˆ‡æ¢æœ€ç»ˆæµ‹è¯•</h1>
    
    <div class="container">
        <h2 class="title">ä¿®å¤æ–¹æ¡ˆè¯´æ˜</h2>
        <p><strong>é—®é¢˜ï¼š</strong>JPG/PNGæ–‡ä»¶åŒ…å«SVGå†…å®¹ï¼Œä½†Content-Typeä¸åŒ¹é…ï¼Œå¯¼è‡´æµè§ˆå™¨æ— æ³•æ˜¾ç¤ºã€‚</p>
        <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong>å‰ç«¯æ™ºèƒ½æ£€æµ‹JPG/PNGè·¯å¾„ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”çš„SVGç‰ˆæœ¬æ–‡ä»¶ã€‚</p>
        
        <div class="comparison">
            <div class="comparison-item comparison-before">
                <strong>ä¿®å¤å‰ï¼š</strong><br>
                é€‰æ‹© test-pattern-1.jpg â†’ æ˜¾ç¤º"æš‚æ— å›¾ç‰‡"
            </div>
            <div class="comparison-item comparison-after">
                <strong>ä¿®å¤åï¼š</strong><br>
                é€‰æ‹© test-pattern-1.jpg â†’ è‡ªåŠ¨åˆ‡æ¢åˆ° test-pattern-1.svg â†’ æ­£å¸¸æ˜¾ç¤º
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="title">æ™ºèƒ½åˆ‡æ¢æµ‹è¯•</h2>
        <p>æµ‹è¯•JPG/PNGè·¯å¾„æ˜¯å¦èƒ½è‡ªåŠ¨åˆ‡æ¢åˆ°SVGç‰ˆæœ¬å¹¶æ­£å¸¸æ˜¾ç¤ºã€‚</p>
        
        <button onclick="runSmartSwitchingTest()" class="success">ğŸš€ è¿è¡Œæ™ºèƒ½åˆ‡æ¢æµ‹è¯•</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        
        <div id="testResults" class="test-grid"></div>
    </div>

    <div id="summary" class="summary" style="display: none;">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="summaryContent"></div>
    </div>

    <script>
        // æµ‹è¯•è·¯å¾„åˆ—è¡¨ï¼ˆæ¨¡æ‹ŸPatternManager.vueä¸­çš„é¢„å®šä¹‰è·¯å¾„ï¼‰
        const testPaths = [
            {
                name: 'JPGæµ‹è¯•å›¾æ¡ˆ1',
                originalPath: '/uploads/patterns/test-pattern-1.jpg',
                expectedSvgPath: '/uploads/patterns/test-pattern-1.svg',
                description: 'JPGè·¯å¾„åº”è‡ªåŠ¨åˆ‡æ¢åˆ°SVG'
            },
            {
                name: 'PNGæµ‹è¯•å›¾æ¡ˆ2',
                originalPath: '/uploads/patterns/test-pattern-2.png',
                expectedSvgPath: '/uploads/patterns/test-pattern-2.svg',
                description: 'PNGè·¯å¾„åº”è‡ªåŠ¨åˆ‡æ¢åˆ°SVG'
            },
            {
                name: 'JPGå‡ ä½•å›¾æ¡ˆ',
                originalPath: '/uploads/patterns/geometric-pattern.jpg',
                expectedSvgPath: '/uploads/patterns/geometric-pattern.svg',
                description: 'JPGå‡ ä½•å›¾æ¡ˆåˆ‡æ¢æµ‹è¯•'
            },
            {
                name: 'JPGå¤§ç†çŸ³çº¹ç†',
                originalPath: '/uploads/patterns/marble-texture.jpg',
                expectedSvgPath: '/uploads/patterns/marble-texture.svg',
                description: 'JPGå¤§ç†çŸ³çº¹ç†åˆ‡æ¢æµ‹è¯•'
            },
            {
                name: 'SVGåŸç”Ÿæ–‡ä»¶',
                originalPath: '/uploads/patterns/test-pattern-1.svg',
                expectedSvgPath: '/uploads/patterns/test-pattern-1.svg',
                description: 'SVGæ–‡ä»¶åº”ä¿æŒä¸å˜'
            }
        ];

        let testStats = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // æ¨¡æ‹ŸgetImageUrlå‡½æ•°
        function getImageUrl(path) {
            if (!path) return ''
            
            if (path.startsWith('http://') || path.startsWith('https://')) {
                return path
            }
            
            const baseUrl = 'http://localhost:8080'
            let processedPath = path
            
            if (path.startsWith('/uploads/')) {
                processedPath = path
            } else if (path.startsWith('/')) {
                processedPath = path
            } else {
                processedPath = `/uploads/patterns/${path}`
            }
            
            const pathParts = processedPath.split('/')
            const encodedParts = pathParts.map((part, index) => {
                if (index === pathParts.length - 1 && part) {
                    return encodeURIComponent(part)
                }
                return part
            })
            
            const encodedPath = encodedParts.join('/')
            return `${baseUrl}/api${encodedPath}`
        }

        // æ™ºèƒ½åˆ‡æ¢å‡½æ•°ï¼ˆä¸PatternManager.vueä¸­çš„å®ç°ä¸€è‡´ï¼‰
        function getSmartImageUrl(path) {
            if (!path) return ''
            
            // å¦‚æœæ˜¯JPG/PNGæ ¼å¼ï¼Œå°è¯•å¯¹åº”çš„SVGç‰ˆæœ¬
            if (path.endsWith('.jpg') || path.endsWith('.png')) {
                const svgPath = path.replace(/\.(jpg|png)$/i, '.svg')
                console.log(`æ™ºèƒ½åˆ‡æ¢JPG/PNGåˆ°SVG: ${path} -> ${svgPath}`)
                return getImageUrl(svgPath)
            }
            
            return getImageUrl(path)
        }

        function createTestItem(testData) {
            const item = document.createElement('div');
            item.className = 'test-item';
            
            const title = document.createElement('h4');
            title.textContent = testData.name;
            title.style.margin = '0 0 10px 0';
            
            const description = document.createElement('p');
            description.textContent = testData.description;
            description.style.fontSize = '12px';
            description.style.color = '#666';
            description.style.margin = '0 0 10px 0';
            
            const badge = document.createElement('div');
            badge.className = 'status-badge status-loading';
            badge.textContent = 'æµ‹è¯•ä¸­...';
            
            const originalPathInfo = document.createElement('div');
            originalPathInfo.className = 'path-info';
            originalPathInfo.textContent = `åŸå§‹è·¯å¾„: ${testData.originalPath}`;
            
            const smartPathInfo = document.createElement('div');
            smartPathInfo.className = 'path-info';
            
            const urlInfo = document.createElement('div');
            urlInfo.className = 'path-info';
            
            const img = document.createElement('img');
            img.className = 'image-preview';
            img.alt = testData.name;
            
            item.appendChild(title);
            item.appendChild(description);
            item.appendChild(badge);
            item.appendChild(originalPathInfo);
            item.appendChild(smartPathInfo);
            item.appendChild(urlInfo);
            item.appendChild(img);
            
            return { item, badge, smartPathInfo, urlInfo, img };
        }

        async function testSinglePath(testData, container) {
            const { item, badge, smartPathInfo, urlInfo, img } = createTestItem(testData);
            container.appendChild(item);
            
            testStats.total++;
            
            try {
                // ä½¿ç”¨æ™ºèƒ½åˆ‡æ¢ç”ŸæˆURL
                const smartUrl = getSmartImageUrl(testData.originalPath);
                const expectedUrl = getImageUrl(testData.expectedSvgPath);
                
                smartPathInfo.textContent = `æ™ºèƒ½åˆ‡æ¢è·¯å¾„: ${testData.originalPath.endsWith('.svg') ? testData.originalPath : testData.originalPath.replace(/\.(jpg|png)$/i, '.svg')}`;
                urlInfo.textContent = `ç”ŸæˆURL: ${smartUrl}`;
                
                console.log(`æµ‹è¯•: ${testData.name}`);
                console.log(`åŸå§‹è·¯å¾„: ${testData.originalPath}`);
                console.log(`æ™ºèƒ½åˆ‡æ¢URL: ${smartUrl}`);
                console.log(`æœŸæœ›URL: ${expectedUrl}`);
                
                // éªŒè¯URLæ˜¯å¦æ­£ç¡®åˆ‡æ¢
                const urlCorrect = smartUrl === expectedUrl;
                
                if (!urlCorrect) {
                    badge.textContent = 'âŒ URLåˆ‡æ¢é”™è¯¯';
                    badge.className = 'status-badge status-error';
                    item.className = 'test-item error';
                    testStats.failed++;
                    return;
                }
                
                // æµ‹è¯•å›¾ç‰‡æ˜¯å¦å¯ä»¥åŠ è½½
                const response = await fetch(smartUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    // å›¾ç‰‡å¯è®¿é—®ï¼Œå°è¯•æ˜¾ç¤º
                    img.src = smartUrl;
                    
                    // ç­‰å¾…å›¾ç‰‡åŠ è½½
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('åŠ è½½è¶…æ—¶'));
                        }, 5000);
                        
                        img.onload = () => {
                            clearTimeout(timeout);
                            badge.textContent = 'âœ… æ™ºèƒ½åˆ‡æ¢æˆåŠŸ';
                            badge.className = 'status-badge status-success';
                            item.className = 'test-item success';
                            testStats.passed++;
                            console.log(`âœ… ${testData.name} æ™ºèƒ½åˆ‡æ¢æˆåŠŸ`);
                            resolve();
                        };
                        
                        img.onerror = () => {
                            clearTimeout(timeout);
                            badge.textContent = 'âŒ å›¾ç‰‡æ˜¾ç¤ºå¤±è´¥';
                            badge.className = 'status-badge status-error';
                            item.className = 'test-item error';
                            testStats.failed++;
                            console.log(`âŒ ${testData.name} å›¾ç‰‡æ˜¾ç¤ºå¤±è´¥`);
                            reject(new Error('å›¾ç‰‡æ˜¾ç¤ºå¤±è´¥'));
                        };
                    }).catch(error => {
                        console.warn(`æ™ºèƒ½åˆ‡æ¢é—®é¢˜: ${testData.name} - ${error.message}`);
                    });
                    
                } else {
                    // å›¾ç‰‡ä¸å¯è®¿é—®
                    badge.textContent = `âŒ HTTP ${response.status}`;
                    badge.className = 'status-badge status-error';
                    item.className = 'test-item error';
                    testStats.failed++;
                    console.log(`âŒ ${testData.name} HTTPé”™è¯¯: ${response.status}`);
                }
                
            } catch (error) {
                // ç½‘ç»œé”™è¯¯
                badge.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                badge.className = 'status-badge status-error';
                item.className = 'test-item error';
                testStats.failed++;
                console.log(`âŒ ${testData.name} ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const successRate = testStats.total > 0 ? Math.round((testStats.passed / testStats.total) * 100) : 0;
            
            let resultText = '';
            let resultColor = '';
            
            if (successRate === 100) {
                resultText = 'ğŸ‰ æ‰€æœ‰æ™ºèƒ½åˆ‡æ¢æµ‹è¯•é€šè¿‡ï¼JPG/PNGè·¯å¾„é—®é¢˜å·²å®Œå…¨è§£å†³ï¼';
                resultColor = '#67c23a';
            } else if (successRate >= 80) {
                resultText = 'âœ… å¤§éƒ¨åˆ†æ™ºèƒ½åˆ‡æ¢æ­£å¸¸ï¼ŒåŸºæœ¬è§£å†³JPG/PNGæ˜¾ç¤ºé—®é¢˜';
                resultColor = '#e6a23c';
            } else {
                resultText = 'âŒ æ™ºèƒ½åˆ‡æ¢å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•';
                resultColor = '#f56c6c';
            }
            
            summaryContent.innerHTML = `
                <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                    <div><span style="font-size: 24px; font-weight: bold;">${testStats.total}</span><br>æ€»æµ‹è¯•æ•°</div>
                    <div><span style="font-size: 24px; font-weight: bold;">${testStats.passed}</span><br>é€šè¿‡æµ‹è¯•</div>
                    <div><span style="font-size: 24px; font-weight: bold;">${testStats.failed}</span><br>å¤±è´¥æµ‹è¯•</div>
                    <div><span style="font-size: 24px; font-weight: bold;">${successRate}%</span><br>æˆåŠŸç‡</div>
                </div>
                <div style="font-size: 18px; font-weight: bold; color: ${resultColor};">
                    ${resultText}
                </div>
                <div style="margin-top: 15px; font-size: 14px;">
                    ç°åœ¨åœ¨å›¾æ¡ˆç®¡ç†é¡µé¢é€‰æ‹©JPG/PNGè·¯å¾„æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”çš„SVGç‰ˆæœ¬æ–‡ä»¶
                </div>
            `;
            
            document.getElementById('summary').style.display = 'block';
        }

        async function runSmartSwitchingTest() {
            const container = document.getElementById('testResults');
            container.innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            // é‡ç½®ç»Ÿè®¡
            testStats = { total: 0, passed: 0, failed: 0 };
            
            console.log('å¼€å§‹è¿è¡Œæ™ºèƒ½åˆ‡æ¢æµ‹è¯•...');
            
            for (const testData of testPaths) {
                await testSinglePath(testData, container);
                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            updateSummary();
            console.log('æ™ºèƒ½åˆ‡æ¢æµ‹è¯•å®Œæˆ');
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testStats = { total: 0, passed: 0, failed: 0 };
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ æ™ºèƒ½åˆ‡æ¢æœ€ç»ˆæµ‹è¯•å·¥å…·å·²åŠ è½½');
            console.log('è¿™ä¸ªæµ‹è¯•å°†éªŒè¯JPG/PNGè·¯å¾„æ˜¯å¦èƒ½è‡ªåŠ¨åˆ‡æ¢åˆ°SVGç‰ˆæœ¬');
            
            // 3ç§’åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
            setTimeout(() => {
                console.log('è‡ªåŠ¨å¼€å§‹æ™ºèƒ½åˆ‡æ¢æµ‹è¯•...');
                runSmartSwitchingTest();
            }, 2000);
        });
    </script>
</body>
</html>