<!DOCTYPE html>
<html>
<head>
    <title>进度显示问题诊断工具</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .progress-demo { background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .progress-bar { width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .progress-0 { background: #e2e8f0; }
        .progress-30 { background: #f59e0b; }
        .progress-50 { background: #3b82f6; }
        .progress-99 { background: #f97316; }
        .progress-100 { background: #10b981; }
    </style>
</head>
<body>
    <h1>进度显示问题诊断工具</h1>
    
    <div class="progress-demo">
        <h3>🐛 问题描述</h3>
        <p><strong>现象</strong>：进度显示为0%，但是状态是"已完成"</p>
        <p><strong>原因</strong>：进度计算逻辑没有正确处理状态与完成数量的关系</p>
        <p><strong>修复</strong>：优化进度计算逻辑，确保状态与进度的一致性</p>
    </div>
    
    <div class="debug-section">
        <h3>1. 进度计算逻辑测试</h3>
        <div>
            <label>任务状态: 
                <select id="taskStatus">
                    <option value="待下发">待下发</option>
                    <option value="进行中">进行中</option>
                    <option value="已完成">已完成</option>
                    <option value="已暂停">已暂停</option>
                </select>
            </label>
            <label>任务数量: <input type="number" id="taskQuantity" value="100" min="1"></label>
            <label>完成数量: <input type="number" id="completedQuantity" placeholder="留空表示无数据"></label>
        </div>
        <button onclick="testProgressCalculation()">测试进度计算</button>
        <div id="progressResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. 问题场景重现</h3>
        <table>
            <thead>
                <tr>
                    <th>场景</th>
                    <th>状态</th>
                    <th>任务数量</th>
                    <th>完成数量</th>
                    <th>修复前进度</th>
                    <th>修复后进度</th>
                    <th>进度条</th>
                </tr>
            </thead>
            <tbody id="scenarioTable">
                <!-- 动态生成 -->
            </tbody>
        </table>
        <button onclick="runProgressScenarios()">运行进度场景测试</button>
        <div id="scenarioResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>3. 实际数据测试</h3>
        <button onclick="fetchRealTaskData()">获取实际任务数据</button>
        <div id="realDataResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. 进度计算规则说明</h3>
        <div class="progress-demo">
            <h4>新的进度计算规则：</h4>
            <ol>
                <li><strong>状态优先</strong>：如果状态是"已完成"，进度直接显示100%</li>
                <li><strong>实际进度</strong>：如果有完成数量，计算实际进度百分比</li>
                <li><strong>进度保护</strong>：如果实际进度100%但状态不是已完成，显示99%</li>
                <li><strong>状态基础</strong>：没有完成数量时，基于状态显示基础进度</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // 修复前的进度计算逻辑（有问题的版本）
        function getProgressOld(row) {
            if (!row.quantity || row.quantity === 0) return 0;
            
            const baseProgress = {
                '待下发': 0,
                '进行中': 50,
                '已完成': 100,
                '已暂停': 30
            }[row.status] || 0;
            
            if (row.completedQuantity !== undefined && row.completedQuantity >= 0) {
                return Math.min(100, Math.round((row.completedQuantity / row.quantity) * 100));
            }
            
            return baseProgress;
        }
        
        // 修复后的进度计算逻辑（新版本）
        function getProgressNew(row) {
            if (!row.quantity || row.quantity === 0) return 0;
            
            // 特殊处理：如果状态是已完成，进度应该是100%
            if (row.status === '已完成') {
                return 100;
            }
            
            // 如果有实际完成数量，使用实际进度
            if (row.completedQuantity !== undefined && row.completedQuantity >= 0) {
                const actualProgress = Math.min(100, Math.round((row.completedQuantity / row.quantity) * 100));
                
                // 如果实际进度是100%但状态不是已完成，显示99%以示区别
                if (actualProgress === 100 && row.status !== '已完成') {
                    return 99;
                }
                
                return actualProgress;
            }
            
            // 基于状态的基础进度（当没有完成数量数据时）
            const baseProgress = {
                '待下发': 0,
                '进行中': 50,
                '已完成': 100,
                '已暂停': 30
            }[row.status] || 0;
            
            return baseProgress;
        }
        
        // 测试进度计算
        function testProgressCalculation() {
            const status = document.getElementById('taskStatus').value;
            const quantity = parseInt(document.getElementById('taskQuantity').value);
            const completedQuantityInput = document.getElementById('completedQuantity').value;
            const completedQuantity = completedQuantityInput ? parseInt(completedQuantityInput) : undefined;
            
            const testTask = {
                status: status,
                quantity: quantity,
                completedQuantity: completedQuantity
            };
            
            const oldProgress = getProgressOld(testTask);
            const newProgress = getProgressNew(testTask);
            
            const resultDiv = document.getElementById('progressResult');
            resultDiv.className = oldProgress !== newProgress ? 'result warning' : 'result success';
            resultDiv.innerHTML = `进度计算测试结果:\n\n` +
                                 `任务状态: ${status}\n` +
                                 `任务数量: ${quantity}\n` +
                                 `完成数量: ${completedQuantity !== undefined ? completedQuantity : '无数据'}\n\n` +
                                 `修复前进度: ${oldProgress}%\n` +
                                 `修复后进度: ${newProgress}%\n` +
                                 `是否修复: ${oldProgress !== newProgress ? '是' : '否'}\n\n` +
                                 `计算逻辑:\n` +
                                 `- 状态是已完成: ${status === '已完成' ? '是，直接返回100%' : '否'}\n` +
                                 `- 有完成数量: ${completedQuantity !== undefined ? '是，计算实际进度' : '否，使用状态基础进度'}`;
        }
        
        // 生成问题场景
        function generateProblemScenarios() {
            return [
                { name: '问题场景1', status: '已完成', quantity: 100, completedQuantity: undefined },
                { name: '问题场景2', status: '已完成', quantity: 200, completedQuantity: 0 },
                { name: '正常场景1', status: '已完成', quantity: 100, completedQuantity: 100 },
                { name: '正常场景2', status: '进行中', quantity: 100, completedQuantity: 50 },
                { name: '边界场景1', status: '进行中', quantity: 100, completedQuantity: 100 },
                { name: '边界场景2', status: '待下发', quantity: 100, completedQuantity: undefined },
                { name: '暂停场景', status: '已暂停', quantity: 100, completedQuantity: 30 }
            ];
        }
        
        // 运行进度场景测试
        function runProgressScenarios() {
            const scenarios = generateProblemScenarios();
            const tableBody = document.getElementById('scenarioTable');
            const resultDiv = document.getElementById('scenarioResult');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            let fixedCount = 0;
            let problemCount = 0;
            
            scenarios.forEach((scenario, index) => {
                const oldProgress = getProgressOld(scenario);
                const newProgress = getProgressNew(scenario);
                const isFixed = oldProgress !== newProgress;
                const isProblem = (scenario.status === '已完成' && oldProgress < 100);
                
                if (isFixed) fixedCount++;
                if (isProblem) problemCount++;
                
                // 添加表格行
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${scenario.name}</td>
                    <td><span class="status-${scenario.status}">${scenario.status}</span></td>
                    <td>${scenario.quantity}</td>
                    <td>${scenario.completedQuantity !== undefined ? scenario.completedQuantity : '无数据'}</td>
                    <td>${oldProgress}%</td>
                    <td>${newProgress}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill progress-${newProgress}" style="width: ${newProgress}%"></div>
                        </div>
                    </td>
                `;
                
                // 高亮问题行
                if (isProblem) {
                    row.style.backgroundColor = '#fef2f2';
                }
                if (isFixed) {
                    row.style.borderLeft = '4px solid #10b981';
                }
            });
            
            // 显示结果统计
            resultDiv.className = problemCount > 0 ? 'result warning' : 'result success';
            resultDiv.innerHTML = `场景测试完成!\n\n` +
                                 `总场景数: ${scenarios.length}\n` +
                                 `问题场景: ${problemCount}\n` +
                                 `修复场景: ${fixedCount}\n` +
                                 `正常场景: ${scenarios.length - problemCount}\n\n` +
                                 `修复效果: ${problemCount === fixedCount ? '✅ 所有问题已修复' : '⚠️ 仍有问题未修复'}`;
        }
        
        // 获取实际任务数据
        async function fetchRealTaskData() {
            const resultDiv = document.getElementById('realDataResult');
            
            try {
                resultDiv.innerHTML = '获取实际任务数据中...\n\n';
                
                const response = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=20`);
                const data = await response.json();
                
                if (response.ok && data.content) {
                    let problemTasks = [];
                    let totalTasks = data.content.length;
                    
                    data.content.forEach(task => {
                        const oldProgress = getProgressOld(task);
                        const newProgress = getProgressNew(task);
                        
                        if (task.status === '已完成' && oldProgress < 100) {
                            problemTasks.push({
                                taskCode: task.taskCode || task.id,
                                status: task.status,
                                quantity: task.quantity,
                                completedQuantity: task.completedQuantity,
                                oldProgress: oldProgress,
                                newProgress: newProgress
                            });
                        }
                    });
                    
                    resultDiv.className = problemTasks.length > 0 ? 'result warning' : 'result success';
                    resultDiv.innerHTML = `实际数据分析结果:\n\n` +
                                         `总任务数: ${totalTasks}\n` +
                                         `问题任务数: ${problemTasks.length}\n\n`;
                    
                    if (problemTasks.length > 0) {
                        resultDiv.innerHTML += `发现的问题任务:\n`;
                        problemTasks.forEach((task, index) => {
                            resultDiv.innerHTML += `${index + 1}. ${task.taskCode}\n` +
                                                  `   状态: ${task.status}\n` +
                                                  `   数量: ${task.quantity}\n` +
                                                  `   完成: ${task.completedQuantity || '无数据'}\n` +
                                                  `   进度: ${task.oldProgress}% → ${task.newProgress}%\n\n`;
                        });
                    } else {
                        resultDiv.innerHTML += `✅ 未发现进度显示问题`;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML += '❌ 获取任务数据失败\n' + JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += '❌ 网络错误: ' + error.message;
            }
        }
        
        // 页面加载时运行场景测试
        window.onload = function() {
            runProgressScenarios();
        };
    </script>
</body>
</html>