<!DOCTYPE html>
<html>
<head>
    <title>è¿›åº¦æ˜¾ç¤ºé—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .progress-demo { background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .progress-bar { width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .progress-0 { background: #e2e8f0; }
        .progress-30 { background: #f59e0b; }
        .progress-50 { background: #3b82f6; }
        .progress-99 { background: #f97316; }
        .progress-100 { background: #10b981; }
    </style>
</head>
<body>
    <h1>è¿›åº¦æ˜¾ç¤ºé—®é¢˜è¯Šæ–­å·¥å…·</h1>
    
    <div class="progress-demo">
        <h3>ğŸ› é—®é¢˜æè¿°</h3>
        <p><strong>ç°è±¡</strong>ï¼šè¿›åº¦æ˜¾ç¤ºä¸º0%ï¼Œä½†æ˜¯çŠ¶æ€æ˜¯"å·²å®Œæˆ"</p>
        <p><strong>åŸå› </strong>ï¼šè¿›åº¦è®¡ç®—é€»è¾‘æ²¡æœ‰æ­£ç¡®å¤„ç†çŠ¶æ€ä¸å®Œæˆæ•°é‡çš„å…³ç³»</p>
        <p><strong>ä¿®å¤</strong>ï¼šä¼˜åŒ–è¿›åº¦è®¡ç®—é€»è¾‘ï¼Œç¡®ä¿çŠ¶æ€ä¸è¿›åº¦çš„ä¸€è‡´æ€§</p>
    </div>
    
    <div class="debug-section">
        <h3>1. è¿›åº¦è®¡ç®—é€»è¾‘æµ‹è¯•</h3>
        <div>
            <label>ä»»åŠ¡çŠ¶æ€: 
                <select id="taskStatus">
                    <option value="å¾…ä¸‹å‘">å¾…ä¸‹å‘</option>
                    <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                    <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    <option value="å·²æš‚åœ">å·²æš‚åœ</option>
                </select>
            </label>
            <label>ä»»åŠ¡æ•°é‡: <input type="number" id="taskQuantity" value="100" min="1"></label>
            <label>å®Œæˆæ•°é‡: <input type="number" id="completedQuantity" placeholder="ç•™ç©ºè¡¨ç¤ºæ— æ•°æ®"></label>
        </div>
        <button onclick="testProgressCalculation()">æµ‹è¯•è¿›åº¦è®¡ç®—</button>
        <div id="progressResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. é—®é¢˜åœºæ™¯é‡ç°</h3>
        <table>
            <thead>
                <tr>
                    <th>åœºæ™¯</th>
                    <th>çŠ¶æ€</th>
                    <th>ä»»åŠ¡æ•°é‡</th>
                    <th>å®Œæˆæ•°é‡</th>
                    <th>ä¿®å¤å‰è¿›åº¦</th>
                    <th>ä¿®å¤åè¿›åº¦</th>
                    <th>è¿›åº¦æ¡</th>
                </tr>
            </thead>
            <tbody id="scenarioTable">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>
        <button onclick="runProgressScenarios()">è¿è¡Œè¿›åº¦åœºæ™¯æµ‹è¯•</button>
        <div id="scenarioResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>3. å®é™…æ•°æ®æµ‹è¯•</h3>
        <button onclick="fetchRealTaskData()">è·å–å®é™…ä»»åŠ¡æ•°æ®</button>
        <div id="realDataResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. è¿›åº¦è®¡ç®—è§„åˆ™è¯´æ˜</h3>
        <div class="progress-demo">
            <h4>æ–°çš„è¿›åº¦è®¡ç®—è§„åˆ™ï¼š</h4>
            <ol>
                <li><strong>çŠ¶æ€ä¼˜å…ˆ</strong>ï¼šå¦‚æœçŠ¶æ€æ˜¯"å·²å®Œæˆ"ï¼Œè¿›åº¦ç›´æ¥æ˜¾ç¤º100%</li>
                <li><strong>å®é™…è¿›åº¦</strong>ï¼šå¦‚æœæœ‰å®Œæˆæ•°é‡ï¼Œè®¡ç®—å®é™…è¿›åº¦ç™¾åˆ†æ¯”</li>
                <li><strong>è¿›åº¦ä¿æŠ¤</strong>ï¼šå¦‚æœå®é™…è¿›åº¦100%ä½†çŠ¶æ€ä¸æ˜¯å·²å®Œæˆï¼Œæ˜¾ç¤º99%</li>
                <li><strong>çŠ¶æ€åŸºç¡€</strong>ï¼šæ²¡æœ‰å®Œæˆæ•°é‡æ—¶ï¼ŒåŸºäºçŠ¶æ€æ˜¾ç¤ºåŸºç¡€è¿›åº¦</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // ä¿®å¤å‰çš„è¿›åº¦è®¡ç®—é€»è¾‘ï¼ˆæœ‰é—®é¢˜çš„ç‰ˆæœ¬ï¼‰
        function getProgressOld(row) {
            if (!row.quantity || row.quantity === 0) return 0;
            
            const baseProgress = {
                'å¾…ä¸‹å‘': 0,
                'è¿›è¡Œä¸­': 50,
                'å·²å®Œæˆ': 100,
                'å·²æš‚åœ': 30
            }[row.status] || 0;
            
            if (row.completedQuantity !== undefined && row.completedQuantity >= 0) {
                return Math.min(100, Math.round((row.completedQuantity / row.quantity) * 100));
            }
            
            return baseProgress;
        }
        
        // ä¿®å¤åçš„è¿›åº¦è®¡ç®—é€»è¾‘ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
        function getProgressNew(row) {
            if (!row.quantity || row.quantity === 0) return 0;
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœçŠ¶æ€æ˜¯å·²å®Œæˆï¼Œè¿›åº¦åº”è¯¥æ˜¯100%
            if (row.status === 'å·²å®Œæˆ') {
                return 100;
            }
            
            // å¦‚æœæœ‰å®é™…å®Œæˆæ•°é‡ï¼Œä½¿ç”¨å®é™…è¿›åº¦
            if (row.completedQuantity !== undefined && row.completedQuantity >= 0) {
                const actualProgress = Math.min(100, Math.round((row.completedQuantity / row.quantity) * 100));
                
                // å¦‚æœå®é™…è¿›åº¦æ˜¯100%ä½†çŠ¶æ€ä¸æ˜¯å·²å®Œæˆï¼Œæ˜¾ç¤º99%ä»¥ç¤ºåŒºåˆ«
                if (actualProgress === 100 && row.status !== 'å·²å®Œæˆ') {
                    return 99;
                }
                
                return actualProgress;
            }
            
            // åŸºäºçŠ¶æ€çš„åŸºç¡€è¿›åº¦ï¼ˆå½“æ²¡æœ‰å®Œæˆæ•°é‡æ•°æ®æ—¶ï¼‰
            const baseProgress = {
                'å¾…ä¸‹å‘': 0,
                'è¿›è¡Œä¸­': 50,
                'å·²å®Œæˆ': 100,
                'å·²æš‚åœ': 30
            }[row.status] || 0;
            
            return baseProgress;
        }
        
        // æµ‹è¯•è¿›åº¦è®¡ç®—
        function testProgressCalculation() {
            const status = document.getElementById('taskStatus').value;
            const quantity = parseInt(document.getElementById('taskQuantity').value);
            const completedQuantityInput = document.getElementById('completedQuantity').value;
            const completedQuantity = completedQuantityInput ? parseInt(completedQuantityInput) : undefined;
            
            const testTask = {
                status: status,
                quantity: quantity,
                completedQuantity: completedQuantity
            };
            
            const oldProgress = getProgressOld(testTask);
            const newProgress = getProgressNew(testTask);
            
            const resultDiv = document.getElementById('progressResult');
            resultDiv.className = oldProgress !== newProgress ? 'result warning' : 'result success';
            resultDiv.innerHTML = `è¿›åº¦è®¡ç®—æµ‹è¯•ç»“æœ:\n\n` +
                                 `ä»»åŠ¡çŠ¶æ€: ${status}\n` +
                                 `ä»»åŠ¡æ•°é‡: ${quantity}\n` +
                                 `å®Œæˆæ•°é‡: ${completedQuantity !== undefined ? completedQuantity : 'æ— æ•°æ®'}\n\n` +
                                 `ä¿®å¤å‰è¿›åº¦: ${oldProgress}%\n` +
                                 `ä¿®å¤åè¿›åº¦: ${newProgress}%\n` +
                                 `æ˜¯å¦ä¿®å¤: ${oldProgress !== newProgress ? 'æ˜¯' : 'å¦'}\n\n` +
                                 `è®¡ç®—é€»è¾‘:\n` +
                                 `- çŠ¶æ€æ˜¯å·²å®Œæˆ: ${status === 'å·²å®Œæˆ' ? 'æ˜¯ï¼Œç›´æ¥è¿”å›100%' : 'å¦'}\n` +
                                 `- æœ‰å®Œæˆæ•°é‡: ${completedQuantity !== undefined ? 'æ˜¯ï¼Œè®¡ç®—å®é™…è¿›åº¦' : 'å¦ï¼Œä½¿ç”¨çŠ¶æ€åŸºç¡€è¿›åº¦'}`;
        }
        
        // ç”Ÿæˆé—®é¢˜åœºæ™¯
        function generateProblemScenarios() {
            return [
                { name: 'é—®é¢˜åœºæ™¯1', status: 'å·²å®Œæˆ', quantity: 100, completedQuantity: undefined },
                { name: 'é—®é¢˜åœºæ™¯2', status: 'å·²å®Œæˆ', quantity: 200, completedQuantity: 0 },
                { name: 'æ­£å¸¸åœºæ™¯1', status: 'å·²å®Œæˆ', quantity: 100, completedQuantity: 100 },
                { name: 'æ­£å¸¸åœºæ™¯2', status: 'è¿›è¡Œä¸­', quantity: 100, completedQuantity: 50 },
                { name: 'è¾¹ç•Œåœºæ™¯1', status: 'è¿›è¡Œä¸­', quantity: 100, completedQuantity: 100 },
                { name: 'è¾¹ç•Œåœºæ™¯2', status: 'å¾…ä¸‹å‘', quantity: 100, completedQuantity: undefined },
                { name: 'æš‚åœåœºæ™¯', status: 'å·²æš‚åœ', quantity: 100, completedQuantity: 30 }
            ];
        }
        
        // è¿è¡Œè¿›åº¦åœºæ™¯æµ‹è¯•
        function runProgressScenarios() {
            const scenarios = generateProblemScenarios();
            const tableBody = document.getElementById('scenarioTable');
            const resultDiv = document.getElementById('scenarioResult');
            
            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = '';
            
            let fixedCount = 0;
            let problemCount = 0;
            
            scenarios.forEach((scenario, index) => {
                const oldProgress = getProgressOld(scenario);
                const newProgress = getProgressNew(scenario);
                const isFixed = oldProgress !== newProgress;
                const isProblem = (scenario.status === 'å·²å®Œæˆ' && oldProgress < 100);
                
                if (isFixed) fixedCount++;
                if (isProblem) problemCount++;
                
                // æ·»åŠ è¡¨æ ¼è¡Œ
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${scenario.name}</td>
                    <td><span class="status-${scenario.status}">${scenario.status}</span></td>
                    <td>${scenario.quantity}</td>
                    <td>${scenario.completedQuantity !== undefined ? scenario.completedQuantity : 'æ— æ•°æ®'}</td>
                    <td>${oldProgress}%</td>
                    <td>${newProgress}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill progress-${newProgress}" style="width: ${newProgress}%"></div>
                        </div>
                    </td>
                `;
                
                // é«˜äº®é—®é¢˜è¡Œ
                if (isProblem) {
                    row.style.backgroundColor = '#fef2f2';
                }
                if (isFixed) {
                    row.style.borderLeft = '4px solid #10b981';
                }
            });
            
            // æ˜¾ç¤ºç»“æœç»Ÿè®¡
            resultDiv.className = problemCount > 0 ? 'result warning' : 'result success';
            resultDiv.innerHTML = `åœºæ™¯æµ‹è¯•å®Œæˆ!\n\n` +
                                 `æ€»åœºæ™¯æ•°: ${scenarios.length}\n` +
                                 `é—®é¢˜åœºæ™¯: ${problemCount}\n` +
                                 `ä¿®å¤åœºæ™¯: ${fixedCount}\n` +
                                 `æ­£å¸¸åœºæ™¯: ${scenarios.length - problemCount}\n\n` +
                                 `ä¿®å¤æ•ˆæœ: ${problemCount === fixedCount ? 'âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤' : 'âš ï¸ ä»æœ‰é—®é¢˜æœªä¿®å¤'}`;
        }
        
        // è·å–å®é™…ä»»åŠ¡æ•°æ®
        async function fetchRealTaskData() {
            const resultDiv = document.getElementById('realDataResult');
            
            try {
                resultDiv.innerHTML = 'è·å–å®é™…ä»»åŠ¡æ•°æ®ä¸­...\n\n';
                
                const response = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=20`);
                const data = await response.json();
                
                if (response.ok && data.content) {
                    let problemTasks = [];
                    let totalTasks = data.content.length;
                    
                    data.content.forEach(task => {
                        const oldProgress = getProgressOld(task);
                        const newProgress = getProgressNew(task);
                        
                        if (task.status === 'å·²å®Œæˆ' && oldProgress < 100) {
                            problemTasks.push({
                                taskCode: task.taskCode || task.id,
                                status: task.status,
                                quantity: task.quantity,
                                completedQuantity: task.completedQuantity,
                                oldProgress: oldProgress,
                                newProgress: newProgress
                            });
                        }
                    });
                    
                    resultDiv.className = problemTasks.length > 0 ? 'result warning' : 'result success';
                    resultDiv.innerHTML = `å®é™…æ•°æ®åˆ†æç»“æœ:\n\n` +
                                         `æ€»ä»»åŠ¡æ•°: ${totalTasks}\n` +
                                         `é—®é¢˜ä»»åŠ¡æ•°: ${problemTasks.length}\n\n`;
                    
                    if (problemTasks.length > 0) {
                        resultDiv.innerHTML += `å‘ç°çš„é—®é¢˜ä»»åŠ¡:\n`;
                        problemTasks.forEach((task, index) => {
                            resultDiv.innerHTML += `${index + 1}. ${task.taskCode}\n` +
                                                  `   çŠ¶æ€: ${task.status}\n` +
                                                  `   æ•°é‡: ${task.quantity}\n` +
                                                  `   å®Œæˆ: ${task.completedQuantity || 'æ— æ•°æ®'}\n` +
                                                  `   è¿›åº¦: ${task.oldProgress}% â†’ ${task.newProgress}%\n\n`;
                        });
                    } else {
                        resultDiv.innerHTML += `âœ… æœªå‘ç°è¿›åº¦æ˜¾ç¤ºé—®é¢˜`;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML += 'âŒ è·å–ä»»åŠ¡æ•°æ®å¤±è´¥\n' + JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡Œåœºæ™¯æµ‹è¯•
        window.onload = function() {
            runProgressScenarios();
        };
    </script>
</body>
</html>