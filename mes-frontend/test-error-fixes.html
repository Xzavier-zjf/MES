<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”™è¯¯ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #409EFF;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #f0f9ff; color: #1890ff; border-left: 4px solid #1890ff; }
        .error { background: #fff2f0; color: #ff4d4f; border-left: 4px solid #ff4d4f; }
        .warning { background: #fffbe6; color: #faad14; border-left: 4px solid #faad14; }
        .info { background: #f6ffed; color: #52c41a; border-left: 4px solid #52c41a; }
        
        .image-test {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .image-item {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .image-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        .image-error {
            width: 100px;
            height: 100px;
            background: #f5f5f5;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ MESç³»ç»Ÿé”™è¯¯ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2 class="test-title">1. JWT Token éªŒè¯ä¿®å¤</h2>
        <div id="token-test">
            <p>æµ‹è¯•ä¸åŒç±»å‹çš„tokenéªŒè¯...</p>
        </div>
    </div>
    
    <div class="test-section">
        <h2 class="test-title">2. å›¾ç‰‡URLä¿®å¤æµ‹è¯•</h2>
        <div id="image-test">
            <p>æµ‹è¯•å›¾ç‰‡URLæ„å»ºå’ŒåŠ è½½...</p>
            <div class="image-test">
                <div class="image-item">
                    <div>å®Œæ•´URL</div>
                    <img src="https://via.placeholder.com/100" alt="å®Œæ•´URLæµ‹è¯•" onerror="handleImageError(this)">
                </div>
                <div class="image-item">
                    <div>ç›¸å¯¹è·¯å¾„</div>
                    <img src="/api/uploads/patterns/test-pattern-1.jpg" alt="ç›¸å¯¹è·¯å¾„æµ‹è¯•" onerror="handleImageError(this)">
                </div>
                <div class="image-item">
                    <div>é”™è¯¯è·¯å¾„</div>
                    <img src="/api/uploads/patterns/non-existent.jpg" alt="é”™è¯¯è·¯å¾„æµ‹è¯•" onerror="handleImageError(this)">
                </div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2 class="test-title">3. APIä»£ç†æµ‹è¯•</h2>
        <div id="api-test">
            <p>æµ‹è¯•APIä»£ç†é…ç½®...</p>
            <button onclick="testApiProxy()">æµ‹è¯•APIè¿æ¥</button>
            <div id="api-result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2 class="test-title">4. æ§åˆ¶å°é”™è¯¯æ£€æŸ¥</h2>
        <div id="console-test">
            <div class="info">âœ… JWT Tokenæ ¼å¼é”™è¯¯å·²ä¿®å¤ - ä¸å†è¾“å‡ºé”™è¯¯æ—¥å¿—</div>
            <div class="info">âœ… å›¾ç‰‡åŠ è½½é”™è¯¯å·²ä¼˜åŒ– - å‡å°‘æ§åˆ¶å°å™ªéŸ³</div>
            <div class="info">âœ… ä»£ç†æ—¥å¿—å·²ä¼˜åŒ– - åªè®°å½•å¿…è¦ä¿¡æ¯</div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸtokenéªŒè¯æµ‹è¯•
        function testTokenValidation() {
            const testTokens = [
                'simple-token-123',  // ç®€å•token
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c', // æœ‰æ•ˆJWT
                'invalid.jwt', // æ— æ•ˆJWT
                null, // ç©ºtoken
                ''    // ç©ºå­—ç¬¦ä¸²
            ];
            
            const results = testTokens.map(token => {
                try {
                    const isValid = checkToken(token);
                    return { token: token || 'null', valid: isValid, error: null };
                } catch (error) {
                    return { token: token || 'null', valid: false, error: error.message };
                }
            });
            
            const tokenTestDiv = document.getElementById('token-test');
            tokenTestDiv.innerHTML = results.map(result => 
                `<div class="${result.valid ? 'success' : 'warning'}">
                    Token: ${result.token.substring(0, 20)}... - ${result.valid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}
                    ${result.error ? ` (${result.error})` : ''}
                </div>`
            ).join('');
        }
        
        // æ¨¡æ‹Ÿtokenæ£€æŸ¥å‡½æ•°
        function checkToken(token) {
            if (!token) return false;
            
            const tokenString = typeof token === 'string' ? token : String(token);
            const tokenParts = tokenString.split('.');
            
            if (tokenParts.length !== 3) {
                // éJWT tokenï¼Œè®¤ä¸ºæœ‰æ•ˆ
                return true;
            }
            
            try {
                const payload = JSON.parse(atob(tokenParts[1]));
                const currentTime = Date.now() / 1000;
                
                if (payload.exp && payload.exp < currentTime) {
                    return false;
                }
                
                return true;
            } catch (error) {
                return true; // è§£æå¤±è´¥ï¼Œè®¤ä¸ºæ˜¯éJWT token
            }
        }
        
        // å›¾ç‰‡é”™è¯¯å¤„ç†
        function handleImageError(img) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'image-error';
            errorDiv.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
            img.parentNode.replaceChild(errorDiv, img);
        }
        
        // APIä»£ç†æµ‹è¯•
        async function testApiProxy() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•APIè¿æ¥...</div>';
            
            const testEndpoints = [
                '/api/health',
                '/api/equipment/health',
                '/api/process/health',
                '/api/production/health'
            ];
            
            let successCount = 0;
            let results = [];
            
            for (const endpoint of testEndpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        successCount++;
                        results.push(`âœ… ${endpoint} - æ­£å¸¸`);
                    } else {
                        results.push(`âš ï¸ ${endpoint} - çŠ¶æ€${response.status}`);
                    }
                } catch (error) {
                    results.push(`âŒ ${endpoint} - ${error.message}`);
                }
            }
            
            const statusClass = successCount > 0 ? 'success' : 'error';
            const summary = successCount > 0 ? 
                `APIä»£ç†æµ‹è¯•å®Œæˆï¼Œ${successCount}/${testEndpoints.length} ä¸ªç«¯ç‚¹æ­£å¸¸` :
                'APIä»£ç†æµ‹è¯•å¤±è´¥ï¼Œæ‰€æœ‰ç«¯ç‚¹éƒ½æ— æ³•è®¿é—®';
            
            resultDiv.innerHTML = `
                <div class="${statusClass}">${summary}</div>
                <div style="margin-top: 10px; font-size: 12px;">
                    ${results.map(result => `<div>${result}</div>`).join('')}
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    ğŸ’¡ æç¤º: å¦‚æœæ‰€æœ‰APIéƒ½å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨
                </div>
            `;
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            testTokenValidation();
            
            // æ£€æŸ¥æ§åˆ¶å°é”™è¯¯
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            let errorCount = 0;
            let warnCount = 0;
            
            console.error = function(...args) {
                errorCount++;
                originalConsoleError.apply(console, args);
            };
            
            console.warn = function(...args) {
                warnCount++;
                originalConsoleWarn.apply(console, args);
            };
            
            // 5ç§’åæ£€æŸ¥é”™è¯¯æ•°é‡
            setTimeout(() => {
                const consoleDiv = document.getElementById('console-test');
                consoleDiv.innerHTML += `
                    <div class="info">ğŸ“Š æ§åˆ¶å°é”™è¯¯ç»Ÿè®¡ (5ç§’å†…):</div>
                    <div class="${errorCount > 0 ? 'error' : 'success'}">é”™è¯¯: ${errorCount} æ¡</div>
                    <div class="${warnCount > 0 ? 'warning' : 'success'}">è­¦å‘Š: ${warnCount} æ¡</div>
                `;
            }, 5000);
        });
    </script>
</body>
</html>