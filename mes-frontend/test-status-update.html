<!DOCTYPE html>
<html>
<head>
    <title>ä»»åŠ¡çŠ¶æ€è‡ªåŠ¨æ›´æ–°æµ‹è¯•</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .status-demo { background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .status-flow { display: flex; gap: 20px; margin: 10px 0; align-items: center; }
        .status-item { padding: 10px; border-radius: 4px; text-align: center; min-width: 80px; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-in-progress { background: #dbeafe; color: #2563eb; }
        .status-completed { background: #dcfce7; color: #16a34a; }
        .status-paused { background: #fde68a; color: #b45309; }
        .arrow { font-size: 20px; color: #666; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ä»»åŠ¡çŠ¶æ€è‡ªåŠ¨æ›´æ–°æµ‹è¯•</h1>
    
    <div class="status-demo">
        <h3>ğŸ”„ çŠ¶æ€è½¬æ¢è§„åˆ™</h3>
        <div class="status-flow">
            <div class="status-item status-pending">å¾…ä¸‹å‘</div>
            <div class="arrow">â†’</div>
            <div class="status-item status-in-progress">è¿›è¡Œä¸­</div>
            <div class="arrow">â†’</div>
            <div class="status-item status-completed">å·²å®Œæˆ</div>
        </div>
        <div class="status-flow">
            <div class="status-item status-in-progress">è¿›è¡Œä¸­</div>
            <div class="arrow">â†•</div>
            <div class="status-item status-paused">å·²æš‚åœ</div>
        </div>
        <ul>
            <li><strong>å¾…ä¸‹å‘ â†’ è¿›è¡Œä¸­</strong>ï¼šå®Œæˆæ•°é‡ > 0</li>
            <li><strong>è¿›è¡Œä¸­ â†’ å·²å®Œæˆ</strong>ï¼šå®Œæˆæ•°é‡ = ä»»åŠ¡æ•°é‡</li>
            <li><strong>è¿›è¡Œä¸­ â†” å·²æš‚åœ</strong>ï¼šæ‰‹åŠ¨æ§åˆ¶æˆ–è®¾å¤‡çŠ¶æ€</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>1. çŠ¶æ€è®¡ç®—æµ‹è¯•</h3>
        <div>
            <label>å½“å‰çŠ¶æ€: 
                <select id="currentStatus">
                    <option value="å¾…ä¸‹å‘">å¾…ä¸‹å‘</option>
                    <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                    <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    <option value="å·²æš‚åœ">å·²æš‚åœ</option>
                </select>
            </label>
            <label>ä»»åŠ¡æ•°é‡: <input type="number" id="taskQuantity" value="100" min="1"></label>
            <label>å®Œæˆæ•°é‡: <input type="number" id="completedQuantity" value="0" min="0"></label>
        </div>
        <button onclick="testStatusCalculation()">è®¡ç®—å»ºè®®çŠ¶æ€</button>
        <div id="statusResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. çŠ¶æ€è½¬æ¢åœºæ™¯æµ‹è¯•</h3>
        <table>
            <thead>
                <tr>
                    <th>åœºæ™¯</th>
                    <th>å½“å‰çŠ¶æ€</th>
                    <th>ä»»åŠ¡æ•°é‡</th>
                    <th>å®Œæˆæ•°é‡</th>
                    <th>å»ºè®®çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="scenarioTable">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>
        <button onclick="runAllScenarios()">è¿è¡Œæ‰€æœ‰åœºæ™¯æµ‹è¯•</button>
        <div id="scenarioResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. å®é™…ä»»åŠ¡çŠ¶æ€æ›´æ–°æµ‹è¯•</h3>
        <div>
            <label>ä»»åŠ¡ID: <input type="text" id="testTaskId" placeholder="è¾“å…¥ä»»åŠ¡ID"></label>
            <label>æ–°çŠ¶æ€: 
                <select id="newStatus">
                    <option value="å¾…ä¸‹å‘">å¾…ä¸‹å‘</option>
                    <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                    <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    <option value="å·²æš‚åœ">å·²æš‚åœ</option>
                </select>
            </label>
        </div>
        <button onclick="testRealStatusUpdate()">æµ‹è¯•çŠ¶æ€æ›´æ–°</button>
        <div id="realUpdateResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. äº‹ä»¶ç›‘å¬æµ‹è¯•</h3>
        <button onclick="startStatusEventListening()">å¼€å§‹ç›‘å¬çŠ¶æ€äº‹ä»¶</button>
        <button onclick="stopStatusEventListening()">åœæ­¢ç›‘å¬</button>
        <button onclick="triggerTestStatusEvent()">è§¦å‘æµ‹è¯•äº‹ä»¶</button>
        <div id="statusEventResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let statusEventListening = false;
        let statusEventLog = [];
        
        // çŠ¶æ€è®¡ç®—é€»è¾‘ï¼ˆä¸å‰ç«¯ä¿æŒä¸€è‡´ï¼‰
        function calculateSuggestedStatus(currentStatus, taskQuantity, completedQuantity) {
            if (completedQuantity >= taskQuantity && taskQuantity > 0) {
                return 'å·²å®Œæˆ';
            }
            
            if (completedQuantity > 0 && completedQuantity < taskQuantity && currentStatus !== 'å·²æš‚åœ') {
                return 'è¿›è¡Œä¸­';
            }
            
            if (completedQuantity === 0) {
                return currentStatus === 'å·²æš‚åœ' ? 'å·²æš‚åœ' : 'å¾…ä¸‹å‘';
            }
            
            return currentStatus;
        }
        
        // è·å–çŠ¶æ€æ›´æ–°åŸå› 
        function getStatusUpdateReason(currentStatus, suggestedStatus, taskQuantity, completedQuantity) {
            if (suggestedStatus === 'å·²å®Œæˆ') {
                return `å®Œæˆæ•°é‡ ${completedQuantity} å·²è¾¾åˆ°ä»»åŠ¡æ•°é‡ ${taskQuantity}`;
            }
            
            if (suggestedStatus === 'è¿›è¡Œä¸­') {
                return `å·²æœ‰ç”Ÿäº§è¿›åº¦ ${completedQuantity}/${taskQuantity}`;
            }
            
            if (suggestedStatus === 'å¾…ä¸‹å‘') {
                return 'å°šæœªå¼€å§‹ç”Ÿäº§';
            }
            
            return 'åŸºäºå½“å‰è¿›åº¦çš„å»ºè®®';
        }
        
        // æµ‹è¯•çŠ¶æ€è®¡ç®—
        function testStatusCalculation() {
            const currentStatus = document.getElementById('currentStatus').value;
            const taskQuantity = parseInt(document.getElementById('taskQuantity').value);
            const completedQuantity = parseInt(document.getElementById('completedQuantity').value);
            const resultDiv = document.getElementById('statusResult');
            
            const suggestedStatus = calculateSuggestedStatus(currentStatus, taskQuantity, completedQuantity);
            const reason = getStatusUpdateReason(currentStatus, suggestedStatus, taskQuantity, completedQuantity);
            const needsUpdate = suggestedStatus !== currentStatus;
            
            resultDiv.className = needsUpdate ? 'result warning' : 'result success';
            resultDiv.innerHTML = `çŠ¶æ€è®¡ç®—ç»“æœ:\n\n` +
                                 `å½“å‰çŠ¶æ€: ${currentStatus}\n` +
                                 `ä»»åŠ¡æ•°é‡: ${taskQuantity}\n` +
                                 `å®Œæˆæ•°é‡: ${completedQuantity}\n` +
                                 `å»ºè®®çŠ¶æ€: ${suggestedStatus}\n` +
                                 `éœ€è¦æ›´æ–°: ${needsUpdate ? 'æ˜¯' : 'å¦'}\n` +
                                 `æ›´æ–°åŸå› : ${reason}\n\n` +
                                 `è¿›åº¦ç™¾åˆ†æ¯”: ${taskQuantity > 0 ? Math.round((completedQuantity / taskQuantity) * 100) : 0}%`;
        }
        
        // ç”Ÿæˆæµ‹è¯•åœºæ™¯
        function generateTestScenarios() {
            return [
                { name: 'å¼€å§‹ç”Ÿäº§', currentStatus: 'å¾…ä¸‹å‘', taskQuantity: 100, completedQuantity: 10 },
                { name: 'ç”Ÿäº§è¿›è¡Œä¸­', currentStatus: 'å¾…ä¸‹å‘', taskQuantity: 100, completedQuantity: 50 },
                { name: 'ç”Ÿäº§å®Œæˆ', currentStatus: 'è¿›è¡Œä¸­', taskQuantity: 100, completedQuantity: 100 },
                { name: 'è¶…é¢å®Œæˆ', currentStatus: 'è¿›è¡Œä¸­', taskQuantity: 100, completedQuantity: 105 },
                { name: 'æš‚åœçŠ¶æ€', currentStatus: 'å·²æš‚åœ', taskQuantity: 100, completedQuantity: 30 },
                { name: 'é‡ç½®ä»»åŠ¡', currentStatus: 'å·²å®Œæˆ', taskQuantity: 100, completedQuantity: 0 },
                { name: 'éƒ¨åˆ†å®Œæˆ', currentStatus: 'è¿›è¡Œä¸­', taskQuantity: 200, completedQuantity: 80 }
            ];
        }
        
        // è¿è¡Œæ‰€æœ‰åœºæ™¯æµ‹è¯•
        function runAllScenarios() {
            const scenarios = generateTestScenarios();
            const tableBody = document.getElementById('scenarioTable');
            const resultDiv = document.getElementById('scenarioResult');
            
            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = '';
            
            let results = [];
            
            scenarios.forEach((scenario, index) => {
                const suggestedStatus = calculateSuggestedStatus(
                    scenario.currentStatus, 
                    scenario.taskQuantity, 
                    scenario.completedQuantity
                );
                const needsUpdate = suggestedStatus !== scenario.currentStatus;
                
                // æ·»åŠ è¡¨æ ¼è¡Œ
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${scenario.name}</td>
                    <td><span class="status-item status-${getStatusClass(scenario.currentStatus)}">${scenario.currentStatus}</span></td>
                    <td>${scenario.taskQuantity}</td>
                    <td>${scenario.completedQuantity}</td>
                    <td><span class="status-item status-${getStatusClass(suggestedStatus)}">${suggestedStatus}</span></td>
                    <td>${needsUpdate ? 'ğŸ”„ éœ€è¦æ›´æ–°' : 'âœ… æ— éœ€æ›´æ–°'}</td>
                `;
                
                results.push({
                    scenario: scenario.name,
                    needsUpdate: needsUpdate,
                    from: scenario.currentStatus,
                    to: suggestedStatus
                });
            });
            
            // æ˜¾ç¤ºç»“æœç»Ÿè®¡
            const needsUpdateCount = results.filter(r => r.needsUpdate).length;
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `åœºæ™¯æµ‹è¯•å®Œæˆ!\n\n` +
                                 `æ€»åœºæ™¯æ•°: ${results.length}\n` +
                                 `éœ€è¦æ›´æ–°: ${needsUpdateCount}\n` +
                                 `æ— éœ€æ›´æ–°: ${results.length - needsUpdateCount}\n\n` +
                                 `è¯¦ç»†ç»“æœ:\n` +
                                 results.map(r => 
                                     `${r.scenario}: ${r.needsUpdate ? `${r.from} â†’ ${r.to}` : 'çŠ¶æ€æ­£ç¡®'}`
                                 ).join('\n');
        }
        
        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            const map = {
                'å¾…ä¸‹å‘': 'pending',
                'è¿›è¡Œä¸­': 'in-progress',
                'å·²å®Œæˆ': 'completed',
                'å·²æš‚åœ': 'paused'
            };
            return map[status] || 'pending';
        }
        
        // æµ‹è¯•å®é™…çŠ¶æ€æ›´æ–°
        async function testRealStatusUpdate() {
            const taskId = document.getElementById('testTaskId').value;
            const newStatus = document.getElementById('newStatus').value;
            const resultDiv = document.getElementById('realUpdateResult');
            
            if (!taskId) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ è¯·è¾“å…¥ä»»åŠ¡ID';
                return;
            }
            
            try {
                resultDiv.innerHTML = 'æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸­...\n\n';
                
                const response = await fetch(`${API_BASE}/api/v1/production/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        status: newStatus,
                        reason: 'manual-test-update',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML += `âœ… çŠ¶æ€æ›´æ–°æˆåŠŸ!\n` +
                                          `ä»»åŠ¡ID: ${taskId}\n` +
                                          `æ–°çŠ¶æ€: ${newStatus}\n` +
                                          `æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}`;
                    
                    // è§¦å‘çŠ¶æ€æ›´æ–°äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('task-status-updated', {
                        detail: { 
                            taskId, 
                            newStatus, 
                            timestamp: Date.now(),
                            source: 'test-tool'
                        }
                    }));
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML += `âŒ çŠ¶æ€æ›´æ–°å¤±è´¥!\nçŠ¶æ€ç : ${response.status}`;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
            }
        }
        
        // å¼€å§‹çŠ¶æ€äº‹ä»¶ç›‘å¬
        function startStatusEventListening() {
            if (statusEventListening) return;
            
            statusEventListening = true;
            statusEventLog = [];
            
            const eventHandler = (event) => {
                const logEntry = {
                    timestamp: new Date().toLocaleTimeString(),
                    type: event.type,
                    detail: event.detail
                };
                statusEventLog.push(logEntry);
                updateStatusEventDisplay();
            };
            
            window.addEventListener('task-status-updated', eventHandler);
            
            document.getElementById('statusEventResult').innerHTML = 'ğŸ§ å¼€å§‹ç›‘å¬çŠ¶æ€æ›´æ–°äº‹ä»¶...\n';
        }
        
        // åœæ­¢çŠ¶æ€äº‹ä»¶ç›‘å¬
        function stopStatusEventListening() {
            statusEventListening = false;
            document.getElementById('statusEventResult').innerHTML += '\nâ¹ï¸ åœæ­¢ç›‘å¬çŠ¶æ€äº‹ä»¶\n';
        }
        
        // è§¦å‘æµ‹è¯•çŠ¶æ€äº‹ä»¶
        function triggerTestStatusEvent() {
            window.dispatchEvent(new CustomEvent('task-status-updated', {
                detail: { 
                    taskId: 'TEST001', 
                    newStatus: 'å·²å®Œæˆ', 
                    oldStatus: 'è¿›è¡Œä¸­',
                    timestamp: Date.now(),
                    source: 'manual-test'
                }
            }));
        }
        
        // æ›´æ–°çŠ¶æ€äº‹ä»¶æ˜¾ç¤º
        function updateStatusEventDisplay() {
            const resultDiv = document.getElementById('statusEventResult');
            let display = 'ğŸ§ çŠ¶æ€äº‹ä»¶ç›‘å¬ä¸­...\n\n';
            
            statusEventLog.forEach((log, index) => {
                display += `${index + 1}. [${log.timestamp}] ${log.type}\n`;
                display += `   ä»»åŠ¡ID: ${log.detail.taskId}\n`;
                display += `   æ–°çŠ¶æ€: ${log.detail.newStatus}\n`;
                if (log.detail.oldStatus) {
                    display += `   åŸçŠ¶æ€: ${log.detail.oldStatus}\n`;
                }
                display += `   æ¥æº: ${log.detail.source}\n\n`;
            });
            
            resultDiv.innerHTML = display;
            resultDiv.className = 'result success';
        }
        
        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆåœºæ™¯è¡¨æ ¼
        window.onload = function() {
            runAllScenarios();
        };
    </script>
</body>
</html>