<!DOCTYPE html>
<html>
<head>
    <title>任务状态自动更新测试</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .status-demo { background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .status-flow { display: flex; gap: 20px; margin: 10px 0; align-items: center; }
        .status-item { padding: 10px; border-radius: 4px; text-align: center; min-width: 80px; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-in-progress { background: #dbeafe; color: #2563eb; }
        .status-completed { background: #dcfce7; color: #16a34a; }
        .status-paused { background: #fde68a; color: #b45309; }
        .arrow { font-size: 20px; color: #666; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>任务状态自动更新测试</h1>
    
    <div class="status-demo">
        <h3>🔄 状态转换规则</h3>
        <div class="status-flow">
            <div class="status-item status-pending">待下发</div>
            <div class="arrow">→</div>
            <div class="status-item status-in-progress">进行中</div>
            <div class="arrow">→</div>
            <div class="status-item status-completed">已完成</div>
        </div>
        <div class="status-flow">
            <div class="status-item status-in-progress">进行中</div>
            <div class="arrow">↕</div>
            <div class="status-item status-paused">已暂停</div>
        </div>
        <ul>
            <li><strong>待下发 → 进行中</strong>：完成数量 > 0</li>
            <li><strong>进行中 → 已完成</strong>：完成数量 = 任务数量</li>
            <li><strong>进行中 ↔ 已暂停</strong>：手动控制或设备状态</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>1. 状态计算测试</h3>
        <div>
            <label>当前状态: 
                <select id="currentStatus">
                    <option value="待下发">待下发</option>
                    <option value="进行中">进行中</option>
                    <option value="已完成">已完成</option>
                    <option value="已暂停">已暂停</option>
                </select>
            </label>
            <label>任务数量: <input type="number" id="taskQuantity" value="100" min="1"></label>
            <label>完成数量: <input type="number" id="completedQuantity" value="0" min="0"></label>
        </div>
        <button onclick="testStatusCalculation()">计算建议状态</button>
        <div id="statusResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. 状态转换场景测试</h3>
        <table>
            <thead>
                <tr>
                    <th>场景</th>
                    <th>当前状态</th>
                    <th>任务数量</th>
                    <th>完成数量</th>
                    <th>建议状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="scenarioTable">
                <!-- 动态生成 -->
            </tbody>
        </table>
        <button onclick="runAllScenarios()">运行所有场景测试</button>
        <div id="scenarioResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. 实际任务状态更新测试</h3>
        <div>
            <label>任务ID: <input type="text" id="testTaskId" placeholder="输入任务ID"></label>
            <label>新状态: 
                <select id="newStatus">
                    <option value="待下发">待下发</option>
                    <option value="进行中">进行中</option>
                    <option value="已完成">已完成</option>
                    <option value="已暂停">已暂停</option>
                </select>
            </label>
        </div>
        <button onclick="testRealStatusUpdate()">测试状态更新</button>
        <div id="realUpdateResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. 事件监听测试</h3>
        <button onclick="startStatusEventListening()">开始监听状态事件</button>
        <button onclick="stopStatusEventListening()">停止监听</button>
        <button onclick="triggerTestStatusEvent()">触发测试事件</button>
        <div id="statusEventResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let statusEventListening = false;
        let statusEventLog = [];
        
        // 状态计算逻辑（与前端保持一致）
        function calculateSuggestedStatus(currentStatus, taskQuantity, completedQuantity) {
            if (completedQuantity >= taskQuantity && taskQuantity > 0) {
                return '已完成';
            }
            
            if (completedQuantity > 0 && completedQuantity < taskQuantity && currentStatus !== '已暂停') {
                return '进行中';
            }
            
            if (completedQuantity === 0) {
                return currentStatus === '已暂停' ? '已暂停' : '待下发';
            }
            
            return currentStatus;
        }
        
        // 获取状态更新原因
        function getStatusUpdateReason(currentStatus, suggestedStatus, taskQuantity, completedQuantity) {
            if (suggestedStatus === '已完成') {
                return `完成数量 ${completedQuantity} 已达到任务数量 ${taskQuantity}`;
            }
            
            if (suggestedStatus === '进行中') {
                return `已有生产进度 ${completedQuantity}/${taskQuantity}`;
            }
            
            if (suggestedStatus === '待下发') {
                return '尚未开始生产';
            }
            
            return '基于当前进度的建议';
        }
        
        // 测试状态计算
        function testStatusCalculation() {
            const currentStatus = document.getElementById('currentStatus').value;
            const taskQuantity = parseInt(document.getElementById('taskQuantity').value);
            const completedQuantity = parseInt(document.getElementById('completedQuantity').value);
            const resultDiv = document.getElementById('statusResult');
            
            const suggestedStatus = calculateSuggestedStatus(currentStatus, taskQuantity, completedQuantity);
            const reason = getStatusUpdateReason(currentStatus, suggestedStatus, taskQuantity, completedQuantity);
            const needsUpdate = suggestedStatus !== currentStatus;
            
            resultDiv.className = needsUpdate ? 'result warning' : 'result success';
            resultDiv.innerHTML = `状态计算结果:\n\n` +
                                 `当前状态: ${currentStatus}\n` +
                                 `任务数量: ${taskQuantity}\n` +
                                 `完成数量: ${completedQuantity}\n` +
                                 `建议状态: ${suggestedStatus}\n` +
                                 `需要更新: ${needsUpdate ? '是' : '否'}\n` +
                                 `更新原因: ${reason}\n\n` +
                                 `进度百分比: ${taskQuantity > 0 ? Math.round((completedQuantity / taskQuantity) * 100) : 0}%`;
        }
        
        // 生成测试场景
        function generateTestScenarios() {
            return [
                { name: '开始生产', currentStatus: '待下发', taskQuantity: 100, completedQuantity: 10 },
                { name: '生产进行中', currentStatus: '待下发', taskQuantity: 100, completedQuantity: 50 },
                { name: '生产完成', currentStatus: '进行中', taskQuantity: 100, completedQuantity: 100 },
                { name: '超额完成', currentStatus: '进行中', taskQuantity: 100, completedQuantity: 105 },
                { name: '暂停状态', currentStatus: '已暂停', taskQuantity: 100, completedQuantity: 30 },
                { name: '重置任务', currentStatus: '已完成', taskQuantity: 100, completedQuantity: 0 },
                { name: '部分完成', currentStatus: '进行中', taskQuantity: 200, completedQuantity: 80 }
            ];
        }
        
        // 运行所有场景测试
        function runAllScenarios() {
            const scenarios = generateTestScenarios();
            const tableBody = document.getElementById('scenarioTable');
            const resultDiv = document.getElementById('scenarioResult');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            let results = [];
            
            scenarios.forEach((scenario, index) => {
                const suggestedStatus = calculateSuggestedStatus(
                    scenario.currentStatus, 
                    scenario.taskQuantity, 
                    scenario.completedQuantity
                );
                const needsUpdate = suggestedStatus !== scenario.currentStatus;
                
                // 添加表格行
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${scenario.name}</td>
                    <td><span class="status-item status-${getStatusClass(scenario.currentStatus)}">${scenario.currentStatus}</span></td>
                    <td>${scenario.taskQuantity}</td>
                    <td>${scenario.completedQuantity}</td>
                    <td><span class="status-item status-${getStatusClass(suggestedStatus)}">${suggestedStatus}</span></td>
                    <td>${needsUpdate ? '🔄 需要更新' : '✅ 无需更新'}</td>
                `;
                
                results.push({
                    scenario: scenario.name,
                    needsUpdate: needsUpdate,
                    from: scenario.currentStatus,
                    to: suggestedStatus
                });
            });
            
            // 显示结果统计
            const needsUpdateCount = results.filter(r => r.needsUpdate).length;
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `场景测试完成!\n\n` +
                                 `总场景数: ${results.length}\n` +
                                 `需要更新: ${needsUpdateCount}\n` +
                                 `无需更新: ${results.length - needsUpdateCount}\n\n` +
                                 `详细结果:\n` +
                                 results.map(r => 
                                     `${r.scenario}: ${r.needsUpdate ? `${r.from} → ${r.to}` : '状态正确'}`
                                 ).join('\n');
        }
        
        // 获取状态样式类
        function getStatusClass(status) {
            const map = {
                '待下发': 'pending',
                '进行中': 'in-progress',
                '已完成': 'completed',
                '已暂停': 'paused'
            };
            return map[status] || 'pending';
        }
        
        // 测试实际状态更新
        async function testRealStatusUpdate() {
            const taskId = document.getElementById('testTaskId').value;
            const newStatus = document.getElementById('newStatus').value;
            const resultDiv = document.getElementById('realUpdateResult');
            
            if (!taskId) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 请输入任务ID';
                return;
            }
            
            try {
                resultDiv.innerHTML = '更新任务状态中...\n\n';
                
                const response = await fetch(`${API_BASE}/api/v1/production/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        status: newStatus,
                        reason: 'manual-test-update',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML += `✅ 状态更新成功!\n` +
                                          `任务ID: ${taskId}\n` +
                                          `新状态: ${newStatus}\n` +
                                          `更新时间: ${new Date().toLocaleString()}`;
                    
                    // 触发状态更新事件
                    window.dispatchEvent(new CustomEvent('task-status-updated', {
                        detail: { 
                            taskId, 
                            newStatus, 
                            timestamp: Date.now(),
                            source: 'test-tool'
                        }
                    }));
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML += `❌ 状态更新失败!\n状态码: ${response.status}`;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += '❌ 网络错误: ' + error.message;
            }
        }
        
        // 开始状态事件监听
        function startStatusEventListening() {
            if (statusEventListening) return;
            
            statusEventListening = true;
            statusEventLog = [];
            
            const eventHandler = (event) => {
                const logEntry = {
                    timestamp: new Date().toLocaleTimeString(),
                    type: event.type,
                    detail: event.detail
                };
                statusEventLog.push(logEntry);
                updateStatusEventDisplay();
            };
            
            window.addEventListener('task-status-updated', eventHandler);
            
            document.getElementById('statusEventResult').innerHTML = '🎧 开始监听状态更新事件...\n';
        }
        
        // 停止状态事件监听
        function stopStatusEventListening() {
            statusEventListening = false;
            document.getElementById('statusEventResult').innerHTML += '\n⏹️ 停止监听状态事件\n';
        }
        
        // 触发测试状态事件
        function triggerTestStatusEvent() {
            window.dispatchEvent(new CustomEvent('task-status-updated', {
                detail: { 
                    taskId: 'TEST001', 
                    newStatus: '已完成', 
                    oldStatus: '进行中',
                    timestamp: Date.now(),
                    source: 'manual-test'
                }
            }));
        }
        
        // 更新状态事件显示
        function updateStatusEventDisplay() {
            const resultDiv = document.getElementById('statusEventResult');
            let display = '🎧 状态事件监听中...\n\n';
            
            statusEventLog.forEach((log, index) => {
                display += `${index + 1}. [${log.timestamp}] ${log.type}\n`;
                display += `   任务ID: ${log.detail.taskId}\n`;
                display += `   新状态: ${log.detail.newStatus}\n`;
                if (log.detail.oldStatus) {
                    display += `   原状态: ${log.detail.oldStatus}\n`;
                }
                display += `   来源: ${log.detail.source}\n\n`;
            });
            
            resultDiv.innerHTML = display;
            resultDiv.className = 'result success';
        }
        
        // 页面加载时生成场景表格
        window.onload = function() {
            runAllScenarios();
        };
    </script>
</body>
</html>