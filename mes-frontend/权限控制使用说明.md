# MES系统权限控制使用说明

## 功能概述

本系统实现了完整的页面访问权限控制功能，包括：

1. **URL直接访问拦截** - 防止未登录用户通过地址栏直接访问受保护页面
2. **Token自动验证** - 自动检查登录状态和token有效性
3. **路由级权限控制** - 在路由层面进行权限验证
4. **组件级权限控制** - 支持页面内元素的权限控制
5. **访问监控** - 记录页面访问日志，监控非法访问尝试

## 核心特性

### 1. 路由权限控制

所有路由默认需要登录认证，可通过 `meta.requiresAuth: false` 设置为公开访问：

```javascript
{
  path: '/login',
  component: Login,
  meta: { 
    requiresAuth: false,  // 不需要登录
    title: '用户登录'
  }
}
```

### 2. 自动token验证

- 页面刷新时自动检查token有效性
- token过期自动跳转到登录页
- 保存原始访问路径，登录后自动跳转回去

### 3. HTTP请求拦截

- 自动在请求头添加Authorization token
- 401/403错误自动处理
- 网络错误友好提示

## 使用方法

### 1. 在模板中使用权限指令

```vue
<template>
  <!-- 权限控制按钮显示 -->
  <el-button v-permission="'user:create'">创建用户</el-button>
  
  <!-- 角色控制 -->
  <el-button v-role="'admin'">管理员功能</el-button>
  
  <!-- 复合权限控制 -->
  <div v-auth="{ permissions: ['user:create'], roles: ['admin'] }">
    管理员或有创建权限的用户可见
  </div>
</template>
```

### 2. 在脚本中使用权限函数

```javascript
import { hasPermission, hasRole, getCurrentUser } from '@/utils/auth'

export default {
  setup() {
    // 检查权限
    const canCreate = hasPermission('user:create')
    const isAdmin = hasRole('admin')
    const currentUser = getCurrentUser()
    
    return {
      canCreate,
      isAdmin,
      currentUser
    }
  }
}
```

### 3. 页面级权限控制

```vue
<template>
  <AuthGuard :permissions="['user:manage']" :roles="['admin']">
    <div>需要用户管理权限或管理员角色才能看到的内容</div>
  </AuthGuard>
</template>

<script setup>
import AuthGuard from '@/components/AuthGuard.vue'
</script>
```

## 安全特性

### 1. 防止直接URL访问

- 未登录用户访问受保护页面自动跳转到登录页
- 保存原始访问路径，登录后自动跳转回去
- 显示友好的权限提示信息

### 2. Token安全管理

- JWT token自动过期检查
- 页面可见性变化时重新验证
- 安全退出清除所有本地数据

### 3. 访问监控

- 记录所有页面访问日志
- 监控未授权访问尝试
- 支持发送访问日志到后端

## 配置说明

### 1. 环境变量配置

```bash
# .env
VITE_API_BASE_URL=http://localhost:8080
VITE_APP_TITLE=MES智能生产系统
VITE_TOKEN_KEY=mes_token
VITE_USER_KEY=mes_user
```

### 2. 路由配置

```javascript
// router/index.js
{
  path: '/protected-page',
  component: ProtectedPage,
  meta: {
    requiresAuth: true,        // 需要登录
    title: '受保护页面',
    permissions: ['read'],     // 需要的权限（可选）
    roles: ['user']           // 需要的角色（可选）
  }
}
```

## 最佳实践

### 1. 权限设计

- 使用细粒度权限控制（如 `user:create`, `user:update`）
- 合理设计角色层次（如 `admin` > `manager` > `user`）
- 权限和角色可以组合使用

### 2. 错误处理

- 提供友好的权限不足提示
- 引导用户进行正确的操作流程
- 记录权限相关的错误日志

### 3. 性能优化

- 权限信息缓存在本地存储
- 避免频繁的权限检查请求
- 使用计算属性缓存权限判断结果

## 故障排除

### 1. 登录后仍然跳转到登录页

检查：
- token是否正确保存到localStorage
- token格式是否正确（JWT格式）
- 后端是否正确返回token

### 2. 权限指令不生效

检查：
- 用户信息中是否包含permissions/roles字段
- 权限名称是否匹配
- 指令是否正确注册

### 3. 页面刷新后丢失登录状态

检查：
- localStorage中是否保存了token
- token是否过期
- initAuth()是否正确调用

## 扩展功能

系统支持以下扩展：

1. **动态权限加载** - 从后端动态获取用户权限
2. **权限缓存策略** - 实现权限信息的缓存机制
3. **多租户支持** - 支持多租户的权限隔离
4. **审计日志** - 详细的权限操作审计日志

通过以上配置，你的MES系统现在具备了完整的页面访问权限控制功能，可以有效防止未授权访问，确保系统安全。