<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–å›¾æ¡ˆåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; }
        .btn-success:hover { background: #73d13d; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .warning {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #faad14;
        }
        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ ç®€åŒ–å›¾æ¡ˆåŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ åŠŸèƒ½è¯´æ˜</h3>
            <p>ç®€åŒ–åçš„å›¾æ¡ˆä¸Šä¼ åŠŸèƒ½åŒ…æ‹¬ï¼š</p>
            <ul>
                <li>âœ… å›¾ç‰‡URLè¾“å…¥ï¼ˆæ”¯æŒå¤–éƒ¨é“¾æ¥ï¼‰</li>
                <li>âœ… æœåŠ¡å™¨è·¯å¾„é€‰æ‹©ï¼ˆé¢„è®¾å¸¸ç”¨è·¯å¾„ï¼‰</li>
                <li>âŒ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ˆå·²ç§»é™¤ï¼Œé¿å…CORSé—®é¢˜ï¼‰</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª å›¾æ¡ˆåˆ›å»ºæµ‹è¯•</h3>
            <form id="pattern-form">
                <div class="form-group">
                    <label for="pattern-code">å›¾æ¡ˆç¼–å·:</label>
                    <input type="text" id="pattern-code" value="PAT-TEST-001" required>
                </div>
                
                <div class="form-group">
                    <label for="pattern-name">å›¾æ¡ˆåç§°:</label>
                    <input type="text" id="pattern-name" value="æµ‹è¯•å›¾æ¡ˆ" required>
                </div>
                
                <div class="form-group">
                    <label for="machine-model">é€‚ç”¨æœºå‹:</label>
                    <select id="machine-model">
                        <option value="A">å°åˆ·æœº A</option>
                        <option value="B">å°åˆ·æœº B</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å›¾ç‰‡æ¥æº:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="image-type" value="url" checked> å›¾ç‰‡URL</label>
                        <label><input type="radio" name="image-type" value="path"> æœåŠ¡å™¨è·¯å¾„</label>
                    </div>
                </div>
                
                <div class="form-group" id="url-input">
                    <label for="image-url">å›¾ç‰‡URL:</label>
                    <input type="url" id="image-url" placeholder="https://example.com/image.jpg">
                    <button type="button" class="btn" onclick="previewImage()">é¢„è§ˆ</button>
                </div>
                
                <div class="form-group" id="path-input" style="display: none;">
                    <label for="image-path">æœåŠ¡å™¨è·¯å¾„:</label>
                    <select id="image-path">
                        <option value="">è¯·é€‰æ‹©å›¾ç‰‡è·¯å¾„</option>
                        <option value="/uploads/patterns/4106e9db-40d5-4922-96d8-3240a6c99e3f_R-C (1).jpg">å‡ ä½•æ˜Ÿç©ºå›¾æ¡ˆ</option>
                        <option value="/uploads/patterns/deeaa61e-3742-40dc-9e41-3507caf50e5e_R-C.jpg">å¤§ç†çŸ³çº¹ç†</option>
                        <option value="/uploads/patterns/819aad2c-5506-4a54-9288-1836982876ed_2126.png_860.png">ä¸­å›½é£ç¥¥äº‘</option>
                        <option value="/uploads/patterns/test-pattern-1.jpg">æµ‹è¯•å›¾æ¡ˆ1</option>
                        <option value="/uploads/patterns/test-pattern-2.png">æµ‹è¯•å›¾æ¡ˆ2</option>
                    </select>
                    <button type="button" class="btn" onclick="previewImage()">é¢„è§ˆ</button>
                </div>
                
                <div id="image-preview" class="image-preview"></div>
                
                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="createPattern()">åˆ›å»ºå›¾æ¡ˆ</button>
                    <button type="button" class="btn" onclick="resetForm()">é‡ç½®è¡¨å•</button>
                </div>
            </form>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç°æœ‰å›¾æ¡ˆåˆ—è¡¨</h3>
            <button class="btn" onclick="loadPatterns()">åŠ è½½å›¾æ¡ˆåˆ—è¡¨</button>
            <div id="patterns-list"></div>
        </div>

        <div id="status"></div>
    </div>

    <script>
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // åˆ‡æ¢å›¾ç‰‡è¾“å…¥æ–¹å¼
        document.querySelectorAll('input[name="image-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const urlInput = document.getElementById('url-input');
                const pathInput = document.getElementById('path-input');
                
                if (this.value === 'url') {
                    urlInput.style.display = 'block';
                    pathInput.style.display = 'none';
                } else {
                    urlInput.style.display = 'none';
                    pathInput.style.display = 'block';
                }
                
                // æ¸…é™¤é¢„è§ˆ
                document.getElementById('image-preview').innerHTML = '';
            });
        });

        // è·å–å›¾ç‰‡URL
        function getImageUrl(path) {
            if (!path) return '';
            
            if (path.startsWith('http://') || path.startsWith('https://')) {
                return path;
            }
            
            return `http://localhost:8080${path}`;
        }

        // é¢„è§ˆå›¾ç‰‡
        function previewImage() {
            const imageType = document.querySelector('input[name="image-type"]:checked').value;
            let imageUrl = '';
            
            if (imageType === 'url') {
                imageUrl = document.getElementById('image-url').value;
            } else {
                const path = document.getElementById('image-path').value;
                imageUrl = getImageUrl(path);
            }
            
            if (!imageUrl) {
                showStatus('è¯·è¾“å…¥å›¾ç‰‡URLæˆ–é€‰æ‹©å›¾ç‰‡è·¯å¾„', 'warning');
                return;
            }
            
            const previewDiv = document.getElementById('image-preview');
            previewDiv.innerHTML = `
                <div>
                    <p>å›¾ç‰‡é¢„è§ˆ:</p>
                    <img src="${imageUrl}" alt="å›¾ç‰‡é¢„è§ˆ" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; color: red;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                    <p style="font-size: 12px; color: #666;">URL: ${imageUrl}</p>
                </div>
            `;
        }

        // åˆ›å»ºå›¾æ¡ˆ
        async function createPattern() {
            try {
                const patternCode = document.getElementById('pattern-code').value;
                const patternName = document.getElementById('pattern-name').value;
                const machineModel = document.getElementById('machine-model').value;
                
                if (!patternCode || !patternName) {
                    showStatus('è¯·å¡«å†™å›¾æ¡ˆç¼–å·å’Œåç§°', 'warning');
                    return;
                }
                
                const imageType = document.querySelector('input[name="image-type"]:checked').value;
                let imageUrl = '';
                
                if (imageType === 'url') {
                    imageUrl = document.getElementById('image-url').value;
                } else {
                    imageUrl = document.getElementById('image-path').value;
                }
                
                const patternData = {
                    patternCode: patternCode,
                    patternName: patternName,
                    machineModel: machineModel,
                    imageUrl: imageUrl,
                    defaultPrintSpeed: 1000,
                    defaultPressure: 2.5,
                    planId: 'TEST-PLAN-001',
                    taskId: 'TEST-TASK-001',
                    deviceId: 'TEST-DEVICE-001'
                };
                
                showStatus('æ­£åœ¨åˆ›å»ºå›¾æ¡ˆ...', 'warning');
                
                const response = await fetch('/api/v1/process/print-patterns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patternData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('âœ… å›¾æ¡ˆåˆ›å»ºæˆåŠŸï¼', 'success');
                    console.log('åˆ›å»ºç»“æœ:', result);
                    
                    // é‡æ–°åŠ è½½å›¾æ¡ˆåˆ—è¡¨
                    setTimeout(loadPatterns, 1000);
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('åˆ›å»ºå›¾æ¡ˆå¤±è´¥:', error);
                showStatus(`âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½å›¾æ¡ˆåˆ—è¡¨
        async function loadPatterns() {
            try {
                showStatus('æ­£åœ¨åŠ è½½å›¾æ¡ˆåˆ—è¡¨...', 'warning');
                
                const response = await fetch('/api/v1/process/print-patterns/all?page=0&size=10');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const patterns = data.content || [];
                
                let html = '<div style="margin-top: 15px;">';
                
                if (patterns.length === 0) {
                    html += '<p>æš‚æ— å›¾æ¡ˆæ•°æ®</p>';
                } else {
                    html += `<p>å…±æ‰¾åˆ° ${patterns.length} ä¸ªå›¾æ¡ˆ:</p>`;
                    patterns.forEach(pattern => {
                        const imageUrl = getImageUrl(pattern.imageUrl);
                        html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="${imageUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+Cjx0ZXh0IHg9IjMwIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7ml6Dlm77niYc8L3RleHQ+Cjwvc3ZnPgo='">
                                    <div>
                                        <div><strong>${pattern.patternName}</strong> (${pattern.patternCode})</div>
                                        <div style="font-size: 12px; color: #666;">æœºå‹: ${pattern.machineModel}</div>
                                        <div style="font-size: 12px; color: #666;">å›¾ç‰‡: ${pattern.imageUrl || 'æ— '}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('patterns-list').innerHTML = html;
                
                showStatus(`âœ… æˆåŠŸåŠ è½½ ${patterns.length} ä¸ªå›¾æ¡ˆ`, 'success');
                
            } catch (error) {
                console.error('åŠ è½½å›¾æ¡ˆåˆ—è¡¨å¤±è´¥:', error);
                showStatus(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('patterns-list').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('pattern-form').reset();
            document.getElementById('image-preview').innerHTML = '';
            document.querySelector('input[name="image-type"][value="url"]').checked = true;
            document.getElementById('url-input').style.display = 'block';
            document.getElementById('path-input').style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å›¾æ¡ˆåˆ—è¡¨
        window.onload = function() {
            showStatus('ğŸ¨ ç®€åŒ–å›¾æ¡ˆåŠŸèƒ½æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            loadPatterns();
        };
    </script>
</body>
</html>