<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简化图案功能测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; }
        .btn-success:hover { background: #73d13d; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .warning {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #faad14;
        }
        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 简化图案功能测试</h1>
        
        <div class="test-section">
            <h3>📋 功能说明</h3>
            <p>简化后的图案上传功能包括：</p>
            <ul>
                <li>✅ 图片URL输入（支持外部链接）</li>
                <li>✅ 服务器路径选择（预设常用路径）</li>
                <li>❌ 文件上传功能（已移除，避免CORS问题）</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🧪 图案创建测试</h3>
            <form id="pattern-form">
                <div class="form-group">
                    <label for="pattern-code">图案编号:</label>
                    <input type="text" id="pattern-code" value="PAT-TEST-001" required>
                </div>
                
                <div class="form-group">
                    <label for="pattern-name">图案名称:</label>
                    <input type="text" id="pattern-name" value="测试图案" required>
                </div>
                
                <div class="form-group">
                    <label for="machine-model">适用机型:</label>
                    <select id="machine-model">
                        <option value="A">印刷机 A</option>
                        <option value="B">印刷机 B</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>图片来源:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="image-type" value="url" checked> 图片URL</label>
                        <label><input type="radio" name="image-type" value="path"> 服务器路径</label>
                    </div>
                </div>
                
                <div class="form-group" id="url-input">
                    <label for="image-url">图片URL:</label>
                    <input type="url" id="image-url" placeholder="https://example.com/image.jpg">
                    <button type="button" class="btn" onclick="previewImage()">预览</button>
                </div>
                
                <div class="form-group" id="path-input" style="display: none;">
                    <label for="image-path">服务器路径:</label>
                    <select id="image-path">
                        <option value="">请选择图片路径</option>
                        <option value="/uploads/patterns/4106e9db-40d5-4922-96d8-3240a6c99e3f_R-C (1).jpg">几何星空图案</option>
                        <option value="/uploads/patterns/deeaa61e-3742-40dc-9e41-3507caf50e5e_R-C.jpg">大理石纹理</option>
                        <option value="/uploads/patterns/819aad2c-5506-4a54-9288-1836982876ed_2126.png_860.png">中国风祥云</option>
                        <option value="/uploads/patterns/test-pattern-1.jpg">测试图案1</option>
                        <option value="/uploads/patterns/test-pattern-2.png">测试图案2</option>
                    </select>
                    <button type="button" class="btn" onclick="previewImage()">预览</button>
                </div>
                
                <div id="image-preview" class="image-preview"></div>
                
                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="createPattern()">创建图案</button>
                    <button type="button" class="btn" onclick="resetForm()">重置表单</button>
                </div>
            </form>
        </div>

        <div class="test-section">
            <h3>📊 现有图案列表</h3>
            <button class="btn" onclick="loadPatterns()">加载图案列表</button>
            <div id="patterns-list"></div>
        </div>

        <div id="status"></div>
    </div>

    <script>
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // 切换图片输入方式
        document.querySelectorAll('input[name="image-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const urlInput = document.getElementById('url-input');
                const pathInput = document.getElementById('path-input');
                
                if (this.value === 'url') {
                    urlInput.style.display = 'block';
                    pathInput.style.display = 'none';
                } else {
                    urlInput.style.display = 'none';
                    pathInput.style.display = 'block';
                }
                
                // 清除预览
                document.getElementById('image-preview').innerHTML = '';
            });
        });

        // 获取图片URL
        function getImageUrl(path) {
            if (!path) return '';
            
            if (path.startsWith('http://') || path.startsWith('https://')) {
                return path;
            }
            
            return `http://localhost:8080${path}`;
        }

        // 预览图片
        function previewImage() {
            const imageType = document.querySelector('input[name="image-type"]:checked').value;
            let imageUrl = '';
            
            if (imageType === 'url') {
                imageUrl = document.getElementById('image-url').value;
            } else {
                const path = document.getElementById('image-path').value;
                imageUrl = getImageUrl(path);
            }
            
            if (!imageUrl) {
                showStatus('请输入图片URL或选择图片路径', 'warning');
                return;
            }
            
            const previewDiv = document.getElementById('image-preview');
            previewDiv.innerHTML = `
                <div>
                    <p>图片预览:</p>
                    <img src="${imageUrl}" alt="图片预览" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; color: red;">图片加载失败</div>
                    <p style="font-size: 12px; color: #666;">URL: ${imageUrl}</p>
                </div>
            `;
        }

        // 创建图案
        async function createPattern() {
            try {
                const patternCode = document.getElementById('pattern-code').value;
                const patternName = document.getElementById('pattern-name').value;
                const machineModel = document.getElementById('machine-model').value;
                
                if (!patternCode || !patternName) {
                    showStatus('请填写图案编号和名称', 'warning');
                    return;
                }
                
                const imageType = document.querySelector('input[name="image-type"]:checked').value;
                let imageUrl = '';
                
                if (imageType === 'url') {
                    imageUrl = document.getElementById('image-url').value;
                } else {
                    imageUrl = document.getElementById('image-path').value;
                }
                
                const patternData = {
                    patternCode: patternCode,
                    patternName: patternName,
                    machineModel: machineModel,
                    imageUrl: imageUrl,
                    defaultPrintSpeed: 1000,
                    defaultPressure: 2.5,
                    planId: 'TEST-PLAN-001',
                    taskId: 'TEST-TASK-001',
                    deviceId: 'TEST-DEVICE-001'
                };
                
                showStatus('正在创建图案...', 'warning');
                
                const response = await fetch('/api/v1/process/print-patterns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patternData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('✅ 图案创建成功！', 'success');
                    console.log('创建结果:', result);
                    
                    // 重新加载图案列表
                    setTimeout(loadPatterns, 1000);
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('创建图案失败:', error);
                showStatus(`❌ 创建失败: ${error.message}`, 'error');
            }
        }

        // 加载图案列表
        async function loadPatterns() {
            try {
                showStatus('正在加载图案列表...', 'warning');
                
                const response = await fetch('/api/v1/process/print-patterns/all?page=0&size=10');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const patterns = data.content || [];
                
                let html = '<div style="margin-top: 15px;">';
                
                if (patterns.length === 0) {
                    html += '<p>暂无图案数据</p>';
                } else {
                    html += `<p>共找到 ${patterns.length} 个图案:</p>`;
                    patterns.forEach(pattern => {
                        const imageUrl = getImageUrl(pattern.imageUrl);
                        html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="${imageUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+Cjx0ZXh0IHg9IjMwIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7ml6Dlm77niYc8L3RleHQ+Cjwvc3ZnPgo='">
                                    <div>
                                        <div><strong>${pattern.patternName}</strong> (${pattern.patternCode})</div>
                                        <div style="font-size: 12px; color: #666;">机型: ${pattern.machineModel}</div>
                                        <div style="font-size: 12px; color: #666;">图片: ${pattern.imageUrl || '无'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('patterns-list').innerHTML = html;
                
                showStatus(`✅ 成功加载 ${patterns.length} 个图案`, 'success');
                
            } catch (error) {
                console.error('加载图案列表失败:', error);
                showStatus(`❌ 加载失败: ${error.message}`, 'error');
                document.getElementById('patterns-list').innerHTML = 
                    `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 重置表单
        function resetForm() {
            document.getElementById('pattern-form').reset();
            document.getElementById('image-preview').innerHTML = '';
            document.querySelector('input[name="image-type"][value="url"]').checked = true;
            document.getElementById('url-input').style.display = 'block';
            document.getElementById('path-input').style.display = 'none';
        }

        // 页面加载时自动加载图案列表
        window.onload = function() {
            showStatus('🎨 简化图案功能测试工具已加载', 'success');
            loadPatterns();
        };
    </script>
</body>
</html>