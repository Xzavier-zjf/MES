<!DOCTYPE html>
<html>
<head>
    <title>注塑参数更新测试</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input, select { padding: 5px; margin: 5px; width: 200px; }
        label { display: inline-block; width: 120px; }
    </style>
</head>
<body>
    <h1>注塑参数更新测试</h1>
    
    <div class="test-section">
        <h3>1. 获取现有参数</h3>
        <button onclick="fetchParams()">获取参数列表</button>
        <div id="paramsList" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. 选择要更新的参数</h3>
        <label>参数ID: <input type="number" id="paramId" placeholder="输入要更新的参数ID"></label><br>
        <button onclick="loadParamForEdit()">加载参数详情</button>
        <div id="loadResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. 更新参数数据</h3>
        <div>
            <label>注塑压力: <input type="number" id="pressure" step="0.1"></label><br>
            <label>注塑速度: <input type="number" id="injectionSpeed" step="0.1"></label><br>
            <label>保压时间: <input type="number" id="holdTime" step="0.1"></label><br>
            <label>冷却时间: <input type="number" id="coolingTime" step="0.1"></label><br>
            <label>模具温度: <input type="number" id="moldTemperature" step="0.1"></label><br>
            <label>料筒温度: <input type="number" id="materialTemperature" step="0.1"></label><br>
        </div>
        <button onclick="testUpdate()">测试更新</button>
        <div id="updateResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1/process/injection-params';
        
        async function fetchParams() {
            const resultDiv = document.getElementById('paramsList');
            
            try {
                resultDiv.innerHTML = '获取参数列表中...';
                
                const response = await fetch(API_BASE + '/all?page=0&size=10');
                const responseData = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✅ 获取成功!\n\n' + JSON.stringify(responseData, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ 获取失败!\n\n状态码: ' + response.status + 
                                         '\n\n错误响应:\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 网络错误!\n\n' + error.message;
            }
        }
        
        async function loadParamForEdit() {
            const paramId = document.getElementById('paramId').value;
            const resultDiv = document.getElementById('loadResult');
            
            if (!paramId) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 请输入参数ID';
                return;
            }
            
            try {
                resultDiv.innerHTML = '加载参数详情中...';
                
                const response = await fetch(`${API_BASE}/${paramId}`);
                const responseData = await response.json();
                
                if (response.ok) {
                    // 填充表单
                    document.getElementById('pressure').value = responseData.pressure || '';
                    document.getElementById('injectionSpeed').value = responseData.injectionSpeed || '';
                    document.getElementById('holdTime').value = responseData.holdTime || '';
                    document.getElementById('coolingTime').value = responseData.coolingTime || '';
                    document.getElementById('moldTemperature').value = responseData.moldTemperature || '';
                    document.getElementById('materialTemperature').value = responseData.materialTemperature || '';
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✅ 加载成功!\n\n' + JSON.stringify(responseData, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ 加载失败!\n\n状态码: ' + response.status + 
                                         '\n\n错误响应:\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 网络错误!\n\n' + error.message;
            }
        }
        
        async function testUpdate() {
            const paramId = document.getElementById('paramId').value;
            const resultDiv = document.getElementById('updateResult');
            
            if (!paramId) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 请先选择要更新的参数ID';
                return;
            }
            
            const updateData = {
                pressure: parseFloat(document.getElementById('pressure').value) || null,
                injectionSpeed: parseFloat(document.getElementById('injectionSpeed').value) || null,
                holdTime: parseFloat(document.getElementById('holdTime').value) || null,
                coolingTime: parseFloat(document.getElementById('coolingTime').value) || null,
                moldTemperature: parseFloat(document.getElementById('moldTemperature').value) || null,
                materialTemperature: parseFloat(document.getElementById('materialTemperature').value) || null
            };
            
            try {
                resultDiv.innerHTML = '发送更新请求中...\n更新数据:\n' + JSON.stringify(updateData, null, 2);
                
                const response = await fetch(`${API_BASE}/${paramId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✅ 更新成功!\n\n更新数据:\n' + JSON.stringify(updateData, null, 2) + 
                                         '\n\n响应数据:\n' + JSON.stringify(responseData, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ 更新失败!\n\n状态码: ' + response.status + 
                                         '\n\n更新数据:\n' + JSON.stringify(updateData, null, 2) + 
                                         '\n\n错误响应:\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 网络错误!\n\n' + error.message + 
                                     '\n\n更新数据:\n' + JSON.stringify(updateData, null, 2);
            }
        }
    </script>
</body>
</html>