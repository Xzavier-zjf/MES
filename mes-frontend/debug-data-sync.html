<!DOCTYPE html>
<html>
<head>
    <title>æ•°æ®åŒæ­¥çŠ¶æ€æ£€æŸ¥å·¥å…·</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .data-comparison { display: flex; gap: 20px; }
        .data-column { flex: 1; }
        .sync-issue { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>æ•°æ®åŒæ­¥çŠ¶æ€æ£€æŸ¥å·¥å…·</h1>
    
    <div class="debug-section">
        <h3>ğŸ” é—®é¢˜è¯Šæ–­</h3>
        <p><strong>é—®é¢˜æè¿°</strong>ï¼šæ›´æ–°ä»»åŠ¡æ•°é‡åï¼Œæ³¨å¡‘å·¥è‰ºå‚æ•°é¡µé¢çš„ä»»åŠ¡æ•°é‡æ˜¾ç¤ºä»ç„¶æ˜¯åŸæ¥çš„æ•°é‡</p>
        <p><strong>å¯èƒ½åŸå› </strong>ï¼š</p>
        <ul>
            <li>å‰ç«¯ç¼“å­˜æ²¡æœ‰æ›´æ–°</li>
            <li>taskDetailsMap æ²¡æœ‰æ­£ç¡®æ›´æ–°</li>
            <li>æ³¨å¡‘å‚æ•°åˆ—è¡¨æ²¡æœ‰é‡æ–°è·å–</li>
            <li>åç«¯æ•°æ®æ›´æ–°å¤±è´¥</li>
        </ul>
    </div>
    
    <div class="debug-section">
        <h3>1. è·å–ä»»åŠ¡æ•°æ®</h3>
        <button onclick="fetchTasksData()">è·å–ä»»åŠ¡åˆ—è¡¨</button>
        <div id="tasksResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. è·å–æ³¨å¡‘å‚æ•°æ•°æ®</h3>
        <button onclick="fetchInjectionParamsData()">è·å–æ³¨å¡‘å‚æ•°åˆ—è¡¨</button>
        <div id="paramsResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>3. æ•°æ®å¯¹æ¯”åˆ†æ</h3>
        <button onclick="compareData()">å¯¹æ¯”ä»»åŠ¡æ•°é‡ä¸å‚æ•°æ•°é‡</button>
        <div id="comparisonResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. æµ‹è¯•æ•°æ®æ›´æ–°</h3>
        <div>
            <label>ä»»åŠ¡ID: <input type="text" id="testTaskId" placeholder="è¾“å…¥ä»»åŠ¡ID"></label>
            <label>æ–°æ•°é‡: <input type="number" id="testQuantity" placeholder="è¾“å…¥æ–°æ•°é‡" min="1"></label>
        </div>
        <button onclick="testUpdateAndCheck()">æ›´æ–°å¹¶æ£€æŸ¥æ•°æ®åŒæ­¥</button>
        <div id="updateTestResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let tasksData = null;
        let paramsData = null;
        
        async function fetchTasksData() {
            const resultDiv = document.getElementById('tasksResult');
            
            try {
                resultDiv.innerHTML = 'è·å–ä»»åŠ¡æ•°æ®ä¸­...';
                
                const response = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=100`);
                const responseData = await response.json();
                
                if (response.ok) {
                    tasksData = responseData;
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = 'âœ… ä»»åŠ¡æ•°æ®è·å–æˆåŠŸ!\n\n' + 
                                         `æ€»æ•°: ${responseData.totalElements}\n` +
                                         `å½“å‰é¡µ: ${responseData.content?.length || 0} æ¡\n\n` +
                                         JSON.stringify(responseData, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = 'âŒ è·å–ä»»åŠ¡æ•°æ®å¤±è´¥!\n\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯!\n\n' + error.message;
            }
        }
        
        async function fetchInjectionParamsData() {
            const resultDiv = document.getElementById('paramsResult');
            
            try {
                resultDiv.innerHTML = 'è·å–æ³¨å¡‘å‚æ•°æ•°æ®ä¸­...';
                
                const response = await fetch(`${API_BASE}/api/v1/process/injection-params/all?page=0&size=100`);
                const responseData = await response.json();
                
                if (response.ok) {
                    paramsData = responseData;
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = 'âœ… æ³¨å¡‘å‚æ•°æ•°æ®è·å–æˆåŠŸ!\n\n' + 
                                         `æ€»æ•°: ${responseData.totalElements}\n` +
                                         `å½“å‰é¡µ: ${responseData.content?.length || 0} æ¡\n\n` +
                                         JSON.stringify(responseData, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = 'âŒ è·å–æ³¨å¡‘å‚æ•°æ•°æ®å¤±è´¥!\n\n' + JSON.stringify(responseData, null, 2);
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯!\n\n' + error.message;
            }
        }
        
        async function compareData() {
            const resultDiv = document.getElementById('comparisonResult');
            
            if (!tasksData || !paramsData) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = 'âš ï¸ è¯·å…ˆè·å–ä»»åŠ¡æ•°æ®å’Œæ³¨å¡‘å‚æ•°æ•°æ®';
                return;
            }
            
            try {
                const tasks = tasksData.content || [];
                const params = paramsData.content || [];
                
                // åˆ›å»ºä»»åŠ¡æ˜ å°„
                const taskMap = {};
                tasks.forEach(task => {
                    taskMap[task.id] = task;
                });
                
                // åˆ†ææ•°æ®ä¸€è‡´æ€§
                const analysis = {
                    totalParams: params.length,
                    matchedQuantities: 0,
                    mismatchedQuantities: 0,
                    missingTasks: 0,
                    issues: []
                };
                
                params.forEach(param => {
                    const task = taskMap[param.taskId];
                    
                    if (!task) {
                        analysis.missingTasks++;
                        analysis.issues.push({
                            type: 'missing_task',
                            paramId: param.id,
                            taskId: param.taskId,
                            message: `å‚æ•° ${param.id} å…³è”çš„ä»»åŠ¡ ${param.taskId} ä¸å­˜åœ¨`
                        });
                    } else {
                        if (param.quantity === task.quantity) {
                            analysis.matchedQuantities++;
                        } else {
                            analysis.mismatchedQuantities++;
                            analysis.issues.push({
                                type: 'quantity_mismatch',
                                paramId: param.id,
                                taskId: param.taskId,
                                paramQuantity: param.quantity,
                                taskQuantity: task.quantity,
                                message: `å‚æ•° ${param.id} æ•°é‡ ${param.quantity} ä¸ä»»åŠ¡ ${param.taskId} æ•°é‡ ${task.quantity} ä¸åŒ¹é…`
                            });
                        }
                    }
                });
                
                resultDiv.className = analysis.issues.length > 0 ? 'result warning' : 'result success';
                resultDiv.innerHTML = `ğŸ“Š æ•°æ®å¯¹æ¯”åˆ†æç»“æœ:\n\n` +
                                     `æ€»å‚æ•°æ•°: ${analysis.totalParams}\n` +
                                     `æ•°é‡åŒ¹é…: ${analysis.matchedQuantities}\n` +
                                     `æ•°é‡ä¸åŒ¹é…: ${analysis.mismatchedQuantities}\n` +
                                     `ç¼ºå¤±ä»»åŠ¡: ${analysis.missingTasks}\n\n`;
                
                if (analysis.issues.length > 0) {
                    resultDiv.innerHTML += `ğŸš¨ å‘ç° ${analysis.issues.length} ä¸ªé—®é¢˜:\n\n`;
                    analysis.issues.forEach((issue, index) => {
                        resultDiv.innerHTML += `${index + 1}. ${issue.message}\n`;
                    });
                } else {
                    resultDiv.innerHTML += `âœ… æ‰€æœ‰æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡!`;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ æ•°æ®å¯¹æ¯”åˆ†æå¤±è´¥!\n\n' + error.message;
            }
        }
        
        async function testUpdateAndCheck() {
            const taskId = document.getElementById('testTaskId').value;
            const newQuantity = parseInt(document.getElementById('testQuantity').value);
            const resultDiv = document.getElementById('updateTestResult');
            
            if (!taskId || !newQuantity) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ è¯·è¾“å…¥ä»»åŠ¡IDå’Œæ–°æ•°é‡';
                return;
            }
            
            try {
                resultDiv.innerHTML = 'ğŸ”„ æ‰§è¡Œæ›´æ–°å’ŒåŒæ­¥æ£€æŸ¥...\n\n';
                
                // 1. è·å–æ›´æ–°å‰çš„æ•°æ®
                resultDiv.innerHTML += '1. è·å–æ›´æ–°å‰çš„ä»»åŠ¡æ•°æ®...\n';
                const beforeResponse = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=100`);
                const beforeData = await response.json();
                const beforeTask = beforeData.content?.find(t => t.id === taskId);
                const originalQuantity = beforeTask?.quantity || 0;
                
                resultDiv.innerHTML += `   åŸå§‹æ•°é‡: ${originalQuantity}\n\n`;
                
                // 2. æ›´æ–°ä»»åŠ¡æ•°é‡
                resultDiv.innerHTML += '2. æ›´æ–°ä»»åŠ¡æ•°é‡...\n';
                const updateResponse = await fetch(`${API_BASE}/api/v1/production/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQuantity })
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`æ›´æ–°å¤±è´¥: ${updateResponse.status}`);
                }
                
                resultDiv.innerHTML += `   âœ… ä»»åŠ¡æ•°é‡æ›´æ–°æˆåŠŸ: ${originalQuantity} â†’ ${newQuantity}\n\n`;
                
                // 3. ç­‰å¾…ä¸€ä¸‹ï¼Œç„¶åæ£€æŸ¥æ•°æ®åŒæ­¥
                resultDiv.innerHTML += '3. ç­‰å¾…æ•°æ®åŒæ­¥...\n';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 4. é‡æ–°è·å–æ•°æ®éªŒè¯
                resultDiv.innerHTML += '4. éªŒè¯æ•°æ®åŒæ­¥...\n';
                const afterTaskResponse = await fetch(`${API_BASE}/api/v1/production/tasks?page=0&size=100`);
                const afterTaskData = await afterTaskResponse.json();
                const afterTask = afterTaskData.content?.find(t => t.id === taskId);
                
                const afterParamResponse = await fetch(`${API_BASE}/api/v1/process/injection-params/all?page=0&size=100`);
                const afterParamData = await afterParamResponse.json();
                const relatedParams = afterParamData.content?.filter(p => p.taskId === taskId) || [];
                
                resultDiv.innerHTML += `   ä»»åŠ¡å½“å‰æ•°é‡: ${afterTask?.quantity || 'æœªæ‰¾åˆ°'}\n`;
                resultDiv.innerHTML += `   å…³è”å‚æ•°æ•°é‡: ${relatedParams.length}\n`;
                
                if (relatedParams.length > 0) {
                    relatedParams.forEach((param, index) => {
                        const isSync = param.quantity === afterTask?.quantity;
                        resultDiv.innerHTML += `   å‚æ•°${index + 1} (ID: ${param.id}): ${param.quantity} ${isSync ? 'âœ…' : 'âŒ'}\n`;
                    });
                }
                
                resultDiv.innerHTML += '\nğŸ¯ åŒæ­¥æ£€æŸ¥å®Œæˆ!\n';
                resultDiv.innerHTML += `ä»»åŠ¡æ•°é‡: ${afterTask?.quantity}\n`;
                resultDiv.innerHTML += `å‚æ•°åŒæ­¥çŠ¶æ€: ${relatedParams.every(p => p.quantity === afterTask?.quantity) ? 'âœ… å·²åŒæ­¥' : 'âŒ æœªåŒæ­¥'}\n`;
                
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += '\nâŒ æµ‹è¯•å¤±è´¥: ' + error.message;
            }
        }
    </script>
</body>
</html>