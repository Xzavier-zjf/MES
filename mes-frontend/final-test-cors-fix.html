<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORSä¿®å¤æœ€ç»ˆéªŒè¯</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .success-info {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; }
        .btn-success:hover { background: #73d13d; }
        .btn-danger { background: #ff4d4f; }
        .btn-danger:hover { background: #ff7875; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .warning {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #faad14;
        }
        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .test-card.passed {
            border-color: #52c41a;
            background: #f6ffed;
        }
        .test-card.failed {
            border-color: #ff4d4f;
            background: #fff2f0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ CORSä¿®å¤æœ€ç»ˆéªŒè¯</h1>
        
        <div class="success-info">
            <h3>âœ… CORSä¿®å¤æªæ–½å·²å®æ–½</h3>
            <ul>
                <li>âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„CORSé…ç½®</li>
                <li>âœ… ç»Ÿä¸€åœ¨ç½‘å…³å±‚é…ç½®CORS</li>
                <li>âœ… æ”¯æŒ5173å’Œ5174ç«¯å£</li>
                <li>âœ… é…ç½®äº†æ­£ç¡®çš„HTTPæ–¹æ³•å’Œå¤´éƒ¨</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶</h3>
            <button class="btn btn-success" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        </div>

        <div class="test-grid" id="test-results">
            <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <div class="test-section">
            <h3>ğŸ“Š è¯¦ç»†æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-logs"></div>
        </div>

        <div id="status"></div>
    </div>

    <script>
        let testLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLogs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogDisplay();
            console.log(`[${type}]`, message);
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('test-logs');
            logDiv.innerHTML = `<pre>${testLogs.join('\n')}</pre>`;
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function addTestResult(testName, passed, message, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const testCard = document.createElement('div');
            testCard.className = `test-card ${passed ? 'passed' : 'failed'}`;
            testCard.innerHTML = `
                <h4>${passed ? 'âœ…' : 'âŒ'} ${testName}</h4>
                <p>${message}</p>
                ${details ? `<div style="font-size: 12px; color: #666; margin-top: 10px;">${details}</div>` : ''}
            `;
            resultsDiv.appendChild(testCard);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-logs').innerHTML = '';
            testLogs = [];
        }

        // æµ‹è¯•1: ç½‘å…³è¿é€šæ€§
        async function testGatewayConnectivity() {
            log('å¼€å§‹æµ‹è¯•ç½‘å…³è¿é€šæ€§...');
            try {
                const response = await fetch('/api/auth/current-user', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.status === 401 || response.status === 200) {
                    log('ç½‘å…³è¿é€šæ€§æµ‹è¯•é€šè¿‡');
                    addTestResult('ç½‘å…³è¿é€šæ€§', true, 'ç½‘å…³æœåŠ¡æ­£å¸¸å“åº”', `çŠ¶æ€ç : ${response.status}`);
                    return true;
                } else {
                    log(`ç½‘å…³è¿é€šæ€§æµ‹è¯•å¤±è´¥: HTTP ${response.status}`, 'error');
                    addTestResult('ç½‘å…³è¿é€šæ€§', false, 'ç½‘å…³å“åº”å¼‚å¸¸', `çŠ¶æ€ç : ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`ç½‘å…³è¿é€šæ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addTestResult('ç½‘å…³è¿é€šæ€§', false, 'ç½‘å…³è¿æ¥å¤±è´¥', error.message);
                return false;
            }
        }

        // æµ‹è¯•2: CORSé…ç½®
        async function testCorsConfiguration() {
            log('å¼€å§‹æµ‹è¯•CORSé…ç½®...');
            try {
                const response = await fetch('/api/v1/process/print-patterns/all?page=0&size=1', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                // æ£€æŸ¥å“åº”å¤´
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                log(`CORSå¤´ä¿¡æ¯: ${corsHeader}`);
                
                if (response.ok || response.status === 401) {
                    log('CORSé…ç½®æµ‹è¯•é€šè¿‡');
                    addTestResult('CORSé…ç½®', true, 'CORSé…ç½®æ­£ç¡®ï¼Œæ— é‡å¤å¤´éƒ¨', `å…è®¸æº: ${corsHeader || 'æœªè®¾ç½®'}`);
                    return true;
                } else {
                    log(`CORSé…ç½®æµ‹è¯•å¤±è´¥: HTTP ${response.status}`, 'error');
                    addTestResult('CORSé…ç½®', false, 'CORSé…ç½®å¯èƒ½æœ‰é—®é¢˜', `çŠ¶æ€ç : ${response.status}`);
                    return false;
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    log(`CORSé…ç½®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    addTestResult('CORSé…ç½®', false, 'CORSé”™è¯¯ä»ç„¶å­˜åœ¨', error.message);
                    return false;
                } else {
                    log(`CORSé…ç½®æµ‹è¯•é€šè¿‡ï¼Œå…¶ä»–ç½‘ç»œé”™è¯¯: ${error.message}`, 'warning');
                    addTestResult('CORSé…ç½®', true, 'CORSé…ç½®æ­£ç¡®ï¼Œä½†æœ‰å…¶ä»–ç½‘ç»œé—®é¢˜', error.message);
                    return true;
                }
            }
        }

        // æµ‹è¯•3: å›¾æ¡ˆAPI
        async function testPatternApi() {
            log('å¼€å§‹æµ‹è¯•å›¾æ¡ˆAPI...');
            try {
                const response = await fetch('/api/v1/process/print-patterns/all?page=0&size=5', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`å›¾æ¡ˆAPIæµ‹è¯•é€šè¿‡ï¼Œè·å–åˆ° ${data.content?.length || 0} ä¸ªå›¾æ¡ˆ`);
                    addTestResult('å›¾æ¡ˆAPI', true, 'å›¾æ¡ˆåˆ—è¡¨APIæ­£å¸¸å·¥ä½œ', `è·å–åˆ° ${data.content?.length || 0} ä¸ªå›¾æ¡ˆ`);
                    return true;
                } else {
                    log(`å›¾æ¡ˆAPIæµ‹è¯•å¤±è´¥: HTTP ${response.status}`, 'error');
                    addTestResult('å›¾æ¡ˆAPI', false, 'å›¾æ¡ˆAPIå“åº”å¼‚å¸¸', `çŠ¶æ€ç : ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`å›¾æ¡ˆAPIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addTestResult('å›¾æ¡ˆAPI', false, 'å›¾æ¡ˆAPIè¯·æ±‚å¤±è´¥', error.message);
                return false;
            }
        }

        // æµ‹è¯•4: å›¾æ¡ˆåˆ›å»º
        async function testPatternCreation() {
            log('å¼€å§‹æµ‹è¯•å›¾æ¡ˆåˆ›å»º...');
            try {
                const testPattern = {
                    patternCode: `TEST-${Date.now()}`,
                    patternName: 'æµ‹è¯•å›¾æ¡ˆ',
                    machineModel: 'A',
                    imageUrl: '/uploads/patterns/test-pattern.jpg',
                    defaultPrintSpeed: 1000,
                    defaultPressure: 2.5,
                    planId: 'TEST-PLAN',
                    taskId: 'TEST-TASK',
                    deviceId: 'TEST-DEVICE'
                };
                
                const response = await fetch('/api/v1/process/print-patterns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(testPattern)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('å›¾æ¡ˆåˆ›å»ºæµ‹è¯•é€šè¿‡');
                    addTestResult('å›¾æ¡ˆåˆ›å»º', true, 'å›¾æ¡ˆåˆ›å»ºåŠŸèƒ½æ­£å¸¸', `åˆ›å»ºå›¾æ¡ˆ: ${testPattern.patternCode}`);
                    return true;
                } else {
                    const errorText = await response.text();
                    log(`å›¾æ¡ˆåˆ›å»ºæµ‹è¯•å¤±è´¥: HTTP ${response.status} - ${errorText}`, 'error');
                    addTestResult('å›¾æ¡ˆåˆ›å»º', false, 'å›¾æ¡ˆåˆ›å»ºå¤±è´¥', `çŠ¶æ€ç : ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`å›¾æ¡ˆåˆ›å»ºæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addTestResult('å›¾æ¡ˆåˆ›å»º', false, 'å›¾æ¡ˆåˆ›å»ºè¯·æ±‚å¤±è´¥', error.message);
                return false;
            }
        }

        // æµ‹è¯•5: å›¾ç‰‡æ˜¾ç¤º
        async function testImageDisplay() {
            log('å¼€å§‹æµ‹è¯•å›¾ç‰‡æ˜¾ç¤º...');
            try {
                const testImageUrl = '/uploads/patterns/4106e9db-40d5-4922-96d8-3240a6c99e3f_R-C (1).jpg';
                const fullUrl = `http://localhost:8080${testImageUrl}`;
                
                const response = await fetch(fullUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    log('å›¾ç‰‡æ˜¾ç¤ºæµ‹è¯•é€šè¿‡');
                    addTestResult('å›¾ç‰‡æ˜¾ç¤º', true, 'å›¾ç‰‡èµ„æºå¯ä»¥æ­£å¸¸è®¿é—®', `æµ‹è¯•å›¾ç‰‡: ${testImageUrl}`);
                    return true;
                } else {
                    log(`å›¾ç‰‡æ˜¾ç¤ºæµ‹è¯•å¤±è´¥: HTTP ${response.status}`, 'warning');
                    addTestResult('å›¾ç‰‡æ˜¾ç¤º', false, 'å›¾ç‰‡èµ„æºè®¿é—®å¤±è´¥', `çŠ¶æ€ç : ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`å›¾ç‰‡æ˜¾ç¤ºæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addTestResult('å›¾ç‰‡æ˜¾ç¤º', false, 'å›¾ç‰‡èµ„æºè¯·æ±‚å¤±è´¥', error.message);
                return false;
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            clearResults();
            showStatus('ğŸ§ª å¼€å§‹è¿è¡ŒCORSä¿®å¤éªŒè¯æµ‹è¯•...', 'warning');
            log('å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...');
            
            const tests = [
                { name: 'ç½‘å…³è¿é€šæ€§', func: testGatewayConnectivity },
                { name: 'CORSé…ç½®', func: testCorsConfiguration },
                { name: 'å›¾æ¡ˆAPI', func: testPatternApi },
                { name: 'å›¾æ¡ˆåˆ›å»º', func: testPatternCreation },
                { name: 'å›¾ç‰‡æ˜¾ç¤º', func: testImageDisplay }
            ];
            
            let passedTests = 0;
            let totalTests = tests.length;
            
            for (const test of tests) {
                log(`æ‰§è¡Œæµ‹è¯•: ${test.name}`);
                const result = await test.func();
                if (result) passedTests++;
                
                // æµ‹è¯•é—´éš”
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log(`æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡`);
            
            if (passedTests === totalTests) {
                showStatus(`ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼CORSé—®é¢˜å·²å®Œå…¨ä¿®å¤ (${passedTests}/${totalTests})`, 'success');
            } else if (passedTests > totalTests / 2) {
                showStatus(`âš ï¸ å¤§éƒ¨åˆ†æµ‹è¯•é€šè¿‡ï¼Œè¿˜æœ‰ä¸€äº›å°é—®é¢˜éœ€è¦è§£å†³ (${passedTests}/${totalTests})`, 'warning');
            } else {
                showStatus(`âŒ å¤šä¸ªæµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥æœåŠ¡é…ç½® (${passedTests}/${totalTests})`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            showStatus('ğŸ”§ CORSä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½', 'success');
            log('CORSä¿®å¤éªŒè¯å·¥å…·åˆå§‹åŒ–å®Œæˆ');
            
            // 3ç§’åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
            setTimeout(() => {
                runAllTests();
            }, 3000);
        };
    </script>
</body>
</html>