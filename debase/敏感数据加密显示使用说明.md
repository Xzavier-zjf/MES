# MES系统敏感数据加密显示方案

## 概述

本方案通过数据库视图和函数实现敏感数据的加密显示，确保在使用Navicat等数据库管理工具时，敏感字段（如密码）以加密形式呈现，而非敏感字段保持明文显示。

## 核心特性

- **字段级加密**：只对指定的敏感字段进行加密显示
- **多种加密方式**：支持掩码、哈希、AES加密三种显示方式
- **灵活配置**：通过配置表动态管理需要加密的字段
- **透明操作**：不影响应用程序的正常数据操作
- **权限控制**：可配置专门的查看用户，限制敏感数据访问

## 安装步骤

### 1. 执行基础加密方案
```sql
-- 在MES数据库中执行
source MES_sensitive_data_encryption.sql;
```

### 2. 执行管理工具脚本
```sql
-- 执行管理工具
source MES_encryption_management.sql;
```

## 使用方法

### 1. 配置敏感字段

#### 添加敏感字段配置
```sql
-- 语法：CALL sp_add_sensitive_field(表名, 字段名, 加密类型, 掩码模式);

-- 示例：配置用户密码字段
CALL sp_add_sensitive_field('user', 'password', 'MASK', '******');

-- 示例：配置设备维护时间字段
CALL sp_add_sensitive_field('device', 'last_maintenance_time', 'MASK', '****-**-** **:**:**');
```

#### 查看敏感字段配置
```sql
-- 查看所有配置
CALL sp_list_sensitive_fields(NULL);

-- 查看特定表的配置
CALL sp_list_sensitive_fields('user');
```

#### 移除敏感字段配置
```sql
CALL sp_remove_sensitive_field('user', 'password');
```

### 2. 创建和使用加密视图

#### 创建单个表的加密视图
```sql
CALL sp_create_encrypted_view('user');
```

#### 创建所有表的加密视图
```sql
CALL sp_create_all_encrypted_views();
```

#### 使用加密视图查询
```sql
-- 查询加密显示的用户数据
SELECT * FROM v_user_encrypted;

-- 查询加密显示的设备数据
SELECT * FROM v_device_encrypted;
```

### 3. 动态加密查询

使用存储过程进行动态加密查询：
```sql
CALL sp_query_with_encryption('user');
```

## 加密类型说明

### 1. MASK（掩码）
- 将敏感数据替换为指定的掩码字符
- 适用于密码、身份证号等完全敏感的数据
- 示例：`123456` → `******`

### 2. HASH（哈希）
- 使用MD5哈希显示数据指纹
- 适用于需要验证数据完整性但不显示原值的场景
- 示例：`123456` → `e10adc3949ba59abbe56e057f20f883e`

### 3. AES（AES加密）
- 使用AES算法加密显示
- 适用于需要可逆加密的场景
- 示例：`123456` → `A1B2C3D4E5F6...`

## Navicat使用指南

### 1. 日常查询操作

在Navicat中，优先使用加密视图进行敏感数据查询：

```sql
-- 替代直接查询user表
SELECT * FROM v_user_encrypted;

-- 替代直接查询device表  
SELECT * FROM v_device_encrypted;
```

### 2. 管理敏感字段

通过Navicat的查询编辑器执行管理命令：

```sql
-- 添加新的敏感字段
CALL sp_add_sensitive_field('employee', 'id_card', 'MASK', '****');

-- 查看当前配置
CALL sp_list_sensitive_fields(NULL);

-- 重新创建视图
CALL sp_create_encrypted_view('employee');
```

### 3. 检查系统状态

```sql
-- 检查加密配置状态
CALL sp_check_encryption_status();
```

## 权限控制（可选）

### 创建专用查看用户

```sql
-- 创建只能查看加密数据的用户
CREATE USER 'mes_viewer'@'%' IDENTIFIED BY 'ViewerPass2025!';

-- 授予加密视图查询权限
GRANT SELECT ON MES.v_user_encrypted TO 'mes_viewer'@'%';
GRANT SELECT ON MES.v_device_encrypted TO 'mes_viewer'@'%';

-- 授予其他非敏感表的查询权限
GRANT SELECT ON MES.production_plan TO 'mes_viewer'@'%';
GRANT SELECT ON MES.production_task TO 'mes_viewer'@'%';
GRANT SELECT ON MES.injection_param TO 'mes_viewer'@'%';
GRANT SELECT ON MES.print_pattern TO 'mes_viewer'@'%';

-- 授予存储过程执行权限
GRANT EXECUTE ON PROCEDURE MES.sp_query_with_encryption TO 'mes_viewer'@'%';

FLUSH PRIVILEGES;
```

### 使用专用用户连接

在Navicat中创建新的连接，使用`mes_viewer`用户，该用户只能查看加密后的敏感数据。

## 常见问题

### Q1: 加密显示会影响应用程序吗？
A: 不会。加密显示只影响通过视图查询的结果，应用程序仍然可以直接访问原始表获取明文数据。

### Q2: 如何添加新的敏感字段？
A: 使用`sp_add_sensitive_field`存储过程添加配置，然后调用`sp_create_encrypted_view`重新创建视图。

### Q3: 可以修改加密方式吗？
A: 可以。重新调用`sp_add_sensitive_field`使用新的加密类型，然后重新创建视图。

### Q4: 如何确保数据真正安全？
A: 本方案只是显示层加密。如需真正的数据安全，建议：
- 在应用层实现数据加密存储
- 使用数据库的透明数据加密（TDE）
- 实施严格的数据库访问权限控制

## 维护建议

1. **定期检查配置**：使用`sp_check_encryption_status()`检查加密配置状态
2. **更新加密密钥**：定期更换AES加密使用的密钥
3. **权限审计**：定期审查数据库用户权限，确保敏感数据访问受控
4. **备份配置**：备份`sensitive_field_config`表的配置数据

## 扩展功能

如需更高级的功能，可以考虑：

1. **动态密钥管理**：实现密钥轮换机制
2. **审计日志**：记录敏感数据访问日志
3. **细粒度权限**：基于用户角色的字段级权限控制
4. **数据脱敏**：为测试环境提供脱敏数据